<!DOCTYPE html>
<!--
MODIFICATION NOTE: This file has been modified to include description fields 
in all classification_projects table write operations.

CRITICAL SECURITY FIX APPLIED:
- Fixed saveAllCSIChanges() function to preserve existing project attributes
- Previously: attributes_param: [] caused ALL project attributes to be DELETED
- Now: Loads existing attributes from database before updating CSI paths
- This prevents catastrophic data loss when admin changes CSI paths

LATEST UPDATE: Added description parameters to all RPC function calls
- Updated all admin_update_project and update_project RPC calls
- Added description parameters: division_description_param, section_description_param, 
  detailed_section_description_param, item_description_param

Modified Functions:
1. saveProjectAsDraft() - Now extracts and stores division_description, section_description, 
   detailed_section_description, and item_description from dropdown values
2. saveEditedProject() - Now passes description fields to RPC functions
3. handleEditModalConfirmSubmit() - Now passes description fields to RPC functions
4. saveAllCSIChanges() - CRITICAL FIX: Now preserves existing attributes during CSI path updates
   + Added description parameter support

Changes Made:
- Added description field extraction from "code - description" dropdown format
- Updated insertData and updateData objects to include description fields
- Updated admin_update_project RPC calls to include description parameters
- Updated update_project RPC calls to include description parameters
- FIXED CSI path management to load and preserve existing project attributes
- ADDED description parameter support to saveAllCSIChanges function

Impact: The classification_projects table will now have complete description data
instead of just codes, improving data richness and user experience.
CRITICAL: Prevents attribute deletion during CSI path management operations.

REQUIRED: These changes require corresponding RPC function updates in the database
to accept the new description parameters before this HTML file will work properly.

FOREIGN KEY INTEGRATION ADDED:
- Added getOrCreateAdditionalLevelValueId() helper function for FK management
- Updated saveProjectAsDraft() to populate additional_level_value_id FK field
- Maintains backward compatibility with existing text fields
- New projects will have both text and FK relationships populated
- Existing functionality preserved - no breaking changes

Modified RPC calls in functions:
- saveEditedProject() -> admin_update_project & update_project
- handleEditModalConfirmSubmit() -> admin_update_project & update_project  
- saveAllCSIChanges() -> admin_update_project
-->
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CSI Attribute Portal</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- SheetJS CDN for Excel file handling -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
    <!-- Supabase CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- EmailJS CDN for email notifications -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }

        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #e0e0e0;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: #9ca3af;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #6b7280;
        }

        .max-h-96-overflow {
            max-height: 24rem;
            overflow-y: auto;
        }

        .disabled-section {
            opacity: 0.5;
            pointer-events: none;
            user-select: none;
        }

        .review-section {
            border-top: 1px dashed #e5e7eb;
            margin-top: 1rem;
            padding-top: 1rem;
        }

        .edit-mode {
            background-color: #fef3c7;
            border: 2px solid #f59e0b;
        }

       .modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
}

        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 0.5rem;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            width: 90%;
        }
    </style>
</head>

<body class="bg-gray-100 p-8">

    <!-- Login Modal -->
    <div id="login-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <h3 class="text-lg font-medium text-gray-900 text-center mb-4">Login to CSI Portal</h3>
                <form id="login-form" class="space-y-4">
                    <div>
                        <label for="email" class="block text-sm font-medium text-gray-700">Email</label>
                        <input type="email" id="email" name="email" required
                            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="password" class="block text-sm font-medium text-gray-700">Password</label>
                        <input type="password" id="password" name="password" required
                            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div id="login-error" class="text-red-600 text-sm hidden"></div>
                    <div class="flex justify-end space-x-3">
                        <button type="submit"
                            class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md text-sm font-medium">
                            Login
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Main Container -->
    <div class="container mx-auto p-6 bg-white rounded-lg shadow-xl">
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-4xl font-bold text-gray-800">CSI Attribute Creation Portal</h1>
            <div class="flex items-center space-x-4">
                <span id="user-info" class="text-sm text-gray-600"></span>
                <button id="logout-btn"
                    class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-md text-sm font-medium">
                    Logout
                </button>
                <button id="debug-btn"
                    class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-md text-sm font-medium hidden">
                    Debug
                </button>
            </div>
        </div>

        <!-- Navigation Tabs -->
        <div class="mb-6">
            <nav class="flex space-x-8" aria-label="Tabs">
                <button id="tab-create"
                    class="tab-button active whitespace-nowrap py-2 px-1 border-b-2 border-blue-500 font-medium text-sm text-blue-600">
                    Create Attributes
                </button>
                <button id="tab-projects"
                    class="tab-button whitespace-nowrap py-2 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300">
                    My Projects
                </button>
                <button id="tab-dashboard" class="tab-button whitespace-nowrap py-2 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" style="display: none;">
    Admin Dashboard
</button>
<button id="tab-admin"
                    class="tab-button whitespace-nowrap py-2 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300"
                    style="display: none;">
                    User Management
                </button>
                <button id="tab-csi-management"
                    class="tab-button whitespace-nowrap py-2 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300"
                    style="display: none;">
                    CSI Path Management
                </button>
            </nav>
        </div>

        <!-- Create Attributes Tab -->
        <div id="content-create" class="tab-content">
            <!-- Draft Loading Section -->
            <div id="draft-info" class="mb-4 p-4 bg-yellow-50 rounded-lg shadow-md" style="display: none;">
                <div class="flex justify-between items-center">
                    <div>
                        <h3 class="text-lg font-semibold text-yellow-800">Editing Draft Project</h3>
                        <p id="draft-name" class="text-sm text-yellow-600"></p>
                    </div>
                    <button id="close-draft-btn"
                        class="px-3 py-1 bg-yellow-600 text-white rounded-md hover:bg-yellow-700 text-sm">
                        Close Draft
                    </button>
                </div>
            </div>

            <!-- Top Section: CSI Hierarchy and Additional Levels -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
                <!-- CSI Hierarchy Input -->
                <div class="bg-gray-50 p-6 rounded-lg shadow-md">
                    <h2 class="text-2xl font-semibold mb-4 text-gray-700">CSI Hierarchy Input</h2>
                    <div class="space-y-4">
                        <div>
                            <label for="division-select" class="block text-sm font-medium text-gray-700">CSI
                                Division</label>
                            <select id="division-select"
                                class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md shadow-sm">
                                <option value="">Select Division</option>
                            </select>
                        </div>
                        <div>
                            <label for="section-select" class="block text-sm font-medium text-gray-700">CSI
                                Section</label>
                            <select id="section-select"
                                class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md shadow-sm"
                                disabled>
                                <option value="">Select Section</option>
                            </select>
                        </div>
                        <div>
                            <label for="subsection-select" class="block text-sm font-medium text-gray-700">CSI Detailed
                                Section</label>
                            <select id="subsection-select"
                                class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md shadow-sm"
                                disabled>
                                <option value="">Select Detailed Section</option>
                            </select>
                        </div>
                        <div>
                            <label for="item-select" class="block text-sm font-medium text-gray-700">CSI Item</label>
                            <select id="item-select"
                                class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md shadow-sm"
                                disabled>
                                <option value="">Select Item</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Additional Levels Management -->
                <div id="additional-levels-section" class="bg-gray-50 p-6 rounded-lg shadow-md disabled-section">
                    <h2 class="text-2xl font-semibold mb-4 text-gray-700">Additional Level</h2>
                    <div class="space-y-4">
                        <div>
                            <label for="additional-level-name" class="block text-sm font-medium text-gray-700">Level
                                Name</label>
                            <input type="text" id="additional-level-name" readonly
                                class="mt-1 block w-full pl-3 pr-3 py-2 text-base border-gray-300 bg-gray-100 rounded-md shadow-sm"
                                placeholder="Auto-generated from CSI Item">
                        </div>
                        <div>
                            <label for="additional-level-value-input"
                                class="block text-sm font-medium text-gray-700">Add New Value</label>
                            <div class="flex space-x-2">
                                <input type="text" id="additional-level-value-input"
                                    class="flex-1 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                                    placeholder="Enter new value">
                                <button id="add-level-value-btn"
                                    class="px-3 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 text-sm">
                                    Add
                                </button>
                            </div>
                        </div>
                        <div>
                            <label for="additional-level-select" class="block text-sm font-medium text-gray-700">Select
                                Value</label>
                            <select id="additional-level-select"
                                class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md shadow-sm">
                                <option value="">Select value</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Current Path Display -->
            <div id="current-path-section" class="mb-8 p-4 bg-blue-50 rounded-lg shadow-md">
                <h3 class="text-lg font-semibold mb-2 text-blue-800">Current Selection Path</h3>
                <div id="current-path-display" class="text-blue-700">
                    No path selected
                </div>
            </div>

            <!-- Attribute Creation Section -->
            <div id="attribute-creation-section" class="bg-gray-50 p-6 rounded-lg shadow-md disabled-section mb-8">
                <h2 class="text-2xl font-semibold mb-4 text-gray-700">Attribute Creation</h2>
                <div class="space-y-4">
                    <div>
                        <label for="attribute-name-input" class="block text-sm font-medium text-gray-700">Attribute
                            Name</label>
                        <input type="text" id="attribute-name-input"
                            class="mt-1 block w-full pl-3 pr-3 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md shadow-sm"
                            placeholder="Enter attribute name">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Standard Values</label>
                        
                        <div id="attribute-standard-values-container" class="space-y-2">
    <div class="flex space-x-2 items-center standard-value-row">
        <input type="text"
            class="attribute-value-name-input flex-1 px-3 py-2 text-base border-gray-300 rounded-md shadow-sm"
            placeholder="Value Name">
        <select
            class="attribute-value-unit-select w-32 px-3 py-2 text-base border-gray-300 rounded-md shadow-sm">
            <option value="">UOM</option>
        </select>
        <button
            class="remove-value-btn px-2 py-1 bg-red-500 text-white rounded-md hover:bg-red-600 text-sm hidden"
            onclick="removeStandardValue(this)">Remove</button>
    </div>
</div>
                        
                        <button id="add-attribute-value-btn"
                            class="mt-2 px-3 py-1 bg-blue-600 text-white rounded-md hover:bg-blue-700 text-sm">
                            Add Value
                        </button>
                    </div>
                    <div class="space-y-3">
    <div class="flex items-center">
        <input type="checkbox" id="mandatory-checkbox"
            class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
        <label for="mandatory-checkbox" class="ml-2 block text-sm text-gray-900">Mandatory Attribute</label>
    </div>
    <div class="flex items-center">
        <input type="checkbox" id="manual-entry-checkbox"
            class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
        <label for="manual-entry-checkbox" class="ml-2 block text-sm text-gray-900">Manual Entry Attribute</label>
        <div class="ml-2">
            <span class="text-xs text-gray-500">(Users will input values freely instead of selecting from predefined options)</span>
        </div>
    </div>
</div>
                    <button id="add-attribute-btn"
                        class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                        Add Attribute
                    </button>
                </div>
            </div>

            <!-- Collected Data Display -->
            <div id="collected-data-section" class="bg-gray-50 p-6 rounded-lg shadow-md mb-8" style="display: none;">
                <h2 class="text-2xl font-semibold mb-4 text-gray-700">Collected Attributes</h2>
                <div id="collected-data-display" class="max-h-96-overflow">
                    <!-- Collected data will be displayed here -->
                </div>
            </div>

            <!-- Action Buttons -->
            <div id="action-buttons-section" class="flex flex-wrap gap-4 justify-center" style="display: none;">
                <button id="save-draft-btn"
                    class="px-6 py-3 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                    Save as Draft
                </button>
                <button id="submit-for-review-btn"
                    class="px-6 py-3 bg-green-600 text-white rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                    Submit for Review
                </button>
                <button id="clear-all-btn"
                    class="px-6 py-3 bg-red-600 text-white rounded-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                    Clear All
                </button>
                <button id="export-excel-btn"
                    class="px-6 py-3 bg-purple-600 text-white rounded-md hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500">
                    Export to Excel
                </button>
            </div>

            <!-- Reviewer Selection (for submit) -->
            <div id="reviewer-selection" class="review-section bg-yellow-50 p-4 rounded-lg" style="display: none;">
                <h4 class="text-md font-medium text-gray-900 mb-3">Select Reviewer</h4>
                <select id="reviewer-select"
                    class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 mb-4">
                    <option value="">Select a reviewer</option>
                </select>
                <div class="flex space-x-4">
                    <button id="confirm-submit-btn"
                        class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">
                        Confirm Submission
                    </button>
                    <button id="cancel-submit-btn"
                        class="px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
<!-- Excel Import Section -->
<div class="mb-8 p-6 bg-blue-50 rounded-lg shadow-md">
    <h2 class="text-2xl font-semibold mb-4 text-gray-700">Import from Excel</h2>
    <p class="text-sm text-gray-600 mb-4">Import a previously created project from an Excel file. The imported project will be loaded as a draft.</p>
    <div class="flex items-center space-x-4">
        <input type="file" id="excel-import-input" accept=".xlsx,.xls" class="block w-full text-sm text-gray-900 border border-gray-300 rounded-lg cursor-pointer bg-white focus:outline-none">
        <button id="import-excel-btn" class="px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 whitespace-nowrap">
            Import Excel
        </button>
    </div>
    <p class="text-xs text-gray-500 mt-2">Expected columns: Division Code, Division Description, Section Code, Section Description, Detailed Section Code, Detailed Section Description, Item Code, Item Description (column names are flexible)</p>
</div>
        <!-- My Projects Tab -->
        <div id="content-projects" class="tab-content" style="display: none;">
            <div class="bg-white shadow rounded-lg">
                <div class="px-4 py-5 sm:p-6">
                    <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">My Projects</h3>
                    <div class="mb-4">
                        <button id="refresh-projects-btn"
                            class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 text-sm">
                            Refresh Projects
                        </button>
                    </div>
                    <div id="projects-list">
                        <div class="text-center text-gray-500 py-8">Loading projects...</div>
                    </div>
                </div>
            </div>
        </div>
<!-- Admin Dashboard Tab -->
        <div id="content-dashboard" class="tab-content" style="display: none;">
            <div class="space-y-6">
                <!-- CSI Path Overview -->
                <div class="bg-white shadow rounded-lg">
                    <div class="px-4 py-5 sm:p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-lg leading-6 font-medium text-gray-900">CSI Path Analytics</h3>
                            <button id="refresh-dashboard-btn" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 text-sm">
                                Refresh Data
                            </button>
                        </div>
                        
                        <!-- CSI Path Statistics Grid -->
                        <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-6 gap-4 mb-6">
                            <div class="bg-blue-50 p-4 rounded-lg">
                                <div class="text-sm font-medium text-blue-600">Total CSI Paths</div>
                                <div id="total-csi-paths" class="text-2xl font-bold text-blue-900">-</div>
                                <div class="text-xs text-blue-600 mt-1">Including additional levels</div>
                            </div>
                            <div class="bg-green-50 p-4 rounded-lg">
                                <div class="text-sm font-medium text-green-600">Approved Projects</div>
                                <div id="approved-paths" class="text-2xl font-bold text-green-900">-</div>
                                <div class="text-xs text-green-600 mt-1">Admin approved</div>
                            </div>
                            <div class="bg-yellow-50 p-4 rounded-lg">
                                <div class="text-sm font-medium text-yellow-600">Pending Approval</div>
                                <div id="pending-paths" class="text-2xl font-bold text-yellow-900">-</div>
                                <div class="text-xs text-yellow-600 mt-1">Awaiting review</div>
                            </div>
                            <div class="bg-purple-50 p-4 rounded-lg">
                                <div class="text-sm font-medium text-purple-600">Draft Projects</div>
                                <div id="draft-paths" class="text-2xl font-bold text-purple-900">-</div>
                                <div class="text-xs text-purple-600 mt-1">Work in progress</div>
                            </div>
                            <div class="bg-gray-50 p-4 rounded-lg">
                                <div class="text-sm font-medium text-gray-600">No Projects</div>
                                <div id="no-project-paths" class="text-2xl font-bold text-gray-900">-</div>
                                <div class="text-xs text-gray-600 mt-1">Available paths</div>
                            </div>
                            <div class="bg-indigo-50 p-4 rounded-lg">
                                <div class="text-sm font-medium text-indigo-600">Coverage</div>
                                <div id="coverage-percentage" class="text-2xl font-bold text-indigo-900">-%</div>
                                <div class="text-xs text-indigo-600 mt-1">Paths with projects</div>
                            </div>
                        </div>

                        <!-- Additional Level Statistics -->
                        <div class="bg-gray-50 p-4 rounded-lg mb-6">
                            <h4 class="text-md font-medium text-gray-900 mb-3">Additional Level Information</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <div class="text-sm text-gray-600">Paths with Additional Levels</div>
                                    <div id="additional-level-paths" class="text-xl font-semibold text-gray-900">-</div>
                                </div>
                                <div>
                                    <div class="text-sm text-gray-600">Base CSI Paths Only</div>
                                    <div id="base-paths-only" class="text-xl font-semibold text-gray-900">-</div>
                                </div>
                            </div>
                        </div>

                        <!-- Visual Progress Bars -->
                        <div class="space-y-4">
                            <div>
                                <div class="flex justify-between text-sm text-gray-600 mb-1">
                                    <span>Project Coverage</span>
                                    <span id="coverage-text">0% covered</span>
                                </div>
                                <div class="w-full bg-gray-200 rounded-full h-3">
                                    <div id="coverage-bar" class="bg-green-600 h-3 rounded-full transition-all duration-500" style="width: 0%"></div>
                                </div>
                            </div>
                            
                            <div>
                                <div class="flex justify-between text-sm text-gray-600 mb-1">
                                    <span>Project Status Distribution</span>
                                </div>
                                <div class="w-full bg-gray-200 rounded-full h-3 flex overflow-hidden">
                                    <div id="approved-bar" class="bg-green-500 transition-all duration-500" style="width: 0%"></div>
                                    <div id="pending-bar" class="bg-yellow-500 transition-all duration-500" style="width: 0%"></div>
                                    <div id="draft-bar" class="bg-purple-500 transition-all duration-500" style="width: 0%"></div>
                                    <div id="no-project-bar" class="bg-gray-400 transition-all duration-500" style="width: 0%"></div>
                                </div>
                                <div class="flex justify-between text-xs text-gray-500 mt-1">
                                    <span>√É∆í√Ü‚Äô√É‚Ä†√¢‚Ç¨‚Ñ¢√É∆í√¢‚Ç¨¬†√É¬¢√¢‚Äö¬¨√¢‚Äû¬¢√É∆í√Ü‚Äô√É¬¢√¢‚Äö¬¨√Ö¬°√É∆í√¢‚Ç¨≈°√É‚Äö√Ç¬¢√É∆í√Ü‚Äô√É‚Ä†√¢‚Ç¨‚Ñ¢√É∆í√¢‚Ç¨≈°√É‚Äö√Ç¬¢√É∆í√Ü‚Äô√É‚Äö√Ç¬¢√É∆í√Ç¬¢√É¬¢√¢‚Ç¨≈°√Ç¬¨√É‚Ä¶√Ç¬°√É∆í√¢‚Ç¨≈°√É‚Äö√Ç¬¨√É∆í√Ü‚Äô√É‚Äö√Ç¬¢√É∆í√Ç¬¢√É¬¢√¢‚Äö¬¨√Ö¬°√É‚Äö√Ç¬¨√É∆í√¢‚Ç¨¬¶√É¬¢√¢‚Äö¬¨√Ö‚Äú√É∆í√Ü‚Äô√É‚Ä†√¢‚Ç¨‚Ñ¢√É∆í√Ç¬¢√É¬¢√¢‚Ç¨≈°√Ç¬¨√É‚Ä¶√Ç¬°√É∆í√Ü‚Äô√É¬¢√¢‚Äö¬¨√Ö¬°√É∆í√¢‚Ç¨≈°√É‚Äö√Ç¬† Approved</span>
                                    <span>√É∆í√Ü‚Äô√É‚Ä†√¢‚Ç¨‚Ñ¢√É∆í√¢‚Ç¨¬†√É¬¢√¢‚Äö¬¨√¢‚Äû¬¢√É∆í√Ü‚Äô√É¬¢√¢‚Äö¬¨√Ö¬°√É∆í√¢‚Ç¨≈°√É‚Äö√Ç¬¢√É∆í√Ü‚Äô√É‚Ä†√¢‚Ç¨‚Ñ¢√É∆í√¢‚Ç¨≈°√É‚Äö√Ç¬¢√É∆í√Ü‚Äô√É‚Äö√Ç¬¢√É∆í√Ç¬¢√É¬¢√¢‚Ç¨≈°√Ç¬¨√É‚Ä¶√Ç¬°√É∆í√¢‚Ç¨≈°√É‚Äö√Ç¬¨√É∆í√Ü‚Äô√É‚Äö√Ç¬¢√É∆í√Ç¬¢√É¬¢√¢‚Äö¬¨√Ö¬°√É‚Äö√Ç¬¨√É∆í√¢‚Ç¨¬¶√É¬¢√¢‚Äö¬¨√Ö‚Äú√É∆í√Ü‚Äô√É‚Ä†√¢‚Ç¨‚Ñ¢√É∆í√Ç¬¢√É¬¢√¢‚Ç¨≈°√Ç¬¨√É‚Ä¶√Ç¬°√É∆í√Ü‚Äô√É¬¢√¢‚Äö¬¨√Ö¬°√É∆í√¢‚Ç¨≈°√É‚Äö√Ç¬† Pending</span>
                                    <span>√É∆í√Ü‚Äô√É‚Ä†√¢‚Ç¨‚Ñ¢√É∆í√¢‚Ç¨¬†√É¬¢√¢‚Äö¬¨√¢‚Äû¬¢√É∆í√Ü‚Äô√É¬¢√¢‚Äö¬¨√Ö¬°√É∆í√¢‚Ç¨≈°√É‚Äö√Ç¬¢√É∆í√Ü‚Äô√É‚Ä†√¢‚Ç¨‚Ñ¢√É∆í√¢‚Ç¨≈°√É‚Äö√Ç¬¢√É∆í√Ü‚Äô√É‚Äö√Ç¬¢√É∆í√Ç¬¢√É¬¢√¢‚Ç¨≈°√Ç¬¨√É‚Ä¶√Ç¬°√É∆í√¢‚Ç¨≈°√É‚Äö√Ç¬¨√É∆í√Ü‚Äô√É‚Äö√Ç¬¢√É∆í√Ç¬¢√É¬¢√¢‚Äö¬¨√Ö¬°√É‚Äö√Ç¬¨√É∆í√¢‚Ç¨¬¶√É¬¢√¢‚Äö¬¨√Ö‚Äú√É∆í√Ü‚Äô√É‚Ä†√¢‚Ç¨‚Ñ¢√É∆í√Ç¬¢√É¬¢√¢‚Ç¨≈°√Ç¬¨√É‚Ä¶√Ç¬°√É∆í√Ü‚Äô√É¬¢√¢‚Äö¬¨√Ö¬°√É∆í√¢‚Ç¨≈°√É‚Äö√Ç¬† Draft</span>
                                    <span>√É∆í√Ü‚Äô√É‚Ä†√¢‚Ç¨‚Ñ¢√É∆í√¢‚Ç¨¬†√É¬¢√¢‚Äö¬¨√¢‚Äû¬¢√É∆í√Ü‚Äô√É¬¢√¢‚Äö¬¨√Ö¬°√É∆í√¢‚Ç¨≈°√É‚Äö√Ç¬¢√É∆í√Ü‚Äô√É‚Ä†√¢‚Ç¨‚Ñ¢√É∆í√¢‚Ç¨≈°√É‚Äö√Ç¬¢√É∆í√Ü‚Äô√É‚Äö√Ç¬¢√É∆í√Ç¬¢√É¬¢√¢‚Ç¨≈°√Ç¬¨√É‚Ä¶√Ç¬°√É∆í√¢‚Ç¨≈°√É‚Äö√Ç¬¨√É∆í√Ü‚Äô√É‚Äö√Ç¬¢√É∆í√Ç¬¢√É¬¢√¢‚Äö¬¨√Ö¬°√É‚Äö√Ç¬¨√É∆í√¢‚Ç¨¬¶√É¬¢√¢‚Äö¬¨√Ö‚Äú√É∆í√Ü‚Äô√É‚Ä†√¢‚Ç¨‚Ñ¢√É∆í√Ç¬¢√É¬¢√¢‚Ç¨≈°√Ç¬¨√É‚Ä¶√Ç¬°√É∆í√Ü‚Äô√É¬¢√¢‚Äö¬¨√Ö¬°√É∆í√¢‚Ç¨≈°√É‚Äö√Ç¬† No Projects</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- CSI Import Management -->
                <div class="bg-white shadow rounded-lg">
                    <div class="px-4 py-5 sm:p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg leading-6 font-medium text-gray-900">CSI Hierarchy Management</h3>
                            <div class="flex space-x-3">
                                <button id="export-csi-btn" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                                    Export Current CSI Data
                                </button>
                                <button id="clear-csi-btn" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">
                                    Clear All CSI Data
                                </button>
                            </div>
                        </div>
                        
                        <!-- Import Section -->
                        <div class="mb-6 p-4 bg-yellow-50 rounded-lg border border-yellow-200">
                            <h4 class="text-md font-medium text-gray-900 mb-3">Import CSI Hierarchy from Excel</h4>
                            <p class="text-sm text-gray-600 mb-4">
                                Upload an Excel file containing CSI hierarchy data. The system will handle missing levels and duplicates automatically.
                                <br><strong>Expected columns:</strong> CSI Division Code, CSI Division Description, CSI Section Code, CSI Section Description, CSI Detailed Section Code, CSI Detailed Section Description, CSI Item Code, CSI Item Description
                            </p>
                            <div class="flex items-center space-x-4">
                                <input type="file" id="csi-import-input" accept=".xlsx,.xls" class="block w-full text-sm text-gray-900 border border-gray-300 rounded-lg cursor-pointer bg-white focus:outline-none">
                                <button id="import-csi-btn" class="px-6 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 whitespace-nowrap">
                                    Import CSI Data
                                </button>
                            </div>
                            <div class="mt-3">
                                <div id="import-progress" class="hidden">
                                    <div class="bg-gray-200 rounded-full h-2">
                                        <div id="import-progress-bar" class="bg-green-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                                    </div>
                                    <p id="import-status" class="text-sm text-gray-600 mt-1">Preparing import...</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Basic CSI Statistics -->
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                            <div class="bg-blue-50 p-4 rounded-lg">
                                <div class="text-sm font-medium text-blue-600">Divisions</div>
                                <div id="csi-divisions-count" class="text-2xl font-bold text-blue-900">-</div>
                            </div>
                            <div class="bg-green-50 p-4 rounded-lg">
                                <div class="text-sm font-medium text-green-600">Sections</div>
                                <div id="csi-sections-count" class="text-2xl font-bold text-green-900">-</div>
                            </div>
                            <div class="bg-yellow-50 p-4 rounded-lg">
                                <div class="text-sm font-medium text-yellow-600">Detailed Sections</div>
                                <div id="csi-detailed-sections-count" class="text-2xl font-bold text-yellow-900">-</div>
                            </div>
                            <div class="bg-purple-50 p-4 rounded-lg">
                                <div class="text-sm font-medium text-purple-600">Items</div>
                                <div id="csi-items-count" class="text-2xl font-bold text-purple-900">-</div>
                            </div>
                        </div>
                        
                        <!-- Recent Import Log -->
                        <div>
                            <h4 class="text-md font-medium text-gray-900 mb-3">Import History</h4>
                            <div id="import-history" class="space-y-2 max-h-40 overflow-y-auto border border-gray-200 rounded-md p-3">
                                <div class="text-sm text-gray-500">No import history available</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- User Management Tab (Admin only) -->
        <div id="content-admin" class="tab-content" style="display: none;">
            <div class="bg-white shadow rounded-lg">
                <div class="px-4 py-5 sm:p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg leading-6 font-medium text-gray-900">User Management</h3>
                        <button id="create-user-btn"
                            class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                            Create New User
                        </button>
                    </div>
                    <div id="users-list">
                        <!-- Users will be loaded here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- CSI Path Management Tab (Admin only) -->
        <div id="content-csi-management" class="tab-content" style="display: none;">
            <div class="bg-white shadow rounded-lg">
                <div class="px-4 py-5 sm:p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg leading-6 font-medium text-gray-900">CSI Path Management</h3>
                        <div class="flex space-x-3">
                            <button id="csi-save-changes-btn" 
                                class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed" 
                                disabled>
                                Save All Changes
                            </button>
                            <button id="csi-discard-changes-btn" 
                                class="px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700 disabled:opacity-50 disabled:cursor-not-allowed" 
                                disabled>
                                Discard Changes
                            </button>
                        </div>
                    </div>
                    
                    <!-- Changes Summary -->
                    <div id="csi-changes-summary" class="mb-4 p-3 bg-yellow-50 border border-yellow-200 rounded-md" style="display: none;">
                        <h4 class="font-medium text-yellow-800">Pending Changes:</h4>
                        <div id="csi-changes-list" class="mt-1 text-sm text-yellow-700"></div>
                    </div>
                    
                    <!-- Loading State -->
                    <div id="csi-table-loading" class="text-center py-8">
                        <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
                        <p class="mt-2 text-gray-600">Loading projects...</p>
                    </div>
                    
                    <!-- CSI Projects Table -->
                    <div id="csi-table-container" class="overflow-x-auto" style="display: none;">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Project Name</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Division</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Section</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Detailed Section</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Item</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Additional Level</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Additional Value</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Created By</th>
                                </tr>
                            </thead>
                            <tbody id="csi-table-body" class="bg-white divide-y divide-gray-200">
                                <!-- Table content will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- No Projects Message -->
                    <div id="csi-no-projects" class="text-center py-8 text-gray-500" style="display: none;">
                        <p>No projects found.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Attribute Edit Modal -->
    <div id="edit-attribute-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <h3 class="text-lg font-medium text-gray-900 mb-4">Edit Attribute</h3>
            <div class="space-y-4">
                <div>
                    <label for="edit-attr-name" class="block text-sm font-medium text-gray-700">Attribute Name</label>
                    <input type="text" id="edit-attr-name"
                        class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Standard Values</label>
                    <div id="edit-values-container" class="space-y-2"></div>
                    <button id="add-edit-value-btn"
                        class="mt-2 px-3 py-1 bg-blue-600 text-white rounded-md hover:bg-blue-700 text-sm">
                        Add Value
                    </button>
                </div>
                <div class="space-y-3">
    <div class="flex items-center">
        <input type="checkbox" id="edit-mandatory-checkbox"
            class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
        <label for="edit-mandatory-checkbox" class="ml-2 block text-sm text-gray-900">Mandatory Attribute</label>
    </div>
    <div class="flex items-center">
        <input type="checkbox" id="edit-manual-entry-checkbox"
            class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
        <label for="edit-manual-entry-checkbox" class="ml-2 block text-sm text-gray-900">Manual Entry Attribute</label>
    </div>
</div>
                <div class="flex justify-end space-x-3">
                    <button id="cancel-edit-btn"
                        class="px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400">
                        Cancel
                    </button>
                    <button id="save-edit-btn" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                        Save Changes
                    </button>
                </div>
            </div>
        </div>
    </div>
<!-- Loading Screen -->
<div id="loading-screen" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-[60]" style="display: none;">
    <div class="bg-white rounded-lg p-8 flex flex-col items-center space-y-4 max-w-sm mx-4">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
        <div class="text-center">
            <h3 id="loading-title" class="text-lg font-medium text-gray-900 mb-2">Loading...</h3>
            <p id="loading-message" class="text-sm text-gray-500">Please wait while we process your request.</p>
        </div>
    </div>
</div>
    <!-- Message Box Modal -->
    <div id="message-box-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-9999"
        style="display: none;">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <div id="message-box-icon" class="mx-auto flex items-center justify-center h-12 w-12 rounded-full mb-4">
                    <!-- Icon will be inserted here -->
                </div>
                <h3 id="message-box-title" class="text-lg leading-6 font-medium text-gray-900 mb-2"></h3>
                <div class="mt-2 px-7 py-3">
                    <p id="message-box-text" class="text-sm text-gray-500"></p>
                </div>
                <div class="items-center px-4 py-3">
                    <button id="message-box-ok-btn"
                        class="px-4 py-2 bg-blue-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-300">
                        OK
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Create User Modal -->
    <div id="create-user-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50"
        style="display: none;">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <h3 class="text-lg font-medium text-gray-900 text-center mb-4">Create New User</h3>
                <form id="create-user-form" class="space-y-4">
                    <div>
                        <label for="new-email" class="block text-sm font-medium text-gray-700">Email</label>
                        <input type="email" id="new-email" name="email" required
                            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="new-password" class="block text-sm font-medium text-gray-700">Password</label>
                        <input type="password" id="new-password" name="password" required
                            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="new-username" class="block text-sm font-medium text-gray-700">Username</label>
                        <input type="text" id="new-username" name="username" required
                            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="new-role" class="block text-sm font-medium text-gray-700">Role</label>
                        <select id="new-role" name="role" required
                            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                            <option value="">Select Role</option>
                            <option value="admin">Admin</option>
                            <option value="creator">Creator</option>
                            <option value="reviewer">Reviewer</option>
                        </select>
                    </div>
                    <div class="flex justify-end space-x-3">
                        <button type="button" id="cancel-create-user"
                            class="px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400">
                            Cancel
                        </button>
                        <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                            Create User
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // =========================================================
        // GLOBAL VARIABLES AND INITIALIZATION
        // =========================================================

        // Supabase configuration
        const SUPABASE_URL = 'https://mvftaaxgdygeyzcvzqfr.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im12ZnRhYXhnZHlnZXl6Y3Z6cWZyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg2MjI3OTQsImV4cCI6MjA3NDE5ODc5NH0.nj5c_AAEg4U2qlcE1vQDMWt0nfXpmUYR1lrTR6KCIDY';

        // üö® ULTIMATE SUPABASE FIX - BULLETPROOF INITIALIZATION
        // This GUARANTEES no redeclaration errors under ANY circumstances
        let supabase;
        
        (function initializeSupabaseUltimate() {
            try {
                // Check if already initialized globally
                if (typeof window.globalSupabaseInstance !== 'undefined') {
                    supabase = window.globalSupabaseInstance;
                    console.log('‚ôªÔ∏è Reusing existing global supabase instance');
                    return;
                }
                
                // Validate supabase library availability
                if (typeof window === 'undefined' || typeof window.supabase === 'undefined') {
                    console.error('‚ùå Supabase library not loaded! Check script tag.');
                    return;
                }
                
                if (typeof window.supabase.createClient !== 'function') {
                    console.error('‚ùå Supabase createClient method not available!');
                    return;
                }
                
                // Create client with comprehensive error handling
                const client = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                
                // Validate client creation
                if (!client || typeof client.from !== 'function') {
                    throw new Error('Invalid supabase client created');
                }
                
                // Store globally with unique identifier
                window.globalSupabaseInstance = client;
                supabase = client;
                
                console.log('‚úÖ Supabase ULTIMATE initialization successful');
                console.log('üîß Client validation:', {
                    hasFrom: typeof client.from === 'function',
                    hasAuth: typeof client.auth === 'object',
                    isReady: true
                });
                
            } catch (error) {
                console.error('‚ùå CRITICAL: Supabase initialization failed:', error);
                console.error('üìç Error details:', {
                    name: error.name,
                    message: error.message,
                    stack: error.stack
                });
                
                // Create safe fallback to prevent script crashes
                supabase = {
                    from: () => ({
                        select: () => Promise.reject(new Error('Supabase initialization failed')),
                        insert: () => Promise.reject(new Error('Supabase initialization failed')),
                        update: () => Promise.reject(new Error('Supabase initialization failed')),
                        delete: () => Promise.reject(new Error('Supabase initialization failed'))
                    }),
                    rpc: () => Promise.reject(new Error('Supabase initialization failed')),
                    auth: {
                        signIn: () => Promise.reject(new Error('Supabase initialization failed'))
                    }
                };
                
                console.warn('‚ö†Ô∏è Using fallback supabase mock to prevent crashes');
            }
        })();

        // Initialize EmailJS for notifications
        emailjs.init('zx157n_sqPsV0_piq'); // Your EmailJS public key

        // Email notification functions
        async function sendEmailNotification(recipientEmail, recipientName, subject, projectName, submitterName, projectId, creationDate) {
            try {
                const templateParams = {
                    to_email: recipientEmail,
                    to_name: recipientName,
                    subject: subject,
                    project_name: projectName,
                    submitter_name: submitterName,
                    request_id: projectId,
                    creation_date: creationDate,
                    message: `A new project: "${projectName}", Request ID: ${projectId} has been created by ${submitterName} on ${creationDate} and is pending your approval. Please login to the approval portal to submit your review.`,
                    portal_link: window.location.origin + '/approval-portal',
                    from_name: 'CSI Attribute Portal'
                };
                
                console.log('Sending email notification:', templateParams);
                
                const response = await emailjs.send('service_0xi7zg5', 'template_k2dzru6', templateParams);
                console.log('Email sent successfully:', response);
                return { success: true, response };
            } catch (error) {
                console.error('Failed to send email notification:', error);
                return { success: false, error };
            }
        }

        async function notifyReviewerOnSubmission(projectId, projectName) {
            try {
                // Get project details with reviewer information
                const { data: project, error: projectError } = await supabase
                    .from('classification_projects')
                    .select(`
                        *,
                        assigned_reviewer:assigned_reviewer_id(id, email, username),
                        creator:created_by(username)
                    `)
                    .eq('id', projectId)
                    .single();

                if (projectError) {
                    console.error('Error fetching project for notification:', projectError);
                    return false;
                }

                if (project.assigned_reviewer && project.assigned_reviewer.email) {
                    const subject = `New CSI Project Submitted for Review: ${projectName}`;
                    
                    // Format the creation date
                    const creationDate = new Date(project.created_at).toLocaleDateString('en-US', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    });
                    
                    const emailResult = await sendEmailNotification(
                        project.assigned_reviewer.email,
                        project.assigned_reviewer.username,
                        subject,
                        projectName,
                        project.creator.username,
                        projectId,
                        creationDate
                    );

                    if (emailResult.success) {
                        console.log('Reviewer notification sent successfully');
                        return true;
                    } else {
                        console.error('Failed to send reviewer notification');
                        return false;
                    }
                } else {
                    console.log('No reviewer assigned or no email found');
                    return false;
                }
            } catch (error) {
                console.error('Error in notifyReviewerOnSubmission:', error);
                return false;
            }
        }

        // Global state
        let currentUser = null;
        let currentProject = null;
        let collectedData = [];
        let currentAdditionalLevel = null;
        let availableUOMs = [];
        let editingAttribute = null; // For tracking which attribute is being edited
        let loadedDraftProject = null; // For tracking loaded draft

        // DOM elements
        const loginModal = document.getElementById('login-modal');
        const createUserModal = document.getElementById('create-user-modal');
        const messageBoxModal = document.getElementById('message-box-modal');
        const editAttributeModal = document.getElementById('edit-attribute-modal');

        // Draft info elements
        const draftInfo = document.getElementById('draft-info');
        const draftName = document.getElementById('draft-name');
        const closeDraftBtn = document.getElementById('close-draft-btn');

        // Tab elements
        const tabCreate = document.getElementById('tab-create');
        const tabProjects = document.getElementById('tab-projects');
        const tabAdmin = document.getElementById('tab-admin');
        const tabDashboard = document.getElementById('tab-dashboard');
        const contentDashboard = document.getElementById('content-dashboard');
        const contentCreate = document.getElementById('content-create');
        const contentProjects = document.getElementById('content-projects');
        const contentAdmin = document.getElementById('content-admin');

        // Form elements
        const loginForm = document.getElementById('login-form');
        const createUserForm = document.getElementById('create-user-form');
        const logoutBtn = document.getElementById('logout-btn');
        const debugBtn = document.getElementById('debug-btn');
             const refreshProjectsBtn = document.getElementById('refresh-projects-btn');

        // CSI hierarchy elements
        const divisionSelect = document.getElementById('division-select');
        const sectionSelect = document.getElementById('section-select');
        const subsectionSelect = document.getElementById('subsection-select');
        const itemSelect = document.getElementById('item-select');

        // Additional level elements
        const additionalLevelsSection = document.getElementById('additional-levels-section');
        const additionalLevelName = document.getElementById('additional-level-name');
        const additionalLevelValueInput = document.getElementById('additional-level-value-input');
        const addLevelValueBtn = document.getElementById('add-level-value-btn');
        const additionalLevelSelect = document.getElementById('additional-level-select');

        // Current path elements
        const currentPathSection = document.getElementById('current-path-section');
        const currentPathDisplay = document.getElementById('current-path-display');

        // Attribute elements
        const attributeCreationSection = document.getElementById('attribute-creation-section');
        const attributeNameInput = document.getElementById('attribute-name-input');
        const attributeStandardValuesContainer = document.getElementById('attribute-standard-values-container');
        const addAttributeValueBtn = document.getElementById('add-attribute-value-btn');
        const mandatoryCheckbox = document.getElementById('mandatory-checkbox');
        const addAttributeBtn = document.getElementById('add-attribute-btn');

        // Edit modal elements
        const editAttrName = document.getElementById('edit-attr-name');
        const editValuesContainer = document.getElementById('edit-values-container');
        const editMandatoryCheckbox = document.getElementById('edit-mandatory-checkbox');
        const addEditValueBtn = document.getElementById('add-edit-value-btn');
        const saveEditBtn = document.getElementById('save-edit-btn');
        const cancelEditBtn = document.getElementById('cancel-edit-btn');

        // Display elements
        const collectedDataSection = document.getElementById('collected-data-section');
        const collectedDataDisplay = document.getElementById('collected-data-display');
        const actionButtonsSection = document.getElementById('action-buttons-section');

        // Action buttons
        const saveDraftBtn = document.getElementById('save-draft-btn');
        const submitForReviewBtn = document.getElementById('submit-for-review-btn');
        const clearAllBtn = document.getElementById('clear-all-btn');
        const exportExcelBtn = document.getElementById('export-excel-btn');

        // Review elements
        const reviewerSelection = document.getElementById('reviewer-selection');
        const reviewerSelect = document.getElementById('reviewer-select');
        const confirmSubmitBtn = document.getElementById('confirm-submit-btn');
        const cancelSubmitBtn = document.getElementById('cancel-submit-btn');

        // Message box elements
        const messageBoxOkBtn = document.getElementById('message-box-ok-btn');

        // =========================================================
        // UTILITY FUNCTIONS
        // =========================================================
function showLoadingScreen(message = 'Loading...', title = 'Please wait') {
    const loadingScreen = document.getElementById('loading-screen');
    const loadingTitle = document.getElementById('loading-title');
    const loadingMessage = document.getElementById('loading-message');
    
    loadingTitle.textContent = title;
    loadingMessage.textContent = message;
    loadingScreen.style.display = 'flex';
}

function hideLoadingScreen() {
    const loadingScreen = document.getElementById('loading-screen');
    loadingScreen.style.display = 'none';
}

function updateLoadingMessage(message) {
    const loadingMessage = document.getElementById('loading-message');
    loadingMessage.textContent = message;
}
        function showMessageBox(message, isError = false) {
    const messageBoxText = document.getElementById('message-box-text');
    const messageBoxTitle = document.getElementById('message-box-title');
    const messageBoxIcon = document.getElementById('message-box-icon');

    messageBoxText.textContent = message;

    if (isError) {
        messageBoxTitle.textContent = 'Error';
        messageBoxIcon.innerHTML = '<svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path></svg>';
        messageBoxIcon.className = 'mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100 mb-4';
    } else {
        messageBoxTitle.textContent = 'Success';
        messageBoxIcon.innerHTML = '<svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>';
        messageBoxIcon.className = 'mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-green-100 mb-4';
    }

    // Ensure message box appears above all other modals
    const messageBoxModal = document.getElementById('message-box-modal');
    messageBoxModal.style.zIndex = '99999';
    
    showModal(messageBoxModal);
}
        function hideModal(modal) {
    console.log('hideModal called with:', modal);
    if (modal) {
        modal.style.display = 'none';
        console.log('Modal hidden successfully');
        // Remove any backdrop clicks
        document.body.style.overflow = 'auto';
    } else {
        console.error('hideModal: modal element is null or undefined');
    }
}

function showModal(modal) {
    console.log('showModal called with:', modal);
    if (modal) {
        modal.style.display = 'block';
        console.log('Modal shown successfully');
        // Prevent body scroll when modal is open
        document.body.style.overflow = 'hidden';
    } else {
        console.error('showModal: modal element is null or undefined');
    }
}

// Universal modal closer function
function closeModal(modalId) {
    console.log('closeModal called for:', modalId);
    const modal = document.getElementById(modalId);
    if (modal) {
        hideModal(modal);
        // Reset any global variables
        if (modalId === 'edit-project-modal') {
            editingProjectData = null;
            // Reset reviewer selection
            const reviewerSelection = document.getElementById('edit-modal-reviewer-selection');
            const submitBtn = document.getElementById('edit-modal-submit-btn');
            if (reviewerSelection) {
                reviewerSelection.style.display = 'none';
            }
            if (submitBtn && currentUser && currentUser.role === 'creator') {
                submitBtn.style.display = 'inline-block';
            }
        }
    }
}
        // Debug helper function
        async function debugSystem() {
            console.log('=== SYSTEM DEBUG ===');
            console.log('Current User:', currentUser);
            console.log('Collected Data:', collectedData);
            console.log('Current Project:', currentProject);
            console.log('Loaded Draft:', loadedDraftProject);

            try {
                // Test database connection
                const { data: testUsers, error: userError } = await supabase
                    .from('users')
                    .select('*')
                    .limit(1);
                console.log('Database Connection Test:', { testUsers, userError });

                // Test RPC function
                const { data: divisions, error: divError } = await supabase.rpc('get_divisions');
                console.log('RPC Test (get_divisions):', { divisions: divisions?.length, error: divError });

                // Test project fetching
                if (currentUser) {
                    const { data: projects, error: projError } = await supabase
                        .from('classification_projects')
                        .select('*')
                        .or(`created_by.eq.${currentUser.id},assigned_reviewer_id.eq.${currentUser.id}`);
                    console.log('Projects Test:', { count: projects?.length, error: projError });
                }
            } catch (err) {
                console.error('Debug error:', err);
            }
        }
// Add this function to show/hide standard values based on manual entry checkbox
// Missing helper functions - Add these after the existing functions around line 919

function addNewAttributeToEditModal() {
    if (!window.editingProjectData) {
        showMessageBox('No project data available for editing.', true);
        return;
    }
    
    const newAttribute = {
        attribute_name: 'New Attribute',
        standard_values: [{ name: 'Value 1', unit: '' }],
        is_mandatory: false,
        is_manual_entry: false
    };
    
    // Add to the project data
    if (!window.editingProjectData.attributes) {
        window.editingProjectData.attributes = [];
    }
    window.editingProjectData.attributes.push(newAttribute);
    
    // Refresh the display
    loadEditModalAttributesDisplay(window.editingProjectData.attributes);
    
    showMessageBox('New attribute added. Remember to save your changes.');
}
// Enhanced path checking function
async function checkProjectPathAvailability(divisionCode, sectionCode, detailedSectionCode, itemCode, additionalLevelName, additionalLevelValue, excludeProjectId = null) {
    try {
        const { data, error } = await supabase.rpc('check_project_path_availability', {
            division_code_param: divisionCode,
            section_code_param: sectionCode,
            detailed_section_code_param: detailedSectionCode,
            item_code_param: itemCode,
            additional_level_name_param: additionalLevelName,
            additional_level_value_param: additionalLevelValue,
            exclude_project_id_param: excludeProjectId
        });
        
        if (error) throw error;
        return data;
        
    } catch (error) {
        console.error('Error checking path availability:', error);
        return { available: false, message: 'Error checking path availability: ' + error.message };
    }
}
function toggleStandardValuesSection() {
    const manualEntryCheckbox = document.getElementById('manual-entry-checkbox');
    const standardValuesContainer = document.getElementById('attribute-standard-values-container');
    const addValueBtn = document.getElementById('add-attribute-value-btn');
    const standardValuesLabel = standardValuesContainer.parentElement.querySelector('label');
    
    if (manualEntryCheckbox.checked) {
        // HIDE EVERYTHING
        standardValuesLabel.style.display = 'none';
        standardValuesContainer.style.display = 'none';
        addValueBtn.style.display = 'none';
        
        // CLEAR ALL ENTRIES
        standardValuesContainer.innerHTML = '';
        
    } else {
        // SHOW EVERYTHING
        standardValuesLabel.style.display = 'block';
        standardValuesContainer.style.display = 'block';
        addValueBtn.style.display = 'inline-block';
        
        // RESTORE DEFAULT ROW
        standardValuesContainer.innerHTML = `
            <div class="flex space-x-2 items-center standard-value-row">
                <input type="text" class="attribute-value-name-input flex-1 px-3 py-2 text-base border-gray-300 rounded-md shadow-sm" placeholder="Value Name">
                <select class="attribute-value-unit-select w-32 px-3 py-2 text-base border-gray-300 rounded-md shadow-sm">
                    <option value="">UOM</option>
                </select>
                <button class="remove-value-btn px-2 py-1 bg-red-500 text-white rounded-md hover:bg-red-600 text-sm hidden" onclick="removeStandardValue(this)">Remove</button>
            </div>
        `;
        updateUOMSelects();
        updateRemoveButtons();
    }
}

function toggleEditStandardValuesSection() {
    const manualEntryCheckbox = document.getElementById('edit-manual-entry-checkbox');
    const editValuesContainer = document.getElementById('edit-values-container');
    const addEditValueBtn = document.getElementById('add-edit-value-btn');
    const standardValuesLabel = editValuesContainer.parentElement.querySelector('label');
    
    if (manualEntryCheckbox.checked) {
        // COMPLETELY DISABLE standard values section
        
        // Clear all existing standard values
        editValuesContainer.innerHTML = '';
        
        // Hide and disable everything
        editValuesContainer.style.display = 'none';
        addEditValueBtn.style.display = 'none';
        addEditValueBtn.disabled = true;
        standardValuesLabel.style.opacity = '0.3';
        standardValuesLabel.style.pointerEvents = 'none';
        
        // Add explanation text
        let explanationText = document.getElementById('edit-manual-entry-explanation');
        if (!explanationText) {
            explanationText = document.createElement('div');
            explanationText.id = 'edit-manual-entry-explanation';
            explanationText.className = 'p-3 bg-blue-50 border border-blue-200 rounded-md mt-2';
            explanationText.innerHTML = `
                <div class="flex items-center">
                    <svg class="w-5 h-5 text-blue-600 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                    </svg>
                    <span class="text-sm text-blue-800"><strong>Manual Entry Mode:</strong> No predefined values needed.</span>
                </div>
            `;
            editValuesContainer.parentElement.appendChild(explanationText);
        }
    } else {
        // ENABLE standard values section
        
        // Show and enable everything
        editValuesContainer.style.display = 'block';
        addEditValueBtn.style.display = 'inline-block';
        addEditValueBtn.disabled = false;
        standardValuesLabel.style.opacity = '1';
        standardValuesLabel.style.pointerEvents = 'auto';
        
        // Remove explanation text
        const explanationText = document.getElementById('edit-manual-entry-explanation');
        if (explanationText) {
            explanationText.remove();
        }
        
        // If no values exist, add a default row
        if (editValuesContainer.children.length === 0) {
            const newRow = document.createElement('div');
            newRow.className = 'flex space-x-2 items-center edit-value-row';
            newRow.innerHTML = `
                <input type="text" class="edit-value-name-input flex-1 px-3 py-2 text-base border-gray-300 rounded-md shadow-sm" placeholder="Value Name">
                <select class="edit-value-unit-select w-32 px-3 py-2 text-base border-gray-300 rounded-md shadow-sm">
                    <option value="">UOM</option>
                </select>
                <button class="remove-edit-value-btn px-2 py-1 bg-red-500 text-white rounded-md hover:bg-red-600 text-sm" onclick="removeEditStandardValue(this)">Remove</button>
            `;
            editValuesContainer.appendChild(newRow);

            // Populate UOM options
            const select = newRow.querySelector('.edit-value-unit-select');
            availableUOMs.forEach(uom => {
                const option = document.createElement('option');
                option.value = uom.uom_symbol || uom.uom_name;
                option.textContent = `${uom.uom_name} (${uom.uom_symbol || uom.uom_name})`;
                select.appendChild(option);
            });

            updateEditRemoveButtons();
        }
    }
}

// =========================================================
        // NEW: STANDARD VALUE MANAGEMENT
        // =========================================================

        function removeStandardValue(button) {
            const row = button.closest('.standard-value-row');
            const container = row.parentElement;
            const rows = container.querySelectorAll('.standard-value-row');

            // Don't remove if it's the last row
            if (rows.length > 1) {
                row.remove();
            } else {
                showMessageBox('At least one standard value is required.', true);
            }

            updateRemoveButtons();
        }

        function updateRemoveButtons() {
            const rows = document.querySelectorAll('#attribute-standard-values-container .standard-value-row');
            rows.forEach((row, index) => {
                const removeBtn = row.querySelector('.remove-value-btn');
                if (removeBtn) {
                    // Show remove button only if there's more than one row
                    if (rows.length > 1) {
                        removeBtn.classList.remove('hidden');
                    } else {
                        removeBtn.classList.add('hidden');
                    }
                }
            });
        }

        function removeEditStandardValue(button) {
    const valueItem = button.closest('.standard-value-item');
    const container = valueItem.parentElement;
    const items = container.querySelectorAll('.standard-value-item');

    // Always allow removal, if it's the last item, show "no values" message
    if (items.length > 1) {
        valueItem.remove();
    } else {
        valueItem.remove();
        // Add "no values" message if container is empty
        if (container.querySelectorAll('.standard-value-item').length === 0) {
            container.innerHTML = '<p class="text-gray-500 text-sm italic">No standard values defined</p>';
        }
    }
}
        function updateEditRemoveButtons() {
            const rows = document.querySelectorAll('#edit-values-container .edit-value-row');
            rows.forEach((row, index) => {
                const removeBtn = row.querySelector('.remove-edit-value-btn');
                if (removeBtn) {
                    // Show remove button only if there's more than one row
                    if (rows.length > 1) {
                        removeBtn.classList.remove('hidden');
                    } else {
                        removeBtn.classList.add('hidden');
                    }
                }
            });
        }

        // =========================================================
        // NEW: ATTRIBUTE EDITING FUNCTIONS
        // =========================================================

       function editAttribute(entryIndex, attributeIndex) {
    // Handle both old single-parameter and new two-parameter calls
    if (typeof attributeIndex === 'undefined') {
        // Old single parameter call - assume entryIndex is actually attributeIndex
        attributeIndex = entryIndex;
        entryIndex = 0;
    }
    
    if (!collectedData || collectedData.length === 0) {
        showMessageBox('No collected data found.', true);
        return;
    }
    
    if (!collectedData[entryIndex] || !collectedData[entryIndex].attributes[attributeIndex]) {
        showMessageBox('Attribute not found.', true);
        return;
    }
    
    const attribute = collectedData[entryIndex].attributes[attributeIndex];
    
    // Store original for potential cancellation
    window.editingAttribute = {
        entryIndex: entryIndex,
        attributeIndex: attributeIndex,
        original: JSON.parse(JSON.stringify(attribute))
    };
    
    // Find the attribute container in the DOM - need to find the specific attribute within the specific entry
    const collectedDataContainer = document.getElementById('collected-data-display');
    const entryContainers = collectedDataContainer.querySelectorAll('.mb-6.p-4.border.border-gray-200.rounded-lg.bg-white');
    const targetEntryContainer = entryContainers[entryIndex];
    
    if (!targetEntryContainer) {
        showMessageBox('Could not find entry container.', true);
        return;
    }
    
    const attributeItems = targetEntryContainer.querySelectorAll('.flex.items-center.justify-between.p-2.bg-gray-50.rounded');
    const targetAttributeItem = attributeItems[attributeIndex];
    
    if (!targetAttributeItem) {
        showMessageBox('Could not find attribute element.', true);
        return;
    }
    
    // Create edit form HTML
    const editFormHTML = `
        <div class="edit-attribute-form border-2 border-blue-300 p-4 rounded-lg bg-blue-50 mb-4">
            <div class="flex justify-between items-center mb-4">
                <h4 class="font-medium text-blue-900">Edit Attribute</h4>
                <button type="button" onclick="cancelEditAttribute()" class="text-gray-500 hover:text-gray-700">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Attribute Name</label>
                    <input type="text" id="edit-attr-name" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500" 
                           value="${attribute.name || ''}" placeholder="Enter attribute name">
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="flex items-center">
                        <input type="checkbox" id="edit-attr-mandatory" class="mr-2" ${attribute.mandatory ? 'checked' : ''}>
                        <label for="edit-attr-mandatory" class="text-sm text-gray-700">Mandatory</label>
                    </div>
                    <div class="flex items-center">
                        <input type="checkbox" id="edit-attr-manual" class="mr-2" ${attribute.isManualEntry ? 'checked' : ''}>
                        <label for="edit-attr-manual" class="text-sm text-gray-700">Manual Entry</label>
                    </div>
                </div>
                
                <div>
                    <div class="flex justify-between items-center mb-3">
                        <label class="block text-sm font-medium text-gray-700">Standard Values</label>
                        <button type="button" onclick="addStandardValueInEdit()" 
                                class="px-3 py-1 bg-blue-500 text-white rounded text-sm hover:bg-blue-600">
                            Add Value
                        </button>
                    </div>
                    <div id="edit-standard-values" class="space-y-2 max-h-48 overflow-y-auto">
                        ${(attribute.standardValues || []).map((value, index) => `
                            <div class="standard-value-item flex items-center space-x-2 p-2 border border-gray-200 rounded">
                                <input type="text" class="standard-value-name flex-1 px-2 py-1 border border-gray-300 rounded text-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" 
                                       value="${value.name || ''}" placeholder="Value name">
                                <input type="text" class="standard-value-unit w-20 px-2 py-1 border border-gray-300 rounded text-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" 
                                       value="${value.unit || ''}" placeholder="Unit">
                                <button type="button" onclick="removeStandardValueInEdit(this)" 
                                        class="px-2 py-1 bg-red-500 text-white rounded text-xs hover:bg-red-600 flex-shrink-0">
                                    Remove
                                </button>
                            </div>
                        `).join('')}
                    </div>
                </div>
                
                <div class="flex justify-end space-x-3 pt-4 border-t">
                    <button type="button" onclick="cancelEditAttribute()" 
                            class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600">
                        Cancel
                    </button>
                    <button type="button" onclick="saveEditedAttribute()" 
                            class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600">
                        Save Changes
                    </button>
                </div>
            </div>
        </div>
    `;
    
    // Store original content and replace with edit form
    window.originalAttributeContent = targetAttributeItem.innerHTML;
    targetAttributeItem.innerHTML = editFormHTML;
    
    // Focus on the name input
    setTimeout(() => {
        const nameInput = document.getElementById('edit-attr-name');
        if (nameInput) nameInput.focus();
    }, 100);
}
function saveEditedAttribute() {
    if (!window.editingAttribute) {
        showMessageBox('No attribute being edited.', true);
        return;
    }
    
    const entryIndex = window.editingAttribute.entryIndex;
    const attributeIndex = window.editingAttribute.attributeIndex;
    
    if (!collectedData || !collectedData[entryIndex] || !collectedData[entryIndex].attributes[attributeIndex]) {
        showMessageBox('Invalid attribute data.', true);
        return;
    }
    
    // Get updated values from form
    const nameInput = document.getElementById('edit-attr-name');
    const mandatoryInput = document.getElementById('edit-attr-mandatory');
    const manualInput = document.getElementById('edit-attr-manual');
    
    if (!nameInput) {
        showMessageBox('Could not find form inputs.', true);
        return;
    }
    
    const name = nameInput.value.trim();
    const isMandatory = mandatoryInput ? mandatoryInput.checked : false;
    const isManualEntry = manualInput ? manualInput.checked : false;
    
    if (!name) {
        showMessageBox('Attribute name is required.', true);
        nameInput.focus();
        return;
    }
    
    // Collect standard values from the edit form
    const standardValues = [];
    const standardValueItems = document.querySelectorAll('#edit-standard-values .standard-value-item');
    
    standardValueItems.forEach(item => {
        const nameInput = item.querySelector('.standard-value-name');
        const unitInput = item.querySelector('.standard-value-unit');
        
        if (nameInput && nameInput.value.trim()) {
            standardValues.push({
                name: nameInput.value.trim(),
                unit: unitInput ? unitInput.value.trim() : ''
            });
        }
    });
    
    // Update the attribute in collectedData
    const attribute = collectedData[entryIndex].attributes[attributeIndex];
    attribute.name = name;
    attribute.mandatory = isMandatory;
    attribute.isManualEntry = isManualEntry;
    attribute.standardValues = standardValues;
    
    // Clear editing state
    window.editingAttribute = null;
    window.originalAttributeContent = null;
    
    // Refresh the entire collected data display to show changes
    updateCollectedDataDisplay();
    
    showMessageBox('Attribute updated successfully!');
}
function cancelEditAttribute() {
    if (!window.editingAttribute) return;
    
    const attributeIndex = window.editingAttribute.index;
    
    // Restore original attribute data if it was modified
    if (window.editingAttribute.original && collectedData && collectedData.length > 0) {
        collectedData[0].attributes[attributeIndex] = JSON.parse(JSON.stringify(window.editingAttribute.original));
    }
    
    // Clear editing state
    window.editingAttribute = null;
    window.originalAttributeContent = null;
    
    // Refresh the display to restore original view
    updateCollectedDataDisplay();
}
function addStandardValueInEdit() {
    const container = document.getElementById('edit-standard-values');
    if (!container) return;
    
    const newValueHTML = `
        <div class="standard-value-item flex items-center space-x-2 p-2 border border-gray-200 rounded">
            <input type="text" class="standard-value-name flex-1 px-2 py-1 border border-gray-300 rounded text-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" 
                   value="" placeholder="Value name">
            <input type="text" class="standard-value-unit w-20 px-2 py-1 border border-gray-300 rounded text-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" 
                   value="" placeholder="Unit">
            <button type="button" onclick="removeStandardValueInEdit(this)" 
                    class="px-2 py-1 bg-red-500 text-white rounded text-xs hover:bg-red-600 flex-shrink-0">
                Remove
            </button>
        </div>
    `;
    
    container.insertAdjacentHTML('beforeend', newValueHTML);
    
    // Focus on the new name input
    const newItems = container.querySelectorAll('.standard-value-item');
    const lastItem = newItems[newItems.length - 1];
    const nameInput = lastItem.querySelector('.standard-value-name');
    if (nameInput) nameInput.focus();
}

function removeStandardValueInEdit(button) {
    const item = button.closest('.standard-value-item');
    if (item) {
        item.remove();
    }
}
// =========================================================
        // NEW: DRAFT LOADING FUNCTIONS
        // =========================================================

        async function loadDraftProject(projectId) {
            try {
                // Load project details
                const { data: project, error: projectError } = await supabase
                    .from('classification_projects')
                    .select('*')
                    .eq('id', projectId)
                    .single();

                if (projectError) throw projectError;

                // Load project attributes
                const { data: attributes, error: attrError } = await supabase
                    .from('project_attributes')
                    .select('*')
                    .eq('project_id', projectId);

                if (attrError) throw attrError;

                // Set current/loaded project
                loadedDraftProject = project;
                currentProject = project;

                // Show draft info
                draftInfo.style.display = 'block';
                draftName.textContent = project.project_name;

                // Load CSI hierarchy
                await loadAndSelectCSIHierarchy(project);

                // Load collected data
                collectedData = [];
                const entry = {
                    division: `${project.division_code} - ${await getDivisionDescription(project.division_code)}`,
                    section: `${project.section_code} - ${await getSectionDescription(project.section_code)}`,
                    subsection: `${project.detailed_section_code} - ${await getDetailedSectionDescription(project.detailed_section_code)}`,
                    item: `${project.item_code} - ${await getItemDescription(project.item_code)}`,
                    additionalLevel: project.additional_level_name ? {
                        name: project.additional_level_name,
                        value: project.additional_level_value
                    } : null,
                    attributes: []
                };

               // Parse attributes
attributes.forEach(attr => {
    entry.attributes.push({
        name: attr.attribute_name,
        standardValues: attr.standard_values || [],
        mandatory: attr.is_mandatory,
        isManualEntry: attr.is_manual_entry || false
    });
});

                collectedData.push(entry);

                // Update display
                updateCollectedDataDisplay();

                // Switch to create tab
                switchTab('create');

                showMessageBox(`Draft project "${project.project_name}" loaded successfully!`);
            } catch (error) {
                console.error('Error loading draft:', error);
                showMessageBox(`Failed to load draft: ${error.message}`, true);
            }
        }

        async function loadAndSelectCSIHierarchy(project) {
            // Load and select division
            await loadDivisions();
            divisionSelect.value = `${project.division_code} - ${await getDivisionDescription(project.division_code)}`;

            // Load and select section
            await loadSections(project.division_code);
            sectionSelect.value = `${project.section_code} - ${await getSectionDescription(project.section_code)}`;

            // Load and select detailed section
            await loadDetailedSections(project.division_code, project.section_code);
            subsectionSelect.value = `${project.detailed_section_code} - ${await getDetailedSectionDescription(project.detailed_section_code)}`;

            // Load and select item
            await loadItems(project.division_code, project.section_code, project.detailed_section_code);
            itemSelect.value = `${project.item_code} - ${await getItemDescription(project.item_code)}`;

            // Enable sections
            attributeCreationSection.classList.remove('disabled-section');
            additionalLevelsSection.classList.remove('disabled-section');

            // Load additional level if exists
           if (project.additional_level_name) {
    await loadAdditionalLevel(project.division_code, project.section_code, project.detailed_section_code, project.item_code);
    // Remove "Types" suffix from existing database records
    let levelName = project.additional_level_name;
    if (levelName.endsWith(' Types')) {
        levelName = levelName.replace(' Types', '');
    }
    additionalLevelName.value = levelName;
    additionalLevelSelect.value = project.additional_level_value;
}

            renderCurrentPath();
        }

        async function getDivisionDescription(divisionCode) {
    try {
        const { data, error } = await supabase
            .from('csi_hierarchy')
            .select('division_description')
            .eq('division_code', divisionCode)
            .limit(1)
            .single();
        
        if (error) throw error;
        return data?.division_description || 'Unknown Division';
    } catch (error) {
        console.error('Error getting division description:', error);
        return 'Unknown Division';
    }
}

async function getSectionDescription(sectionCode) {
    try {
        const { data, error } = await supabase
            .from('csi_hierarchy')
            .select('section_description')
            .eq('section_code', sectionCode)
            .limit(1)
            .single();
        
        if (error) throw error;
        return data?.section_description || 'Unknown Section';
    } catch (error) {
        console.error('Error getting section description:', error);
        return 'Unknown Section';
    }
}

async function getDetailedSectionDescription(detailedSectionCode) {
    try {
        const { data, error } = await supabase
            .from('csi_hierarchy')
            .select('detailed_section_description')
            .eq('detailed_section_code', detailedSectionCode)
            .limit(1)
            .single();
        
        if (error) throw error;
        return data?.detailed_section_description || 'Unknown Detailed Section';
    } catch (error) {
        console.error('Error getting detailed section description:', error);
        return 'Unknown Detailed Section';
    }
}

async function getItemDescription(itemCode) {
    try {
        const { data, error } = await supabase
            .from('csi_hierarchy')
            .select('item_description')
            .eq('item_code', itemCode)
            .limit(1)
            .single();
        
        if (error) throw error;
        return data?.item_description || 'Unknown Item';
    } catch (error) {
        console.error('Error getting item description:', error);
        return 'Unknown Item';
    }
}
        function closeDraft() {
            const message = loadedDraftProject?.wasRejected
                ? 'Are you sure you want to close this rejected project? Any unsaved modifications will be lost.'
                : 'Are you sure you want to close this draft? Any unsaved changes will be lost.';

            if (confirm(message)) {
                // Remove reviewer comments section if exists
                const commentsSection = document.getElementById('reviewer-comments-section');
                if (commentsSection) {
                    commentsSection.remove();
                }

                loadedDraftProject = null;
                currentProject = null;
                collectedData = [];
                draftInfo.style.display = 'none';

                // Reset form
                divisionSelect.value = '';
                sectionSelect.innerHTML = '<option value="">Select Section</option>';
                sectionSelect.disabled = true;
                subsectionSelect.innerHTML = '<option value="">Select Detailed Section</option>';
                subsectionSelect.disabled = true;
                itemSelect.innerHTML = '<option value="">Select Item</option>';
                itemSelect.disabled = true;
                additionalLevelName.value = '';
                additionalLevelSelect.innerHTML = '<option value="">Select value</option>';

                attributeCreationSection.classList.add('disabled-section');
                additionalLevelsSection.classList.add('disabled-section');

                updateCollectedDataDisplay();
                renderCurrentPath();

                showMessageBox(loadedDraftProject?.wasRejected ? 'Rejected project modification cancelled.' : 'Draft closed.');
            }
        }
        // =========================================================
        // AUTHENTICATION FUNCTIONS (KEPT AS-IS)
        // =========================================================

        async function login(email, password) {
            try {
                const loginError = document.getElementById('login-error');
                loginError.classList.add('hidden');

                const { data, error } = await supabase.rpc('authenticate_user', {
                    email_param: email,
                    password_param: password
                });

                if (error) {
                    console.error('Login RPC error:', error);
                    throw error;
                }

                if (data && data.success) {
                    currentUser = data.user;
                    hideModal(loginModal);
                    initializeApp();
                    showMessageBox('Login successful!');
                } else {
                    throw new Error(data?.message || 'Login failed');
                }
            } catch (error) {
                console.error('Login error:', error);
                const loginError = document.getElementById('login-error');
                loginError.textContent = error.message || 'Login failed. Please try again.';
                loginError.classList.remove('hidden');
            }
        }

        function logout() {
            currentUser = null;
            currentProject = null;
            collectedData = [];
            currentAdditionalLevel = null;
            loadedDraftProject = null;

            // Reset UI
            document.getElementById('user-info').textContent = '';
            tabAdmin.style.display = 'none';
            const tabCSIManagement = document.getElementById('tab-csi-management');
            if (tabCSIManagement) {
                tabCSIManagement.style.display = 'none';
            }
            draftInfo.style.display = 'none';

            // Show login modal
            showModal(loginModal);
        }

       function initializeApp() {
    // Update user info
    document.getElementById('user-info').textContent = `${currentUser.username} (${currentUser.role})`;

    // Show admin tabs for admin users
    if (currentUser.role === 'admin') {
        tabAdmin.style.display = 'block';
        tabDashboard.style.display = 'block';
        const tabCSIManagement = document.getElementById('tab-csi-management');
        if (tabCSIManagement) {
            tabCSIManagement.style.display = 'block';
        }
        debugBtn.classList.remove('hidden');
        
        // Initialize admin features
        setTimeout(() => {
            initializeCreateUserFunctionality();
            initializeCSIManagement();
        }, 100);
    }

    // Load initial data
    loadDivisions();
    loadReviewers();
    loadUOMs();

    // Set default tab
    switchTab('create');
}      

// =========================================================
        // TAB MANAGEMENT (KEPT AS-IS)
        // =========================================================

       function switchTab(tabName) {
    // Hide all content
    document.querySelectorAll('.tab-content').forEach(content => {
        content.style.display = 'none';
    });

    // Remove active class from all tabs
    document.querySelectorAll('.tab-button').forEach(tab => {
        tab.classList.remove('active', 'border-blue-500', 'text-blue-600');
        tab.classList.add('border-transparent', 'text-gray-500');
    });

    // Show selected content and activate tab
    switch (tabName) {
        case 'create':
            contentCreate.style.display = 'block';
            tabCreate.classList.add('active', 'border-blue-500', 'text-blue-600');
            tabCreate.classList.remove('border-transparent', 'text-gray-500');
            break;
        case 'projects':
            contentProjects.style.display = 'block';
            tabProjects.classList.add('active', 'border-blue-500', 'text-blue-600');
            tabProjects.classList.remove('border-transparent', 'text-gray-500');
            loadUserProjects();
            break;
        case 'dashboard':
            if (currentUser && currentUser.role === 'admin') {
                contentDashboard.style.display = 'block';
                tabDashboard.classList.add('active', 'border-blue-500', 'text-blue-600');
                tabDashboard.classList.remove('border-transparent', 'text-gray-500');
                loadAdminDashboard();
            }
            break;
        case 'admin':
            if (currentUser && currentUser.role === 'admin') {
                contentAdmin.style.display = 'block';
                tabAdmin.classList.add('active', 'border-blue-500', 'text-blue-600');
                tabAdmin.classList.remove('border-transparent', 'text-gray-500');
                loadUsers();
            }
            break;
        case 'csi-management':
            if (currentUser && currentUser.role === 'admin') {
                const contentCSIManagement = document.getElementById('content-csi-management');
                contentCSIManagement.style.display = 'block';
                const tabCSIManagement = document.getElementById('tab-csi-management');
                tabCSIManagement.classList.add('active', 'border-blue-500', 'text-blue-600');
                tabCSIManagement.classList.remove('border-transparent', 'text-gray-500');
                loadCSIManagementDataComplete();
            }
            break;
    }
}
        // =========================================================
        // CSI HIERARCHY FUNCTIONS (KEPT AS-IS)
        // =========================================================

        async function loadDivisions() {
            try {
                const { data, error } = await supabase.rpc('get_divisions');

                if (error) throw error;

                divisionSelect.innerHTML = '<option value="">Select Division</option>';
                if (data && Array.isArray(data)) {
                    data.forEach(division => {
                        const option = document.createElement('option');
                        option.value = `${division.division_code} - ${division.division_description}`;
                        option.textContent = `${division.division_code} - ${division.division_description}`;
                        divisionSelect.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading divisions:', error);
                showMessageBox('Failed to load divisions: ' + error.message, true);
            }
        }

        async function loadSections(divisionCode) {
    try {
        const { data, error } = await supabase.rpc('get_sections', {
            division_code_param: divisionCode
        });

        if (error) throw error;

        sectionSelect.innerHTML = '<option value="">Select Section</option>';
        sectionSelect.disabled = false;

        // Get division description for inheritance
        const divisionOption = divisionSelect.value;
        if (divisionOption) {
            // Add division as section option (for missing section levels)
            const option = document.createElement('option');
            option.value = divisionOption;
            option.textContent = `${divisionOption} (Inherited from Division)`;
            option.style.fontStyle = 'italic';
            option.style.color = '#6b7280';
            sectionSelect.appendChild(option);
        }

        if (data && Array.isArray(data)) {
            data.forEach(section => {
                const option = document.createElement('option');
                option.value = `${section.section_code} - ${section.section_description}`;
                option.textContent = `${section.section_code} - ${section.section_description}`;
                sectionSelect.appendChild(option);
            });
        }
    } catch (error) {
        console.error('Error loading sections:', error);
        showMessageBox('Failed to load sections: ' + error.message, true);
    }
}
        async function loadDetailedSections(divisionCode, sectionCode) {
    try {
        const { data, error } = await supabase.rpc('get_detailed_sections', {
            division_code_param: divisionCode,
            section_code_param: sectionCode
        });

        if (error) throw error;

        subsectionSelect.innerHTML = '<option value="">Select Detailed Section</option>';
        subsectionSelect.disabled = false;

        // Get section description for inheritance
        const sectionOption = sectionSelect.value;
        if (sectionOption) {
            // Add section as detailed section option (for missing detailed section levels)
            const option = document.createElement('option');
            option.value = sectionOption;
            option.textContent = `${sectionOption} (Inherited from Section)`;
            option.style.fontStyle = 'italic';
            option.style.color = '#6b7280';
            subsectionSelect.appendChild(option);
        }

        if (data && Array.isArray(data)) {
            data.forEach(detailedSection => {
                const option = document.createElement('option');
                option.value = `${detailedSection.detailed_section_code} - ${detailedSection.detailed_section_description}`;
                option.textContent = `${detailedSection.detailed_section_code} - ${detailedSection.detailed_section_description}`;
                subsectionSelect.appendChild(option);
            });
        }
    } catch (error) {
        console.error('Error loading detailed sections:', error);
        showMessageBox('Failed to load detailed sections: ' + error.message, true);
    }
}        
async function loadItems(divisionCode, sectionCode, detailedSectionCode) {
    try {
        const { data, error } = await supabase.rpc('get_items', {
            division_code_param: divisionCode,
            section_code_param: sectionCode,
            detailed_section_code_param: detailedSectionCode
        });

        if (error) throw error;

        itemSelect.innerHTML = '<option value="">Select Item</option>';
        itemSelect.disabled = false;

        // Get detailed section description for inheritance
        const detailedSectionOption = subsectionSelect.value;
        if (detailedSectionOption) {
            // Add detailed section as item option (for missing item levels)
            const option = document.createElement('option');
            option.value = detailedSectionOption;
            option.textContent = `${detailedSectionOption} (Inherited from Detailed Section)`;
            option.style.fontStyle = 'italic';
            option.style.color = '#6b7280';
            itemSelect.appendChild(option);
        }

        if (data && Array.isArray(data)) {
            data.forEach(item => {
                const option = document.createElement('option');
                option.value = `${item.item_code} - ${item.item_description}`;
                option.textContent = `${item.item_code} - ${item.item_description}`;
                itemSelect.appendChild(option);
            });
        }
    } catch (error) {
        console.error('Error loading items:', error);
        showMessageBox('Failed to load items: ' + error.message, true);
    }
}
        // =========================================================
        // UOM FUNCTIONS (KEPT AS-IS)
        // =========================================================

        async function loadUOMs() {
            try {
                const { data, error } = await supabase.rpc('get_uoms');

                if (error) throw error;

                availableUOMs = data || [];
                updateUOMSelects();
            } catch (error) {
                console.error('Error loading UOMs:', error);
                // Don't show error message as UOMs are not critical
            }
        }

        function updateUOMSelects() {
            const uomSelects = document.querySelectorAll('.attribute-value-unit-select');
            uomSelects.forEach(select => {
                const currentValue = select.value;
                select.innerHTML = '<option value="">UOM</option>';

                availableUOMs.forEach(uom => {
                    const option = document.createElement('option');
                    option.value = uom.uom_symbol || uom.uom_name;
                    option.textContent = `${uom.uom_name} (${uom.uom_symbol || uom.uom_name})`;
                    select.appendChild(option);
                });

                // Restore previous value if it exists
                if (currentValue) {
                    select.value = currentValue;
                }
            });
        }

        // =========================================================
        // ADDITIONAL LEVEL MANAGEMENT (KEPT AS-IS)
        // =========================================================

        async function loadAdditionalLevel(divisionCode, sectionCode, detailedSectionCode, itemCode) {
            try {
                const { data, error } = await supabase.rpc('get_additional_level', {
                    division_code_param: divisionCode,
                    section_code_param: sectionCode,
                    detailed_section_code_param: detailedSectionCode,
                    item_code_param: itemCode
                });

                if (error) throw error;

                if (data && data.length > 0) {
                    currentAdditionalLevel = data[0];
                    // Remove "Types" suffix from existing database records
let levelName = currentAdditionalLevel.level_name;
if (levelName.endsWith(' Types')) {
    levelName = levelName.replace(' Types', '');
}
additionalLevelName.value = levelName;
                    loadAdditionalLevelValues(currentAdditionalLevel.id);
                } else {
                  // Auto-generate level name from item description
const itemDescription = itemSelect.value.split(' - ')[1];
const autoLevelName = itemDescription;
additionalLevelName.value = autoLevelName;
                    currentAdditionalLevel = null;
                    additionalLevelSelect.innerHTML = '<option value="">Select value</option>';
                }
            } catch (error) {
                console.error('Error loading additional level:', error);
                // Don't show error as additional levels are optional
            }
        }

        async function loadAdditionalLevelValues(levelId) {
            try {
                const { data, error } = await supabase.rpc('get_additional_level_values', {
                    additional_level_id_param: levelId
                });

                if (error) throw error;

                additionalLevelSelect.innerHTML = '<option value="">Select value</option>';

                if (data && Array.isArray(data)) {
                    data.forEach(value => {
                        const option = document.createElement('option');
                        option.value = value.value_name;
                        option.textContent = value.value_name;
                        additionalLevelSelect.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading additional level values:', error);
            }
        }

        async function addAdditionalLevelValue() {
            const valueName = additionalLevelValueInput.value.trim();
            if (!valueName) {
                showMessageBox('Please enter a value name.', true);
                return;
            }

            const { division, section, subsection, item } = getSelectedPath();
            if (!division || !section || !subsection || !item) {
                showMessageBox('Please select a complete CSI hierarchy path.', true);
                return;
            }

            try {
                const divisionCode = division.split(' - ')[0];
                const sectionCode = section.split(' - ')[0];
                const detailedSectionCode = subsection.split(' - ')[0];
                const itemCode = item.split(' - ')[0];
                const levelName = additionalLevelName.value.trim();

                // Create or get additional level
                if (!currentAdditionalLevel) {
                    const { data: levelData, error: levelError } = await supabase.rpc('create_or_get_additional_level', {
                        level_name_param: levelName,
                        division_code_param: divisionCode,
                        section_code_param: sectionCode,
                        detailed_section_code_param: detailedSectionCode,
                        item_code_param: itemCode
                    });

                    if (levelError) throw levelError;

                    if (levelData && levelData.success) {
                        currentAdditionalLevel = { id: levelData.level_id, level_name: levelName };
                    } else {
                        throw new Error(levelData?.message || 'Failed to create additional level');
                    }
                }

                // Add value to the level
                const { data, error } = await supabase.rpc('save_additional_level_value', {
                    additional_level_id_param: currentAdditionalLevel.id,
                    value_name_param: valueName
                });

                if (error) throw error;

                if (data && data.success) {
                    showMessageBox(data.message || 'Value added successfully');
                    additionalLevelValueInput.value = '';
                    loadAdditionalLevelValues(currentAdditionalLevel.id);
                } else {
                    throw new Error(data?.message || 'Failed to add value');
                }
            } catch (error) {
                console.error('Error adding level value:', error);
                showMessageBox(error.message || 'Failed to add level value.', true);
            }
        }

       function renderCurrentPath() {
    const { division, section, subsection, item, additionalLevel } = getSelectedPath();

    let pathText = 'No path selected';
    if (division && section && subsection && item) {
        pathText = `${division} > ${section} > ${subsection} > ${item}`;
        if (additionalLevel && additionalLevel.value) {
           pathText += ` > ${additionalLevel.name} > ${additionalLevel.value}`;
        }
    }

    currentPathDisplay.textContent = pathText;
}
        function getSelectedPath() {
            const division = divisionSelect.value;
            const section = sectionSelect.value;
            const subsection = subsectionSelect.value;
            const item = itemSelect.value;

            let additionalLevel = null;
            const levelName = additionalLevelName.value.trim();
            const levelValue = additionalLevelSelect.value.trim();

            if (levelName && levelValue) {
                additionalLevel = { name: levelName, value: levelValue };
            }

            return { division, section, subsection, item, additionalLevel };
        }
// =========================================================
// PATH VALIDATION
// =========================================================

async function checkPathAvailability(excludeProjectId = null) {
    const { division, section, subsection, item, additionalLevel } = getSelectedPath();
    
    if (!division || !section || !subsection || !item) {
        return { available: true };
    }
    
    try {
        const divisionCode = division.split(' - ')[0];
        const sectionCode = section.split(' - ')[0];
        const detailedSectionCode = subsection.split(' - ')[0];
        const itemCode = item.split(' - ')[0];
        
        // Check for ANY project (from any user) that is submitted or approved
        let query = supabase
            .from('classification_projects')
            .select('id, project_name, status, created_by')
            .eq('division_code', divisionCode)
            .eq('section_code', sectionCode)
            .eq('detailed_section_code', detailedSectionCode)
            .eq('item_code', itemCode)
            .in('status', ['submitted', 'reviewer_approved', 'admin_approved']);
        
        // Exclude current project if editing
        if (excludeProjectId) {
            query = query.neq('id', excludeProjectId);
        }
        
        if (additionalLevel) {
            query = query
                .eq('additional_level_name', additionalLevel.name)
                .eq('additional_level_value', additionalLevel.value);
        } else {
            query = query.is('additional_level_name', null);
        }
        
        const { data, error } = await query;
        
        if (error) {
            console.error('Error checking path availability:', error);
            return { available: true };
        }
        
        if (data && data.length > 0) {
            const project = data[0];
            const statusText = {
                'submitted': 'pending review',
                'reviewer_approved': 'pending admin approval',
                'admin_approved': 'approved'
            }[project.status] || project.status;
            
            const isOwnProject = project.created_by === currentUser.id;
            const ownershipText = isOwnProject ? 'Your project' : 'A project';
            
            return {
                available: false,
                project: project,
                message: `${ownershipText} "${project.project_name}" for this CSI path is already ${statusText}. You cannot use this path.`
            };
        }
        
        return { available: true };
    } catch (error) {
        console.error('Error in checkPathAvailability:', error);
        return { available: true };
    }
}


async function validateAndEnableAttributeCreation() {
    const { division, section, subsection, item } = getSelectedPath();
    
    if (!division || !section || !subsection || !item) {
        return;
    }
    
    const availability = await checkPathAvailability();
    
    if (!availability.available) {
        // Disable attribute creation
        attributeCreationSection.classList.add('disabled-section');
        
        // Show warning message
        showMessageBox(availability.message, true);
        
        return false;
    } else {
        // Enable attribute creation
        attributeCreationSection.classList.remove('disabled-section');
        return true;
    }
}
        // =========================================================
        // ATTRIBUTE MANAGEMENT (ENHANCED WITH EDIT)
        // =========================================================

       async function addAttribute() {
    const { division, section, subsection, item, additionalLevel } = getSelectedPath();
    const attrName = attributeNameInput.value.trim();
    const mandatory = mandatoryCheckbox.checked;
    const isManualEntry = document.getElementById('manual-entry-checkbox').checked;

    if (!division || !section || !subsection || !item) {
        showMessageBox("Please select a complete CSI hierarchy path.", true);
        return;
    }

    // Check path availability
    const availability = await checkPathAvailability();
    if (!availability.available) {
        showMessageBox(availability.message, true);
        return;
    }

    if (!attrName) {
        showMessageBox("Attribute name is required.", true);
        return;
    }

    let standardValues = [];

    // Only validate and collect standard values if NOT manual entry
    if (!isManualEntry) {
        const valueNameInputs = attributeStandardValuesContainer.querySelectorAll('.attribute-value-name-input');
        const valueUnitSelects = attributeStandardValuesContainer.querySelectorAll('.attribute-value-unit-select');

        for (let i = 0; i < valueNameInputs.length; i++) {
            const name = valueNameInputs[i].value.trim();
            const unit = valueUnitSelects[i].value.trim();
            if (name) {
                standardValues.push({ name: name, unit: unit });
            }
        }

        if (standardValues.length === 0) {
            showMessageBox("At least one standard value is required for non-manual entry attributes.", true);
            return;
        }
    }
    // For manual entry attributes, standardValues remains an empty array

    let entry = collectedData.find(d =>
        d.division === division &&
        d.section === section &&
        d.subsection === subsection &&
        d.item === item &&
        (
            (d.additionalLevel?.value === additionalLevel?.value) ||
            (!d.additionalLevel && !additionalLevel)
        )
    );

    if (!entry) {
        entry = { division, section, subsection, item, additionalLevel, attributes: [] };
        collectedData.push(entry);
    }

    const existingAttr = entry.attributes.find(a => a.name === attrName);
    if (existingAttr) {
        showMessageBox('Attribute with this name already exists for this path.', true);
        return;
    }

    entry.attributes.push({
        name: attrName,
        standardValues: standardValues,
        mandatory: mandatory,
        isManualEntry: isManualEntry
    });

    // Reset form
    attributeNameInput.value = '';
    mandatoryCheckbox.checked = false;
    document.getElementById('manual-entry-checkbox').checked = false;

    // Reset standard values section
    attributeStandardValuesContainer.innerHTML = `
        <div class="flex space-x-2 items-center standard-value-row">
            <input type="text" class="attribute-value-name-input flex-1 px-3 py-2 text-base border-gray-300 rounded-md shadow-sm" placeholder="Value Name">
            <select class="attribute-value-unit-select w-32 px-3 py-2 text-base border-gray-300 rounded-md shadow-sm">
                <option value="">UOM</option>
            </select>
            <button class="remove-value-btn px-2 py-1 bg-red-500 text-white rounded-md hover:bg-red-600 text-sm hidden" onclick="removeStandardValue(this)">Remove</button>
        </div>
    `;
    updateUOMSelects();
    updateRemoveButtons();
    
    // Reset the standard values section visibility
    toggleStandardValuesSection();

    updateCollectedDataDisplay();
    showMessageBox('Attribute added successfully!');
}
// =========================================================
        // NEW: REJECTED PROJECT MODIFICATION
        // =========================================================

       async function modifyRejectedProject(projectId) {
    try {
        // For rejected projects, use the edit modal
        await openEditProjectModal(projectId);
        
        // Add special styling and messaging for rejected projects
        const modal = document.getElementById('edit-project-modal');
        const title = modal.querySelector('h3');
        
        if (currentUser.role !== 'admin') {
            title.innerHTML = 'Modify Rejected Project <span class="text-red-600 text-sm">(Make changes and resubmit)</span>';
            
            // Show comments in the modal if they exist
            const project = editingProjectData.project;
            if (project.reviewer_comments || project.admin_comments) {
                let commentsHTML = '<div class="mb-4 p-3 bg-red-50 border border-red-200 rounded-md">';
                commentsHTML += '<h4 class="font-medium text-red-800 mb-2">Review Comments:</h4>';
                
                if (project.reviewer_comments) {
                    commentsHTML += `<p class="text-sm text-red-700 mb-2"><strong>Reviewer:</strong> ${project.reviewer_comments}</p>`;
                }
                if (project.admin_comments) {
                    commentsHTML += `<p class="text-sm text-red-700"><strong>Admin:</strong> ${project.admin_comments}</p>`;
                }
                commentsHTML += '</div>';
                
                // Insert comments at the top of the modal content
                const modalContent = modal.querySelector('.space-y-6');
                modalContent.insertAdjacentHTML('afterbegin', commentsHTML);
            }
            
            // Show submit button for rejected projects
            const submitBtn = document.getElementById('edit-modal-submit-btn');
            if (submitBtn) {
                submitBtn.style.display = 'inline-block';
                submitBtn.textContent = 'Resubmit for Review';
            }
            
            // Enable the reviewer selection for resubmission
            const reviewerSection = document.getElementById('edit-modal-reviewer-selection');
            if (reviewerSection) {
                reviewerSection.style.display = 'block';
                await loadEditModalReviewers();
            }
        } else {
            title.innerHTML = 'Admin Edit Project <span class="text-purple-600 text-sm">(Admin Modification)</span>';
        }
        
    } catch (error) {
        console.error('Error loading project for modification:', error);
        showMessageBox(`Failed to load project: ${error.message}`, true);
    }
}      

function updateCollectedDataDisplay() {
    if (collectedData.length === 0) {
        collectedDataSection.style.display = 'none';
        actionButtonsSection.style.display = 'none';
        return;
    }

    collectedDataSection.style.display = 'block';
    actionButtonsSection.style.display = 'block';

    let html = '';
    collectedData.forEach((entry, entryIndex) => {
        html += `
            <div class="mb-6 p-4 border border-gray-200 rounded-lg bg-white">
                <div class="mb-3">
                    <h5 class="font-medium text-gray-900">CSI Path:</h5>
                    <p class="text-sm text-gray-600">${entry.division} √É∆í√Ü‚Äô√É‚Ä†√¢‚Ç¨‚Ñ¢√É∆í√¢‚Ç¨¬†√É¬¢√¢‚Äö¬¨√¢‚Äû¬¢√É∆í√Ü‚Äô√É¬¢√¢‚Äö¬¨√Ö¬°√É∆í√¢‚Ç¨≈°√É‚Äö√Ç¬¢√É∆í√Ü‚Äô√É‚Ä†√¢‚Ç¨‚Ñ¢√É∆í√¢‚Ç¨≈°√É‚Äö√Ç¬¢√É∆í√Ü‚Äô√É‚Äö√Ç¬¢√É∆í√Ç¬¢√É¬¢√¢‚Ç¨≈°√Ç¬¨√É‚Ä¶√Ç¬°√É∆í√¢‚Ç¨≈°√É‚Äö√Ç¬¨√É∆í√Ü‚Äô√É¬¢√¢‚Äö¬¨√Ö¬°√É∆í√¢‚Ç¨≈°√É‚Äö√Ç¬†√É∆í√Ü‚Äô√É‚Ä†√¢‚Ç¨‚Ñ¢√É∆í√¢‚Ç¨≈°√É‚Äö√Ç¬¢√É∆í√Ü‚Äô√É‚Äö√Ç¬¢√É∆í√Ç¬¢√É¬¢√¢‚Ç¨≈°√Ç¬¨√É‚Ä¶√Ç¬°√É∆í√¢‚Ç¨≈°√É‚Äö√Ç¬¨√É∆í√Ü‚Äô√É‚Äö√Ç¬¢√É∆í√Ç¬¢√É¬¢√¢‚Ç¨≈°√Ç¬¨√É‚Ä¶√Ç¬æ√É∆í√¢‚Ç¨≈°√É‚Äö√Ç¬¢ ${entry.section} √É∆í√Ü‚Äô√É‚Ä†√¢‚Ç¨‚Ñ¢√É∆í√¢‚Ç¨¬†√É¬¢√¢‚Äö¬¨√¢‚Äû¬¢√É∆í√Ü‚Äô√É¬¢√¢‚Äö¬¨√Ö¬°√É∆í√¢‚Ç¨≈°√É‚Äö√Ç¬¢√É∆í√Ü‚Äô√É‚Ä†√¢‚Ç¨‚Ñ¢√É∆í√¢‚Ç¨≈°√É‚Äö√Ç¬¢√É∆í√Ü‚Äô√É‚Äö√Ç¬¢√É∆í√Ç¬¢√É¬¢√¢‚Ç¨≈°√Ç¬¨√É‚Ä¶√Ç¬°√É∆í√¢‚Ç¨≈°√É‚Äö√Ç¬¨√É∆í√Ü‚Äô√É¬¢√¢‚Äö¬¨√Ö¬°√É∆í√¢‚Ç¨≈°√É‚Äö√Ç¬†√É∆í√Ü‚Äô√É‚Ä†√¢‚Ç¨‚Ñ¢√É∆í√¢‚Ç¨≈°√É‚Äö√Ç¬¢√É∆í√Ü‚Äô√É‚Äö√Ç¬¢√É∆í√Ç¬¢√É¬¢√¢‚Ç¨≈°√Ç¬¨√É‚Ä¶√Ç¬°√É∆í√¢‚Ç¨≈°√É‚Äö√Ç¬¨√É∆í√Ü‚Äô√É‚Äö√Ç¬¢√É∆í√Ç¬¢√É¬¢√¢‚Ç¨≈°√Ç¬¨√É‚Ä¶√Ç¬æ√É∆í√¢‚Ç¨≈°√É‚Äö√Ç¬¢ ${entry.subsection} √É∆í√Ü‚Äô√É‚Ä†√¢‚Ç¨‚Ñ¢√É∆í√¢‚Ç¨¬†√É¬¢√¢‚Äö¬¨√¢‚Äû¬¢√É∆í√Ü‚Äô√É¬¢√¢‚Äö¬¨√Ö¬°√É∆í√¢‚Ç¨≈°√É‚Äö√Ç¬¢√É∆í√Ü‚Äô√É‚Ä†√¢‚Ç¨‚Ñ¢√É∆í√¢‚Ç¨≈°√É‚Äö√Ç¬¢√É∆í√Ü‚Äô√É‚Äö√Ç¬¢√É∆í√Ç¬¢√É¬¢√¢‚Ç¨≈°√Ç¬¨√É‚Ä¶√Ç¬°√É∆í√¢‚Ç¨≈°√É‚Äö√Ç¬¨√É∆í√Ü‚Äô√É¬¢√¢‚Äö¬¨√Ö¬°√É∆í√¢‚Ç¨≈°√É‚Äö√Ç¬†√É∆í√Ü‚Äô√É‚Ä†√¢‚Ç¨‚Ñ¢√É∆í√¢‚Ç¨≈°√É‚Äö√Ç¬¢√É∆í√Ü‚Äô√É‚Äö√Ç¬¢√É∆í√Ç¬¢√É¬¢√¢‚Ç¨≈°√Ç¬¨√É‚Ä¶√Ç¬°√É∆í√¢‚Ç¨≈°√É‚Äö√Ç¬¨√É∆í√Ü‚Äô√É‚Äö√Ç¬¢√É∆í√Ç¬¢√É¬¢√¢‚Ç¨≈°√Ç¬¨√É‚Ä¶√Ç¬æ√É∆í√¢‚Ç¨≈°√É‚Äö√Ç¬¢ ${entry.item}</p>
                   ${entry.additionalLevel ? `<p class="text-sm text-gray-600">Additional Level: ${entry.additionalLevel.name} > ${entry.additionalLevel.value}</p>` : ''}
                </div>
                <div class="space-y-2">
                    <h6 class="font-medium text-gray-900">Attributes:</h6>
                    ${entry.attributes.map((attr, attrIndex) => `
                        <div class="flex items-center justify-between p-2 bg-gray-50 rounded">
                            <div>
                                <span class="font-medium">${attr.name}</span>
                                ${attr.mandatory ? '<span class="ml-2 text-xs bg-red-100 text-red-800 px-2 py-1 rounded">Mandatory</span>' : ''}
                                ${attr.isManualEntry ? '<span class="ml-2 text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded">Manual Entry</span>' : ''}
                                <div class="text-sm text-gray-600">
                                    ${attr.isManualEntry ? 
                                        '<span class="text-blue-600 font-semibold">[Manual Entry Field]</span> - Users will input values freely' : 
                                        `Values: ${attr.standardValues.map(v => {
                                            const unitText = v.unit ? ` (${v.unit})` : '';
                                            return `${v.name}${unitText}`;
                                        }).join(', ')}`
                                    }
                                </div>
                            </div>
                            <div class="flex space-x-2">
                                <button onclick="window.editAttribute(${entryIndex}, ${attrIndex})" class="text-blue-600 hover:text-blue-800">
                                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                        <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z"></path>
                                    </svg>
                                </button>
                                <button onclick="window.removeAttribute(${entryIndex}, ${attrIndex})" class="text-red-600 hover:text-red-800">
                                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
    });

    collectedDataDisplay.innerHTML = html;
}
function removeAttribute(entryIndex, attrIndex) {
    console.log('Removing attribute:', entryIndex, attrIndex);
    
    if (collectedData[entryIndex] && collectedData[entryIndex].attributes[attrIndex]) {
        collectedData[entryIndex].attributes.splice(attrIndex, 1);

        // Remove entry if no attributes left
        if (collectedData[entryIndex].attributes.length === 0) {
            collectedData.splice(entryIndex, 1);
        }

        // Mark as modified if this is a loaded draft
        if (loadedDraftProject) {
            loadedDraftProject.modified = true;
        }

        updateCollectedDataDisplay();
        showMessageBox('Attribute removed.');
    } else {
        console.error('Invalid attribute indices:', entryIndex, attrIndex);
        showMessageBox('Error removing attribute.', true);
    }
}
        // =========================================================
        // FOREIGN KEY HELPER FUNCTION
        // =========================================================

        async function getOrCreateAdditionalLevelValueId(additionalLevel, divisionCode, sectionCode, detailedSectionCode, itemCode) {
            if (!additionalLevel || !additionalLevel.name || !additionalLevel.value) {
                return null;
            }
            
            try {
                // First, get or create the additional level
                const { data: levelData, error: levelError } = await supabase.rpc('create_or_get_additional_level', {
                    level_name_param: additionalLevel.name,
                    division_code_param: divisionCode,
                    section_code_param: sectionCode,
                    detailed_section_code_param: detailedSectionCode,
                    item_code_param: itemCode
                });

                if (levelError || !levelData?.success) {
                    console.error('Error with additional level:', levelError || levelData?.message);
                    return null;
                }

                // Then, get or create the additional level value
                const { data: valueData, error: valueError } = await supabase.rpc('save_additional_level_value', {
                    additional_level_id_param: levelData.level_id,
                    value_name_param: additionalLevel.value
                });

                if (valueError) {
                    // If it fails because value already exists, try to get the existing value
                    const { data: existingValues } = await supabase.rpc('get_additional_level_values', {
                        additional_level_id_param: levelData.level_id
                    });
                    const existingValue = existingValues?.find(v => v.value_name === additionalLevel.value);
                    return existingValue ? existingValue.id : null;
                }

                return valueData?.value_id || null;
                
            } catch (error) {
                console.error('Error in getOrCreateAdditionalLevelValueId:', error);
                return null;
            }
        }

        // =========================================================
        // PROJECT MANAGEMENT FUNCTIONS (ENHANCED WITH DRAFT UPDATE)
        // =========================================================

        async function saveProjectAsDraft() {
    if (collectedData.length === 0) {
        showMessageBox('No attributes to save.', true);
        return;
    }

    try {
        showLoadingScreen('Saving your project...', 'Please wait');
        
        // Extract codes from display strings
        const { division, section, subsection, item, additionalLevel } = getSelectedPath();

        if (!division || !section || !subsection || !item) {
            hideLoadingScreen();
            showMessageBox('Please select a complete CSI hierarchy path.', true);
            return;
        }

        const divisionCode = division.split(' - ')[0];
        const divisionDescription = division.split(' - ')[1] || '';
        const sectionCode = section.split(' - ')[0];
        const sectionDescription = section.split(' - ')[1] || '';
        const detailedSectionCode = subsection.split(' - ')[0];
        const detailedSectionDescription = subsection.split(' - ')[1] || '';
        const itemCode = item.split(' - ')[0];
        const itemDescription = item.split(' - ')[1] || '';

        // Prepare attributes
        const attributes = [];
        collectedData.forEach(entry => {
            entry.attributes.forEach(attr => {
                attributes.push({
                    name: attr.name,
                    standardValues: attr.standardValues,
                    isMandatory: attr.mandatory,
                    isManualEntry: attr.isManualEntry || false
                });
            });
        });

        // If updating existing draft or rejected project
        if (loadedDraftProject) {
            updateLoadingMessage('Updating existing project...');
            
            // Delete existing attributes
            await supabase
                .from('project_attributes')
                .delete()
                .eq('project_id', loadedDraftProject.id);

            // Get FK for additional level value
            const additionalLevelValueId = await getOrCreateAdditionalLevelValueId(
                additionalLevel, divisionCode, sectionCode, detailedSectionCode, itemCode
            );

            // Update project - reset to draft if it was rejected, admin approved if admin
            const updateData = {
                division_code: divisionCode,
                division_description: divisionDescription,
                section_code: sectionCode,
                section_description: sectionDescription,
                detailed_section_code: detailedSectionCode,
                detailed_section_description: detailedSectionDescription,
                item_code: itemCode,
                item_description: itemDescription,
                additional_level_name: additionalLevel ? additionalLevel.name : null,
                additional_level_value: additionalLevel ? additionalLevel.value : null,
                additional_level_value_id: additionalLevelValueId,
                updated_at: new Date().toISOString()
            };

            // Admin saves as approved directly, others save as draft
            if (currentUser.role === 'admin') {
                updateData.status = 'admin_approved';
                updateData.admin_id = currentUser.id;
                updateData.admin_reviewed_at = new Date().toISOString();
                updateData.admin_comments = 'Admin created/modified project';
            } else if (loadedDraftProject.wasRejected && currentUser.role !== 'admin') {
                updateData.status = 'draft';
                updateData.reviewer_comments = null;
                updateData.reviewed_at = null;
                updateData.assigned_reviewer_id = null;
                updateData.submitted_at = null;
            }

            const { error: updateError } = await supabase
                .from('classification_projects')
                .update(updateData)
                .eq('id', loadedDraftProject.id);

            if (updateError) throw updateError;

            // Save new attributes
            updateLoadingMessage('Saving attributes...');
            for (const attr of attributes) {
                await supabase
                    .from('project_attributes')
                    .insert({
                        project_id: loadedDraftProject.id,
                        attribute_name: attr.name,
                        standard_values: attr.standardValues,
                        is_mandatory: attr.isMandatory,
                        is_manual_entry: attr.isManualEntry
                    });
            }

            hideLoadingScreen();
            if (currentUser.role === 'admin') {
                showMessageBox('Project saved and approved successfully! (Admin bypass)');
            } else if (loadedDraftProject.wasRejected) {
                showMessageBox('Rejected project has been modified and saved as draft. You can now resubmit it for review.');

                // Remove reviewer comments section if exists
                const commentsSection = document.getElementById('reviewer-comments-section');
                if (commentsSection) {
                    commentsSection.remove();
                }

                // Update draft info display
                draftName.textContent = loadedDraftProject.project_name;
                loadedDraftProject.wasRejected = false;
            } else {
                showMessageBox('Draft updated successfully!');
            }
        } else {
            // Create new project
            updateLoadingMessage('Creating new project...');
            
            // Generate user-friendly project name based on lowest CSI level + additional level
            let projectName;
            if (additionalLevel && additionalLevel.value) {
                // Use item description + additional level value
                const itemDescription = item.split(' - ')[1] || itemCode;
                projectName = `${itemDescription} - ${additionalLevel.value}`;
            } else {
                // Use item description only
                const itemDescription = item.split(' - ')[1] || itemCode;
                projectName = itemDescription;
            }
            
            console.log('Creating new project:', projectName);
            
            // Admin projects are created as approved directly
            const projectStatus = currentUser.role === 'admin' ? 'admin_approved' : 'draft';
            
            // Get FK for additional level value
            const additionalLevelValueId = await getOrCreateAdditionalLevelValueId(
                additionalLevel, divisionCode, sectionCode, detailedSectionCode, itemCode
            );
            
            // Direct insert to database
            const insertData = {
                project_name: projectName,
                division_code: divisionCode,
                division_description: divisionDescription,
                section_code: sectionCode,
                section_description: sectionDescription,
                detailed_section_code: detailedSectionCode,
                detailed_section_description: detailedSectionDescription,
                item_code: itemCode,
                item_description: itemDescription,
                created_by: currentUser.id,
                additional_level_name: additionalLevel ? additionalLevel.name : null,
                additional_level_value: additionalLevel ? additionalLevel.value : null,
                additional_level_value_id: additionalLevelValueId,
                status: projectStatus
            };

            // Add admin review fields if admin
            if (currentUser.role === 'admin') {
                insertData.admin_id = currentUser.id;
                insertData.admin_reviewed_at = new Date().toISOString();
                insertData.admin_comments = 'Admin created project';
            }

            const { data: projectInsert, error: insertError } = await supabase
                .from('classification_projects')
                .insert(insertData)
                .select()
                .single();
            
            if (insertError) {
                console.error('Insert error:', insertError);
                hideLoadingScreen();
                throw insertError;
            }
            
            // Save attributes
            if (projectInsert) {
                updateLoadingMessage('Saving attributes...');
                for (const attr of attributes) {
                    const { error: attrError } = await supabase
                        .from('project_attributes')
                        .insert({
                            project_id: projectInsert.id,
                            attribute_name: attr.name,
                            standard_values: attr.standardValues,
                            is_mandatory: attr.isMandatory,
                            is_manual_entry: attr.isManualEntry
                        });
                    
                    if (attrError) {
                        console.error('Attribute insert error:', attrError);
                    }
                }
                
                // Set currentProject for later reference
                currentProject = projectInsert;
                
                hideLoadingScreen();
                if (currentUser.role === 'admin') {
                    showMessageBox(`Project "${projectName}" created and approved successfully! (Admin bypass)`);
                } else {
                    showMessageBox(`Project "${projectName}" saved as draft successfully!`);
                }
            }
        }
    } catch (error) {
        hideLoadingScreen();
        console.error('Error saving project:', error);
        showMessageBox(`Failed to save project: ${error.message}`, true);
    }
}      
function getStatusIcon(status) {
    const icons = {
        'draft': `<svg class="w-3 h-3 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
        </svg>`,
        'submitted': `<svg class="w-3 h-3 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
        </svg>`,
        'reviewer_approved': `<svg class="w-3 h-3 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
        </svg>`,
        'reviewer_rejected': `<svg class="w-3 h-3 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
        </svg>`,
        'admin_approved': `<svg class="w-3 h-3 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
        </svg>`,
        'admin_rejected': `<svg class="w-3 h-3 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
        </svg>`
    };
    return icons[status] || icons['draft'];
}

async function loadUserProjects() {
    try {
        const projectsList = document.getElementById('projects-list');
        showLoadingScreen('Loading your projects...', 'Fetching Data');

        // Single optimized query with joins to get all data at once
        const { data: projects, error } = await supabase
            .from('classification_projects')
            .select(`
                *,
                creator:users!classification_projects_created_by_fkey(username),
                reviewer:users!classification_projects_assigned_reviewer_id_fkey(username),
                project_attributes(count)
            `)
            .or(`created_by.eq.${currentUser.id},assigned_reviewer_id.eq.${currentUser.id}${currentUser.role === 'admin' ? ',id.gte.0' : ''}`)
            .order('created_at', { ascending: false });

        if (error) {
            console.error('Error loading projects:', error);
            hideLoadingScreen();
            throw error;
        }

        const userId = parseInt(currentUser.id);
        
        if (projects && projects.length > 0) {
            let html = '<div class="space-y-4">';
            projects.forEach(project => {
                const statusColor = {
                    'draft': 'bg-gray-100 text-gray-800',
                    'submitted': 'bg-yellow-100 text-yellow-800',
                    'reviewer_approved': 'bg-blue-100 text-blue-800',
                    'reviewer_rejected': 'bg-orange-100 text-orange-800',
                    'admin_approved': 'bg-green-100 text-green-800',
                    'admin_rejected': 'bg-red-100 text-red-800'
                }[project.status] || 'bg-gray-100 text-gray-800';
                
                const statusText = {
                    'draft': 'DRAFT',
                    'submitted': 'PENDING REVIEW',
                    'reviewer_approved': 'PENDING ADMIN',
                    'reviewer_rejected': 'REVIEWER REJECTED',
                    'admin_approved': 'APPROVED',
                    'admin_rejected': 'ADMIN REJECTED'
                }[project.status] || project.status.toUpperCase();

                const isDraft = project.status === 'draft';
                const isCreator = parseInt(project.created_by) === userId;
                const isAdmin = currentUser.role === 'admin';
                const attributeCount = project.project_attributes?.[0]?.count || 0;
                
                let roleText = '';
                if (isAdmin) {
                    roleText = ' (Admin View)';
                } else if (isCreator) {
                    roleText = ' (Creator)';
                } else if (project.assigned_reviewer_id && parseInt(project.assigned_reviewer_id) === userId) {
                    roleText = ' (Reviewer)';
                }

                html += `
                    <div class="bg-white border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow duration-200">
                        <div class="flex flex-col lg:flex-row lg:items-center justify-between gap-4">
                            <!-- Main Content Area -->
                            <div class="flex-1 min-w-0">
                                <!-- Project Header -->
                                <div class="flex items-start justify-between mb-3">
                                    <div class="flex-1">
                                        <h4 class="text-lg font-medium text-gray-900 mb-1">${project.project_name}${roleText}</h4>
                                        <div class="flex items-center gap-2 text-sm text-gray-500">
                                            <span class="font-medium">Project ID:</span>
                                            <span class="font-mono bg-gray-100 px-2 py-1 rounded text-xs font-semibold text-gray-700">#${project.id}</span>
                                        </div>
                                    </div>
                                </div>

                                <!-- Enhanced CSI Path Display -->
                                <div class="mt-3">
                                    <p class="text-sm font-medium text-blue-600 mb-2">CSI Classification Path:</p>
                                    <div class="bg-blue-50 border border-blue-200 rounded-md p-3 mb-3">
                                        <div class="space-y-1 text-sm">
                                            <!-- Division -->
                                            <div class="flex items-start">
                                                <span class="inline-block w-20 font-mono text-blue-700 font-semibold">${project.division_code}</span>
                                                <span class="text-gray-700">${project.division_description || 'Division'}</span>
                                            </div>
                                            <!-- Section -->
                                            <div class="flex items-start ml-4">
                                                <span class="inline-block w-20 font-mono text-blue-600 font-medium">${project.section_code}</span>
                                                <span class="text-gray-600">${project.section_description || 'Section'}</span>
                                            </div>
                                            <!-- Detailed Section -->
                                            <div class="flex items-start ml-8">
                                                <span class="inline-block w-20 font-mono text-blue-500">${project.detailed_section_code}</span>
                                                <span class="text-gray-600">${project.detailed_section_description || 'Detailed Section'}</span>
                                            </div>
                                            <!-- Item -->
                                            <div class="flex items-start ml-12">
                                                <span class="inline-block w-20 font-mono text-blue-400 font-medium">${project.item_code}</span>
                                                <span class="text-gray-700 font-medium">${project.item_description || 'Item'}</span>
                                            </div>
                                            ${project.additional_level_name ? `
                                            <!-- Additional Level -->
                                            <div class="flex items-start ml-16 pt-1 border-t border-blue-200 mt-2">
                                                <span class="inline-block w-20 text-xs text-purple-600 font-medium">${project.additional_level_name}:</span>
                                                <span class="text-gray-700 text-xs font-medium">${project.additional_level_value}</span>
                                            </div>` : ''}
                                        </div>
                                    </div>
                                </div>
                                               
                                <!-- Enhanced Project Metadata with Icons -->
                                <div class="flex flex-wrap gap-3 text-sm text-gray-500">
                                    <span class="flex items-center">
                                        <svg class="w-4 h-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"></path>
                                        </svg>
                                        ${attributeCount} attribute${attributeCount !== 1 ? 's' : ''}
                                    </span>
                                    <span class="flex items-center">
                                        <svg class="w-4 h-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3a2 2 0 012-2h4a2 2 0 012 2v4m-6 0h6m-6 0l-2 13a2 2 0 002 2h8a2 2 0 002-2L16 7"></path>
                                        </svg>
                                        Created: ${new Date(project.created_at).toLocaleDateString()}
                                    </span>
                                    ${project.submitted_at ? `
                                    <span class="flex items-center">
                                        <svg class="w-4 h-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                                        </svg>
                                        Submitted: ${new Date(project.submitted_at).toLocaleDateString()}
                                    </span>` : ''}
                                    ${project.reviewed_at ? `
                                    <span class="flex items-center">
                                        <svg class="w-4 h-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        </svg>
                                        Reviewed: ${new Date(project.reviewed_at).toLocaleDateString()}
                                    </span>` : ''}
                                </div>

                                ${project.reviewer_comments ? `
                                <!-- Enhanced Review Comments -->
                                <div class="mt-3 p-3 bg-amber-50 border border-amber-200 rounded-md">
                                    <div class="flex items-start">
                                        <svg class="w-5 h-5 text-amber-600 mr-2 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 8h10m0 0V6a2 2 0 00-2-2H9a2 2 0 00-2 2v2m0 0v10a2 2 0 002 2h8a2 2 0 002-2V8"></path>
                                        </svg>
                                        <div>
                                            <div class="text-sm font-medium text-amber-800">Review Comments:</div>
                                            <div class="text-sm text-amber-700 mt-1">${project.reviewer_comments}</div>
                                        </div>
                                    </div>
                                </div>` : ''}
                            </div>

                            <!-- Actions Area -->
                            <div class="flex flex-col sm:flex-row items-center gap-3 lg:ml-6">
                                <!-- Action Buttons -->
                                <div class="flex items-center gap-2">
                                    <!-- Always show view button -->
                                    <button onclick="openViewProjectModal(${project.id})" 
                                            class="px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700 text-sm font-medium transition-colors duration-200 flex items-center">
                                        <svg class="w-4 h-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                                        </svg>
                                        View
                                    </button>

                                    ${((isDraft || project.status === 'reviewer_rejected' || project.status === 'admin_rejected') && isCreator) || isAdmin ? `
                                    <button onclick="openEditProjectModal(${project.id})" 
                                            class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 text-sm font-medium transition-colors duration-200 flex items-center">
                                        <svg class="w-4 h-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                        </svg>
                                        ${isAdmin ? 'Edit' : (isDraft ? 'Edit Draft' : 'Modify & Resubmit')}
                                    </button>` : ''}

                                    ${isAdmin && !isDraft ? `
                                    <button onclick="modifyRejectedProject(${project.id})" 
                                            class="px-4 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700 text-sm font-medium transition-colors duration-200 flex items-center">
                                        <svg class="w-4 h-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                        </svg>
                                        Admin Edit
                                    </button>` : ''}

                                    ${isAdmin ? `
                                    <button data-project-id="${project.id}" data-project-name="${project.project_name}" 
                                            class="delete-project-btn px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 text-sm font-medium transition-colors duration-200 flex items-center">
                                        <svg class="w-4 h-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                        </svg>
                                        Delete
                                    </button>` : ''}

                                    ${(isDraft && isCreator && !isAdmin) ? `
                                    <button data-project-id="${project.id}" data-project-name="${project.project_name}" 
                                            class="delete-project-btn px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 text-sm font-medium transition-colors duration-200 flex items-center">
                                        <svg class="w-4 h-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                        </svg>
                                        Delete Draft
                                    </button>` : ''}
                                </div>

                                <!-- Status Badge -->
                                <div class="flex items-center">
                                    <span class="inline-flex items-center px-3 py-1.5 rounded-full text-xs font-medium ${statusColor} border border-opacity-20">
                                        ${getStatusIcon(project.status)}
                                        ${statusText}
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            projectsList.innerHTML = html;
        } else {
            projectsList.innerHTML = '<div class="text-center text-gray-500 py-8">No projects found.</div>';
        }
        hideLoadingScreen();
        // Add event listeners for delete buttons
        setTimeout(() => {
            document.querySelectorAll('.delete-project-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const projectId = this.getAttribute('data-project-id');
                    const projectName = this.getAttribute('data-project-name');
                    console.log('Delete button clicked for project:', projectId, projectName);
                    deleteProject(parseInt(projectId), projectName);
                });
            });
        }, 100);
    } catch (error) {
        hideLoadingScreen();
        console.error('Error loading user projects:', error);
        const projectsList = document.getElementById('projects-list');
        projectsList.innerHTML = `<div class="text-center text-red-500 py-8">Failed to load projects. Error: ${error.message}</div>`;
    }
}


async function deleteProject(projectId) {
    if (!confirm('Are you sure you want to delete this project? This action cannot be undone.')) {
        return;
    }
    
    try {
        showLoadingScreen('Deleting project...', 'Please wait');
        
        let result;
        
        // Use appropriate deletion function based on user role
        if (currentUser.role === 'admin') {
            // Admin can delete any project using cascade function
            result = await supabase.rpc('delete_project_cascade', {
                project_id_param: projectId,
                admin_id_param: currentUser.id
            });
        } else {
            // Creator can only delete their own draft projects
            // First check if this is their draft project
            const { data: projectCheck, error: checkError } = await supabase
                .from('classification_projects')
                .select('created_by, status')
                .eq('id', projectId)
                .eq('created_by', currentUser.id)
                .eq('status', 'draft')
                .single();
                
            if (checkError) {
                throw new Error('Project not found or access denied');
            }
            
            if (!projectCheck) {
                throw new Error('You can only delete your own draft projects');
            }
            
            // For creators, delete related records first, then the project
            // Delete in the correct order to avoid foreign key constraints
            
            // 1. Delete review logs
            await supabase
                .from('review_logs')
                .delete()
                .eq('project_id', projectId);
                
            // 2. Delete project attributes
            await supabase
                .from('project_attributes')
                .delete()
                .eq('project_id', projectId);
                
            // 3. Delete the project itself
            const { error: deleteError } = await supabase
                .from('classification_projects')
                .delete()
                .eq('id', projectId)
                .eq('created_by', currentUser.id)
                .eq('status', 'draft');
                
            if (deleteError) {
                throw deleteError;
            }
            
            result = { data: { success: true }, error: null };
        }
        
        if (result.error) {
            throw result.error;
        }
        
        if (result.data && !result.data.success) {
            throw new Error(result.data.message || 'Failed to delete project');
        }
        
        hideLoadingScreen();
        showMessageBox('Project deleted successfully!');
        
        // Refresh the projects list
        if (typeof loadUserProjects === 'function') {
            await loadUserProjects();
        }
        
    } catch (error) {
        console.error('Error deleting project:', error);
        hideLoadingScreen();
        showMessageBox(`Failed to delete project: ${error.message}`, true);
    }
}
// =========================================================
// PROJECT EDITING MODAL
// =========================================================

let editingProjectData = null;

async function loadEditModalCSIHierarchy(project) {
    try {
        // Load divisions
        const { data: divisions } = await supabase.rpc('get_divisions');
        const divisionSelect = document.getElementById('edit-modal-division');
        divisionSelect.innerHTML = '<option value="">Select Division</option>';
        
        if (divisions) {
            divisions.forEach(div => {
                const option = document.createElement('option');
                option.value = `${div.division_code} - ${div.division_description}`;
                option.textContent = `${div.division_code} - ${div.division_description}`;
                divisionSelect.appendChild(option);
            });
        }
        
        // Set division and load sections
        const divisionValue = `${project.division_code} - ${await getDivisionDescription(project.division_code)}`;
        divisionSelect.value = divisionValue;

        // Load sections
        const { data: sections } = await supabase.rpc('get_sections', { division_code_param: project.division_code });
        const sectionSelect = document.getElementById('edit-modal-section');
        sectionSelect.innerHTML = '<option value="">Select Section</option>';
        sectionSelect.disabled = false;
        
        // Add division as section option for inheritance
        const divOption = document.createElement('option');
        divOption.value = divisionValue;
        divOption.textContent = `${divisionValue} (Inherited from Division)`;
        divOption.style.fontStyle = 'italic';
        divOption.style.color = '#6b7280';
        sectionSelect.appendChild(divOption);
        
        if (sections) {
            sections.forEach(sec => {
                const option = document.createElement('option');
                option.value = `${sec.section_code} - ${sec.section_description}`;
                option.textContent = `${sec.section_code} - ${sec.section_description}`;
                sectionSelect.appendChild(option);
            });
        }
        
        // Set section and load detailed sections
        const sectionValue = `${project.section_code} - ${await getSectionDescription(project.section_code)}`;
        sectionSelect.value = sectionValue;

        // Load detailed sections
        const { data: detailedSections } = await supabase.rpc('get_detailed_sections', {
            division_code_param: project.division_code,
            section_code_param: project.section_code
        });
        const subsectionSelect = document.getElementById('edit-modal-subsection');
        subsectionSelect.innerHTML = '<option value="">Select Detailed Section</option>';
        subsectionSelect.disabled = false;
        
        // Add section as detailed section option for inheritance
        const secOption = document.createElement('option');
        secOption.value = sectionValue;
        secOption.textContent = `${sectionValue} (Inherited from Section)`;
        secOption.style.fontStyle = 'italic';
        secOption.style.color = '#6b7280';
        subsectionSelect.appendChild(secOption);
        
        if (detailedSections) {
            detailedSections.forEach(sub => {
                const option = document.createElement('option');
                option.value = `${sub.detailed_section_code} - ${sub.detailed_section_description}`;
                option.textContent = `${sub.detailed_section_code} - ${sub.detailed_section_description}`;
                subsectionSelect.appendChild(option);
            });
        }
        
        // Set detailed section and load items
        const detailedSectionValue = `${project.detailed_section_code} - ${await getDetailedSectionDescription(project.detailed_section_code)}`;
        subsectionSelect.value = detailedSectionValue;

        // Load items
        const { data: items } = await supabase.rpc('get_items', {
            division_code_param: project.division_code,
            section_code_param: project.section_code,
            detailed_section_code_param: project.detailed_section_code
        });
        const itemSelect = document.getElementById('edit-modal-item');
        itemSelect.innerHTML = '<option value="">Select Item</option>';
        itemSelect.disabled = false;
        
        // Add detailed section as item option for inheritance
        const detOption = document.createElement('option');
        detOption.value = detailedSectionValue;
        detOption.textContent = `${detailedSectionValue} (Inherited from Detailed Section)`;
        detOption.style.fontStyle = 'italic';
        detOption.style.color = '#6b7280';
        itemSelect.appendChild(detOption);
        
        if (items) {
            items.forEach(item => {
                const option = document.createElement('option');
                option.value = `${item.item_code} - ${item.item_description}`;
                option.textContent = `${item.item_code} - ${item.item_description}`;
                itemSelect.appendChild(option);
            });
        }
        
        // Set item
        const itemValue = `${project.item_code} - ${await getItemDescription(project.item_code)}`;
        itemSelect.value = itemValue;

        // Load additional level if exists - ENABLE EDITING
        if (project.additional_level_name) {
            document.getElementById('edit-modal-level-name').value = project.additional_level_name;
            document.getElementById('edit-modal-level-name').readOnly = false;
            document.getElementById('edit-modal-level-name').classList.remove('bg-gray-100');
            
            const { data: levelValues } = await supabase.rpc('get_additional_level', {
                division_code_param: project.division_code,
                section_code_param: project.section_code,
                detailed_section_code_param: project.detailed_section_code,
                item_code_param: project.item_code
            });
            
            if (levelValues && levelValues.length > 0) {
                const { data: values } = await supabase.rpc('get_additional_level_values', {
                    additional_level_id_param: levelValues[0].id
                });
                
                const levelValueSelect = document.getElementById('edit-modal-level-value');
                levelValueSelect.innerHTML = '<option value="">Select value</option>';
                levelValueSelect.disabled = false;
                
                if (values) {
                    values.forEach(val => {
                        const option = document.createElement('option');
                        option.value = val.value_name;
                        option.textContent = val.value_name;
                        levelValueSelect.appendChild(option);
                    });
                }
                
                levelValueSelect.value = project.additional_level_value;
            }
        } else {
            // Auto-generate level name for new additional levels
const itemDescription = itemSelect.value.split(' - ')[1] || project.item_code;
document.getElementById('edit-modal-level-name').value = itemDescription; // Remove " Types" suffix
            document.getElementById('edit-modal-level-name').readOnly = false;
            document.getElementById('edit-modal-level-name').classList.remove('bg-gray-100');
            document.getElementById('edit-modal-level-value').disabled = false;
        }
        
        // Add new value input and button for additional levels
        if (!document.getElementById('edit-modal-new-value-input')) {
            const levelValueDiv = document.getElementById('edit-modal-level-value').parentElement;
            const newValueDiv = document.createElement('div');
            newValueDiv.className = 'mt-2';
            newValueDiv.innerHTML = `
                <label class="block text-sm font-medium text-gray-700 mb-1">Add New Value</label>
                <div class="flex space-x-2">
                    <input type="text" id="edit-modal-new-value-input" 
                           class="flex-1 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                           placeholder="Enter new value">
                    <button type="button" id="edit-modal-add-value-btn" 
                            class="px-3 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 text-sm">
                        Add
                    </button>
                </div>
            `;
            levelValueDiv.parentElement.appendChild(newValueDiv);
            
            // Add event listener for the new button
            document.getElementById('edit-modal-add-value-btn').addEventListener('click', async () => {
                const newValue = document.getElementById('edit-modal-new-value-input').value.trim();
                if (!newValue) {
                    showMessageBox('Please enter a value name.', true);
                    return;
                }
                
                const levelName = document.getElementById('edit-modal-level-name').value.trim();
                const divisionCode = document.getElementById('edit-modal-division').value.split(' - ')[0];
                const sectionCode = document.getElementById('edit-modal-section').value.split(' - ')[0];
                const detailedSectionCode = document.getElementById('edit-modal-subsection').value.split(' - ')[0];
                const itemCode = document.getElementById('edit-modal-item').value.split(' - ')[0];
                
                try {
                    // Create or get additional level
                    const { data: levelData, error: levelError } = await supabase.rpc('create_or_get_additional_level', {
                        level_name_param: levelName,
                        division_code_param: divisionCode,
                        section_code_param: sectionCode,
                        detailed_section_code_param: detailedSectionCode,
                        item_code_param: itemCode
                    });

                    if (levelError) throw levelError;

                    if (levelData && levelData.success) {
                        // Add value to the level
                        const { data, error } = await supabase.rpc('save_additional_level_value', {
                            additional_level_id_param: levelData.level_id,
                            value_name_param: newValue
                        });

                        if (error) throw error;

                        if (data && data.success) {
                            showMessageBox('Value added successfully');
                            document.getElementById('edit-modal-new-value-input').value = '';
                            
                            // Refresh the dropdown
                            const levelValueSelect = document.getElementById('edit-modal-level-value');
                            const option = document.createElement('option');
                            option.value = newValue;
                            option.textContent = newValue;
                            levelValueSelect.appendChild(option);
                            levelValueSelect.value = newValue;
                        }
                    }
                } catch (error) {
                    console.error('Error adding level value:', error);
                    showMessageBox(error.message || 'Failed to add level value.', true);
                }
            });
        }
    } catch (error) {
        console.error('Error loading CSI hierarchy:', error);
        showMessageBox('Failed to load CSI hierarchy data', true);
    }
}


async function loadEditModalCSIHierarchy(project) {
    try {
        // Load divisions
        const { data: divisions } = await supabase.rpc('get_divisions');
        const divisionSelect = document.getElementById('edit-modal-division');
        divisionSelect.innerHTML = '<option value="">Select Division</option>';
        
        if (divisions) {
            divisions.forEach(div => {
                const option = document.createElement('option');
                option.value = `${div.division_code} - ${div.division_description}`;
                option.textContent = `${div.division_code} - ${div.division_description}`;
                divisionSelect.appendChild(option);
            });
        }
        
        // Set division and load sections
        const divisionValue = `${project.division_code} - ${await getDivisionDescription(project.division_code)}`;
        divisionSelect.value = divisionValue;

        // Load sections
const { data: sections } = await supabase.rpc('get_sections', { division_code_param: project.division_code });
const sectionSelect = document.getElementById('edit-modal-section');
sectionSelect.innerHTML = '<option value="">Select Section</option>';
sectionSelect.disabled = false;

// Add division as section option for inheritance

const divOption = document.createElement('option');
divOption.value = divisionValue;
divOption.textContent = `${divisionValue} (Inherited from Division)`;
divOption.style.fontStyle = 'italic';
divOption.style.color = '#6b7280';
sectionSelect.appendChild(divOption);

if (sections) {
    sections.forEach(sec => {
        const option = document.createElement('option');
        option.value = `${sec.section_code} - ${sec.section_description}`;
        option.textContent = `${sec.section_code} - ${sec.section_description}`;
        sectionSelect.appendChild(option);
    });
}
        
        // Set section and load detailed sections
        const sectionValue = `${project.section_code} - ${await getSectionDescription(project.section_code)}`;
        sectionSelect.value = sectionValue;

        // Load detailed sections
        const { data: detailedSections } = await supabase.rpc('get_detailed_sections', {
            division_code_param: project.division_code,
            section_code_param: project.section_code
        });
        const subsectionSelect = document.getElementById('edit-modal-subsection');
        subsectionSelect.innerHTML = '<option value="">Select Detailed Section</option>';
        subsectionSelect.disabled = false;
        
        if (detailedSections) {
            detailedSections.forEach(sub => {
                const option = document.createElement('option');
                option.value = `${sub.detailed_section_code} - ${sub.detailed_section_description}`;
                option.textContent = `${sub.detailed_section_code} - ${sub.detailed_section_description}`;
                subsectionSelect.appendChild(option);
            });
        }
        
        // Set detailed section and load items
        const detailedSectionValue = `${project.detailed_section_code} - ${await getDetailedSectionDescription(project.detailed_section_code)}`;
        subsectionSelect.value = detailedSectionValue;

        // Load items
        const { data: items } = await supabase.rpc('get_items', {
            division_code_param: project.division_code,
            section_code_param: project.section_code,
            detailed_section_code_param: project.detailed_section_code
        });
        const itemSelect = document.getElementById('edit-modal-item');
        itemSelect.innerHTML = '<option value="">Select Item</option>';
        itemSelect.disabled = false;
        
        if (items) {
            items.forEach(item => {
                const option = document.createElement('option');
                option.value = `${item.item_code} - ${item.item_description}`;
                option.textContent = `${item.item_code} - ${item.item_description}`;
                itemSelect.appendChild(option);
            });
        }
        
        // Set item
        const itemValue = `${project.item_code} - ${await getItemDescription(project.item_code)}`;
        itemSelect.value = itemValue;

        // Load additional level if exists - ENABLE EDITING
        if (project.additional_level_name) {
            document.getElementById('edit-modal-level-name').value = project.additional_level_name;
            document.getElementById('edit-modal-level-name').readOnly = false;
            document.getElementById('edit-modal-level-name').classList.remove('bg-gray-100');
            
            const { data: levelValues } = await supabase.rpc('get_additional_level', {
                division_code_param: project.division_code,
                section_code_param: project.section_code,
                detailed_section_code_param: project.detailed_section_code,
                item_code_param: project.item_code
            });
            
            if (levelValues && levelValues.length > 0) {
                const { data: values } = await supabase.rpc('get_additional_level_values', {
                    additional_level_id_param: levelValues[0].id
                });
                
                const levelValueSelect = document.getElementById('edit-modal-level-value');
                levelValueSelect.innerHTML = '<option value="">Select value</option>';
                levelValueSelect.disabled = false;
                
                if (values) {
                    values.forEach(val => {
                        const option = document.createElement('option');
                        option.value = val.value_name;
                        option.textContent = val.value_name;
                        levelValueSelect.appendChild(option);
                    });
                }
                
                levelValueSelect.value = project.additional_level_value;
            }
        } else {
            // Auto-generate level name for new additional levels
            const itemDescription = itemSelect.value.split(' - ')[1] || project.item_code;
            document.getElementById('edit-modal-level-name').value = itemDescription;
            document.getElementById('edit-modal-level-name').readOnly = false;
            document.getElementById('edit-modal-level-name').classList.remove('bg-gray-100');
            document.getElementById('edit-modal-level-value').disabled = false;
        }
        
        // Add new value input and button for additional levels
        if (!document.getElementById('edit-modal-new-value-input')) {
            const levelValueDiv = document.getElementById('edit-modal-level-value').parentElement;
            const newValueDiv = document.createElement('div');
            newValueDiv.className = 'mt-2';
            newValueDiv.innerHTML = `
                <label class="block text-sm font-medium text-gray-700 mb-1">Add New Value</label>
                <div class="flex space-x-2">
                    <input type="text" id="edit-modal-new-value-input" 
                           class="flex-1 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                           placeholder="Enter new value">
                    <button type="button" id="edit-modal-add-value-btn" 
                            class="px-3 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 text-sm">
                        Add
                    </button>
                </div>
            `;
            levelValueDiv.parentElement.appendChild(newValueDiv);
            
            // Add event listener for the new button
            document.getElementById('edit-modal-add-value-btn').addEventListener('click', async () => {
                const newValue = document.getElementById('edit-modal-new-value-input').value.trim();
                if (!newValue) {
                    showMessageBox('Please enter a value name.', true);
                    return;
                }
                
                const levelName = document.getElementById('edit-modal-level-name').value.trim();
                const divisionCode = document.getElementById('edit-modal-division').value.split(' - ')[0];
                const sectionCode = document.getElementById('edit-modal-section').value.split(' - ')[0];
                const detailedSectionCode = document.getElementById('edit-modal-subsection').value.split(' - ')[0];
                const itemCode = document.getElementById('edit-modal-item').value.split(' - ')[0];
                
                try {
                    // Create or get additional level
                    const { data: levelData, error: levelError } = await supabase.rpc('create_or_get_additional_level', {
                        level_name_param: levelName,
                        division_code_param: divisionCode,
                        section_code_param: sectionCode,
                        detailed_section_code_param: detailedSectionCode,
                        item_code_param: itemCode
                    });

                    if (levelError) throw levelError;

                    if (levelData && levelData.success) {
                        // Add value to the level
                        const { data, error } = await supabase.rpc('save_additional_level_value', {
                            additional_level_id_param: levelData.level_id,
                            value_name_param: newValue
                        });

                        if (error) throw error;

                        if (data && data.success) {
                            showMessageBox('Value added successfully');
                            document.getElementById('edit-modal-new-value-input').value = '';
                            
                            // Refresh the dropdown
                            const levelValueSelect = document.getElementById('edit-modal-level-value');
                            const option = document.createElement('option');
                            option.value = newValue;
                            option.textContent = newValue;
                            levelValueSelect.appendChild(option);
                            levelValueSelect.value = newValue;
                        }
                    }
                } catch (error) {
                    console.error('Error adding level value:', error);
                    showMessageBox(error.message || 'Failed to add level value.', true);
                }
            });
        }
    } catch (error) {
        console.error('Error loading CSI hierarchy:', error);
        showMessageBox('Failed to load CSI hierarchy data', true);
    }
}


function displayEditModalAttributes(attributes) {
    const container = document.getElementById('edit-project-attributes');
    container.innerHTML = '';

    attributes.forEach((attr, index) => {
        const attrDiv = document.createElement('div');
        attrDiv.className = 'p-3 bg-white border border-gray-200 rounded-md';
        attrDiv.innerHTML = `
            <div class="flex justify-between items-start">
                <div class="flex-1">
                    <div class="flex items-center gap-2 mb-2">
                        <div class="font-medium">${attr.attribute_name}</div>
                        ${attr.is_mandatory ? '<span class="text-xs bg-red-100 text-red-800 px-2 py-1 rounded">Mandatory</span>' : ''}
                        ${attr.is_manual_entry ? '<span class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded">Manual Entry</span>' : ''}
                    </div>
                    <div class="text-sm text-gray-600 mt-1">
                        ${attr.is_manual_entry ? 
                            '<span class="text-blue-600 font-semibold">[Manual Entry Field]</span> - Users input values freely' : 
                            `Values: ${attr.standard_values.map(v => v.unit ? `${v.name} (${v.unit})` : v.name).join(', ')}`
                        }
                    </div>
                </div>
                <div class="flex space-x-2 ml-2">
                    <button onclick="editProjectAttribute(${index})" class="text-blue-600 hover:text-blue-800">
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z"></path>
                        </svg>
                    </button>
                    <button onclick="removeProjectAttribute(${index})" class="text-red-600 hover:text-red-800">
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                        </svg>
                    </button>
                </div>
            </div>
        `;
        container.appendChild(attrDiv);
    });
}
function editProjectAttribute(index) {
    const attr = editingProjectData.attributes[index];
    editingAttribute = { projectEdit: true, index };
    
    document.getElementById('edit-attr-name').value = attr.attribute_name;
    document.getElementById('edit-mandatory-checkbox').checked = attr.is_mandatory;
    document.getElementById('edit-manual-entry-checkbox').checked = attr.is_manual_entry || false;
    
    const editValuesContainer = document.getElementById('edit-values-container');
    editValuesContainer.innerHTML = '';
    
    // Only show standard values if it's NOT a manual entry attribute
    if (!attr.is_manual_entry && attr.standard_values && attr.standard_values.length > 0) {
        attr.standard_values.forEach(value => {
            const row = document.createElement('div');
            row.className = 'flex space-x-2 items-center edit-value-row';
            row.innerHTML = `
                <input type="text" class="edit-value-name-input flex-1 px-3 py-2 text-base border-gray-300 rounded-md shadow-sm" placeholder="Value Name" value="${value.name}">
                <select class="edit-value-unit-select w-32 px-3 py-2 text-base border-gray-300 rounded-md shadow-sm">
                    <option value="">UOM</option>
                </select>
                <button class="remove-edit-value-btn px-2 py-1 bg-red-500 text-white rounded-md hover:bg-red-600 text-sm" onclick="removeEditStandardValue(this)">Remove</button>
            `;
            editValuesContainer.appendChild(row);
            
            const select = row.querySelector('.edit-value-unit-select');
            availableUOMs.forEach(uom => {
                const option = document.createElement('option');
                option.value = uom.uom_symbol || uom.uom_name;
                option.textContent = `${uom.uom_name} (${uom.uom_symbol || uom.uom_name})`;
                select.appendChild(option);
            });
            select.value = value.unit || '';
        });
    } else if (!attr.is_manual_entry) {
        // Add default row for non-manual entry attributes with no existing values
        const row = document.createElement('div');
        row.className = 'flex space-x-2 items-center edit-value-row';
        row.innerHTML = `
            <input type="text" class="edit-value-name-input flex-1 px-3 py-2 text-base border-gray-300 rounded-md shadow-sm" placeholder="Value Name">
            <select class="edit-value-unit-select w-32 px-3 py-2 text-base border-gray-300 rounded-md shadow-sm">
                <option value="">UOM</option>
            </select>
            <button class="remove-edit-value-btn px-2 py-1 bg-red-500 text-white rounded-md hover:bg-red-600 text-sm" onclick="removeEditStandardValue(this)">Remove</button>
        `;
        editValuesContainer.appendChild(row);

        const select = row.querySelector('.edit-value-unit-select');
        availableUOMs.forEach(uom => {
            const option = document.createElement('option');
            option.value = uom.uom_symbol || uom.uom_name;
            option.textContent = `${uom.uom_name} (${uom.uom_symbol || uom.uom_name})`;
            select.appendChild(option);
        });
    }

    updateEditRemoveButtons();
    
    // Set the UI state based on manual entry AFTER loading values
    toggleEditStandardValuesSection();
    
    showModal(document.getElementById('edit-attribute-modal'));
}
async function saveEditedProject() {
    try {
        if (!window.editingProjectData) {
            throw new Error('No project is currently being edited');
        }
        
        showLoadingScreen('Saving project changes...', 'Please wait');
        
        const project = window.editingProjectData.project;
        
        // Use the original project's CSI path (no changes allowed)
        const divisionCode = project.division_code;
        const sectionCode = project.section_code;
        const detailedSectionCode = project.detailed_section_code;
        const itemCode = project.item_code;
        const levelName = project.additional_level_name || null;
        const levelValue = project.additional_level_value || null;
        const projectName = document.getElementById('edit-project-name').value.trim();

        if (!projectName) {
            hideLoadingScreen();
            showMessageBox('Please enter a project name.', true);
            return;
        }
        
        // Collect attributes from the modal
        const attributes = [];
        document.querySelectorAll('#edit-project-attributes > div.border').forEach(attrDiv => {
            const nameInput = attrDiv.querySelector('.edit-attr-name');
            const name = nameInput ? nameInput.value.trim() : '';
            
            if (name) {
                const standardValues = [];
                attrDiv.querySelectorAll('.standard-value-item').forEach(valueDiv => {
                    const valueName = valueDiv.querySelector('.standard-value-name').value.trim();
                    const valueUnit = valueDiv.querySelector('.standard-value-unit').value.trim();
                    if (valueName) {
                        standardValues.push({
                            name: valueName,
                            unit: valueUnit || ''
                        });
                    }
                });
                
                const isMandatory = attrDiv.querySelector('.edit-attr-mandatory').checked;
                const isManualEntry = attrDiv.querySelector('.edit-attr-manual').checked;
                
                attributes.push({
                    attribute_name: name,
                    standard_values: standardValues,
                    is_mandatory: isMandatory,
                    is_manual_entry: isManualEntry
                });
            }
        });
        
        // Check path availability (excluding current project)
        const { data: pathCheck, error: pathError } = await supabase.rpc('check_project_path_availability', {
            division_code_param: divisionCode,
            section_code_param: sectionCode,
            detailed_section_code_param: detailedSectionCode,
            item_code_param: itemCode,
            additional_level_name_param: levelName || null,
            additional_level_value_param: levelValue || null,
            exclude_project_id_param: project.id
        });
        
        if (pathError) throw pathError;
        
        if (!pathCheck.available) {
            hideLoadingScreen();
            const confirmMessage = `${pathCheck.message}\n\nExisting projects found:\n${
                pathCheck.existing_projects ? pathCheck.existing_projects.map(p => 
                    `- ${p.project_name} (${p.status})`
                ).join('\n') : ''
            }\n\nDo you want to continue anyway?`;
            
            if (!confirm(confirmMessage)) {
                return; // User cancelled
            }
            showLoadingScreen('Saving project changes...', 'Please wait');
        }
        
        // Update project using appropriate function based on user role
        let data, error;
        if (currentUser.role === 'admin') {
            const result = await supabase.rpc('admin_update_project', {
                project_id_param: project.id,
                admin_id_param: currentUser.id,
                project_name_param: projectName,
                division_code_param: divisionCode,
                section_code_param: sectionCode,
                detailed_section_code_param: detailedSectionCode,
                item_code_param: itemCode,
                additional_level_name_param: levelName || null,
                additional_level_value_param: levelValue || null,
                attributes_param: attributes,
                division_description_param: project.division_description || '',
                section_description_param: project.section_description || '',
                detailed_section_description_param: project.detailed_section_description || '',
                item_description_param: project.item_description || ''
            });
            data = result.data;
            error = result.error;
        } else {
            const result = await supabase.rpc('update_project', {
                project_id_param: project.id,
                user_id_param: currentUser.id,
                project_name_param: projectName,
                division_code_param: divisionCode,
                section_code_param: sectionCode,
                detailed_section_code_param: detailedSectionCode,
                item_code_param: itemCode,
                additional_level_name_param: levelName || null,
                additional_level_value_param: levelValue || null,
                attributes_param: attributes,
                division_description_param: project.division_description || '',
                section_description_param: project.section_description || '',
                detailed_section_description_param: project.detailed_section_description || '',
                item_description_param: project.item_description || ''
            });
            data = result.data;
            error = result.error;
        }
        
        if (error) throw error;
        
        if (!data.success) {
            throw new Error(data.message);
        }
        
        hideLoadingScreen();
        hideModal(document.getElementById('edit-project-modal'));
        showMessageBox('Project updated successfully!');
        
        // Refresh projects list
        if (typeof loadUserProjects === 'function') {
            await loadUserProjects();
        }
        
        
       // window.editingProjectData = null;
        
    } catch (error) {
        console.error('Error saving project:', error);
        hideLoadingScreen();
        showMessageBox(`Failed to save project: ${error.message}`, true);
    }
}

async function submitProjectForReview() {
    // Admin bypass - admins don't need to submit for review
    if (currentUser.role === 'admin') {
        showMessageBox('Admin users don\'t need to submit for review. Projects are automatically approved when saved.', false);
        return;
    }

    if (collectedData.length === 0) {
        showMessageBox('No attributes to submit.', true);
        return;
    }
    
    try {
        console.log('Starting submission process...');
        console.log('Current Project:', currentProject);
        console.log('Loaded Draft:', loadedDraftProject);
        
        // Check if this is a modified rejected project that needs saving first
        if (loadedDraftProject && loadedDraftProject.wasRejected) {
            console.log('Modified rejected project detected, saving changes first...');
            await saveProjectAsDraft();
            // Wait for save to complete
            await new Promise(resolve => setTimeout(resolve, 1000));
        }
        // Check if we have unsaved new data that needs to be saved first
        else if (!currentProject && !loadedDraftProject) {
            console.log('No saved project, saving as draft first...');
            await saveProjectAsDraft();
            // Wait for save to complete
            await new Promise(resolve => setTimeout(resolve, 1000));
        }
        
        const projectId = currentProject?.id || loadedDraftProject?.id;
        console.log('Project ID for submission:', projectId);
        
        if (!projectId) {
            throw new Error('No project ID available for submission');
        }
        
        // Load reviewers
        console.log('Loading reviewers...');
        await loadReviewers();
        
        // Check if reviewer selection element exists
        if (!reviewerSelection) {
            console.error('Reviewer selection element not found!');
            throw new Error('Reviewer selection element not found');
        }
        
        // Check if reviewers were loaded
        const reviewerOptions = reviewerSelect.options.length;
        console.log('Number of reviewer options:', reviewerOptions);
        
        if (reviewerOptions <= 1) {
            showMessageBox('No reviewers available. Please contact administrator.', true);
            return;
        }
        
        // Show reviewer selection
        console.log('Showing reviewer selection dropdown...');
        reviewerSelection.style.display = 'block';
        
    } catch (error) {
        console.error('Error in submitProjectForReview:', error);
        showMessageBox('Failed to prepare project for review: ' + error.message, true);
    }
}
async function confirmSubmission() {
    const reviewerId = reviewerSelect.value;
    if (!reviewerId) {
        showMessageBox('Please select a reviewer.', true);
        return;
    }

    try {
        showLoadingScreen('Submitting project for review...', 'Please wait');
        
        const projectId = currentProject?.id || loadedDraftProject?.id;
        
        if (!projectId) {
            hideLoadingScreen();
            showMessageBox('No project found to submit.', true);
            return;
        }
        
        const { data, error } = await supabase.rpc('submit_project_for_review', {
            project_id_param: projectId,
            reviewer_id_param: parseInt(reviewerId)
        });

        if (error) throw error;

        if (data && data.success) {
            // Send email notification to reviewer
            const projectName = currentProject?.project_name || loadedDraftProject?.project_name || 'Unnamed Project';
            const notificationResult = await notifyReviewerOnSubmission(projectId, projectName);
            
            hideLoadingScreen();
            
            if (notificationResult) {
                showMessageBox('Project submitted for review successfully! Email notification sent to reviewer.');
            } else {
                showMessageBox('Project submitted for review successfully! However, email notification to reviewer failed.');
            }
            
            reviewerSelection.style.display = 'none';

          // Clear current project and data
            currentProject = null;
            loadedDraftProject = null;
            collectedData = [];
            editingProjectData = null;
            draftInfo.style.display = 'none';
            
            // Reset CSI hierarchy form
            divisionSelect.value = '';
            sectionSelect.innerHTML = '<option value="">Select Section</option>';
            sectionSelect.disabled = true;
            subsectionSelect.innerHTML = '<option value="">Select Detailed Section</option>';
            subsectionSelect.disabled = true;
            itemSelect.innerHTML = '<option value="">Select Item</option>';
            itemSelect.disabled = true;
            additionalLevelName.value = '';
            additionalLevelSelect.innerHTML = '<option value="">Select value</option>';
            
            // Reset attribute creation form
            attributeNameInput.value = '';
            mandatoryCheckbox.checked = false;
            document.getElementById('manual-entry-checkbox').checked = false;
            
            // Reset standard values section
            attributeStandardValuesContainer.innerHTML = `
                <div class="flex space-x-2 items-center standard-value-row">
                    <input type="text" class="attribute-value-name-input flex-1 px-3 py-2 text-base border-gray-300 rounded-md shadow-sm" placeholder="Value Name">
                    <select class="attribute-value-unit-select w-32 px-3 py-2 text-base border-gray-300 rounded-md shadow-sm">
                        <option value="">UOM</option>
                    </select>
                    <button class="remove-value-btn px-2 py-1 bg-red-500 text-white rounded-md hover:bg-red-600 text-sm hidden" onclick="removeStandardValue(this)">Remove</button>
                </div>
            `;
            updateUOMSelects();
            updateRemoveButtons();
            
            // Disable sections that require CSI selection
            attributeCreationSection.classList.add('disabled-section');
            additionalLevelsSection.classList.add('disabled-section');
            
            // Reset current path display
            renderCurrentPath();
            
            updateCollectedDataDisplay();
            
            // Refresh projects list if we're on that tab
            if (document.getElementById('content-projects').style.display !== 'none') {
                loadUserProjects();
            }
        } else {
            throw new Error(data?.message || 'Failed to submit project');
        }
    } catch (error) {
        hideLoadingScreen();
        console.error('Error submitting project:', error);
        showMessageBox(error.message || 'Failed to submit project.', true);
    }
}
        function cancelSubmission() {
            reviewerSelection.style.display = 'none';
        }

        function clearAllData() {
            if (confirm('Are you sure you want to clear all collected data? This action cannot be undone.')) {
                collectedData = [];
                currentProject = null;
                loadedDraftProject = null;
                draftInfo.style.display = 'none';
                updateCollectedDataDisplay();
                showMessageBox('All data cleared.');
            }
        }

        // =========================================================
        // REVIEWER MANAGEMENT (KEPT AS-IS)
        // =========================================================

        async function loadReviewers() {
    try {
        console.log('Loading reviewers from database...');
        const { data, error } = await supabase.rpc('get_reviewers');
        
        if (error) {
            console.error('Error calling get_reviewers RPC:', error);
            throw error;
        }
        
        console.log('Reviewers data received:', data);
        
        // Clear and populate reviewer select
        reviewerSelect.innerHTML = '<option value="">Select a reviewer</option>';
        
        if (data && Array.isArray(data) && data.length > 0) {
            data.forEach(reviewer => {
                const option = document.createElement('option');
                option.value = reviewer.user_id;
                option.textContent = `${reviewer.username} (${reviewer.email})`;
                reviewerSelect.appendChild(option);
                console.log('Added reviewer:', reviewer.username);
            });
            console.log(`Total reviewers loaded: ${data.length}`);
        } else {
            console.log('No reviewers found in database');
            showMessageBox('No reviewers found in the system. Please contact administrator.', true);
        }
    } catch (error) {
        console.error('Error loading reviewers:', error);
        showMessageBox('Failed to load reviewers: ' + error.message, true);
    }
}        // =========================================================
       async function populateReadOnlyCSIPath(project) {
    try {
        // Use stored project data directly, fallback to codes only if descriptions fail
        document.getElementById('edit-modal-division-display').value = `${project.division_code}`;
        document.getElementById('edit-modal-section-display').value = `${project.section_code}`;
        document.getElementById('edit-modal-subsection-display').value = `${project.detailed_section_code}`;
        document.getElementById('edit-modal-item-display').value = `${project.item_code}`;
        
        // Set additional level info
        if (project.additional_level_name) {
            document.getElementById('edit-modal-level-name-display').value = project.additional_level_name;
            document.getElementById('edit-modal-level-value-display').value = project.additional_level_value || '';
        } else {
            document.getElementById('edit-modal-level-name-display').value = '';
            document.getElementById('edit-modal-level-value-display').value = '';
        }
        
        // Try to get descriptions asynchronously (don't block if they fail)
        Promise.all([
            getDivisionDescription(project.division_code),
            getSectionDescription(project.section_code),
            getDetailedSectionDescription(project.detailed_section_code),
            getItemDescription(project.item_code)
        ]).then(([divDesc, secDesc, detailDesc, itemDesc]) => {
            document.getElementById('edit-modal-division-display').value = `${project.division_code} - ${divDesc}`;
            document.getElementById('edit-modal-section-display').value = `${project.section_code} - ${secDesc}`;
            document.getElementById('edit-modal-subsection-display').value = `${project.detailed_section_code} - ${detailDesc}`;
            document.getElementById('edit-modal-item-display').value = `${project.item_code} - ${itemDesc}`;
        }).catch(error => {
            console.log('CSI descriptions could not be loaded, using codes only');
        });
        
    } catch (error) {
        console.error('Error in populateReadOnlyCSIPath:', error);
        // Fallback to just codes if everything fails
        document.getElementById('edit-modal-division-display').value = project.division_code || '';
        document.getElementById('edit-modal-section-display').value = project.section_code || '';
        document.getElementById('edit-modal-subsection-display').value = project.detailed_section_code || '';
        document.getElementById('edit-modal-item-display').value = project.item_code || '';
        document.getElementById('edit-modal-level-name-display').value = project.additional_level_name || '';
        document.getElementById('edit-modal-level-value-display').value = project.additional_level_value || '';
    }
}

async function loadEditModalReviewers() {
    try {
        console.log('Loading reviewers for edit modal...');
        const { data, error } = await supabase.rpc('get_reviewers');
        
        if (error) {
            console.error('Error calling get_reviewers RPC:', error);
            throw error;
        }
        
        console.log('Reviewers data received:', data);
        
        // Clear and populate edit modal reviewer select
        const editReviewerSelect = document.getElementById('edit-modal-reviewer-select');
        if (editReviewerSelect) {
            editReviewerSelect.innerHTML = '<option value="">Select a reviewer</option>';
            
            if (data && Array.isArray(data) && data.length > 0) {
                data.forEach(reviewer => {
                    const option = document.createElement('option');
                    option.value = reviewer.user_id;
                    option.textContent = `${reviewer.username} (${reviewer.email})`;
                    editReviewerSelect.appendChild(option);
                });
                console.log(`Total reviewers loaded for edit modal: ${data.length}`);
            } else {
                console.log('No reviewers found in database');
                showMessageBox('No reviewers found in the system. Please contact administrator.', true);
            }
        }
    } catch (error) {
        console.error('Error loading reviewers for edit modal:', error);
        showMessageBox('Failed to load reviewers: ' + error.message, true);
    }
}
// Add event listeners for edit modal submission
function setupEditModalSubmissionListeners() {
    const confirmSubmitBtn = document.getElementById('edit-modal-confirm-submit-btn');
    const cancelSubmitBtn = document.getElementById('edit-modal-cancel-submit-btn');
    
    if (confirmSubmitBtn) {
        // Remove existing listeners to prevent duplicates
        confirmSubmitBtn.removeEventListener('click', handleEditModalConfirmSubmit);
        confirmSubmitBtn.addEventListener('click', handleEditModalConfirmSubmit);
    }
    
    if (cancelSubmitBtn) {
        // Remove existing listeners to prevent duplicates
        cancelSubmitBtn.removeEventListener('click', handleEditModalCancelSubmit);
        cancelSubmitBtn.addEventListener('click', handleEditModalCancelSubmit);
    }
}

async function handleEditModalConfirmSubmit() {
    try {
        const reviewerSelect = document.getElementById('edit-modal-reviewer-select');
        const selectedReviewer = reviewerSelect.value;
        
        if (!selectedReviewer) {
            showMessageBox('Please select a reviewer before submitting.', true);
            return;
        }
        
        if (!window.editingProjectData || !window.editingProjectData.project) {
            showMessageBox('Error: No project data available for submission.', true);
            return;
        }
        
        showLoadingScreen('Submitting project for review...', 'Please wait');
        
        // Store project ID before saving (in case saveEditedProject clears the data)
        const projectId = window.editingProjectData.project.id;
        
        // First save the changes (but don't clear project data)
        try {
            if (!window.editingProjectData) {
                throw new Error('No project is currently being edited');
            }
            
            showLoadingScreen('Saving project changes...', 'Please wait');
            
            const project = window.editingProjectData.project;
            
            // Use the original project's CSI path (no changes allowed)
            const divisionCode = project.division_code;
            const sectionCode = project.section_code;
            const detailedSectionCode = project.detailed_section_code;
            const itemCode = project.item_code;
            const levelName = project.additional_level_name || null;
            const levelValue = project.additional_level_value || null;
            const projectName = document.getElementById('edit-project-name').value.trim();

            if (!projectName) {
                hideLoadingScreen();
                showMessageBox('Please enter a project name.', true);
                return;
            }
            
            // Collect attributes from the modal
            const attributes = [];
            document.querySelectorAll('#edit-project-attributes > div.border').forEach(attrDiv => {
                const nameInput = attrDiv.querySelector('.edit-attr-name');
                const name = nameInput ? nameInput.value.trim() : '';
                
                if (name) {
                    const standardValues = [];
                    attrDiv.querySelectorAll('.standard-value-item').forEach(valueDiv => {
                        const valueName = valueDiv.querySelector('.standard-value-name').value.trim();
                        const valueUnit = valueDiv.querySelector('.standard-value-unit').value.trim();
                        if (valueName) {
                            standardValues.push({
                                name: valueName,
                                unit: valueUnit || ''
                            });
                        }
                    });
                    
                    const isMandatory = attrDiv.querySelector('.edit-attr-mandatory').checked;
                    const isManualEntry = attrDiv.querySelector('.edit-attr-manual').checked;
                    
                    attributes.push({
                        attribute_name: name,
                        standard_values: standardValues,
                        is_mandatory: isMandatory,
                        is_manual_entry: isManualEntry
                    });
                }
            });
            
            // Update project using appropriate function based on user role
            let data, error;
            if (currentUser.role === 'admin') {
                const result = await supabase.rpc('admin_update_project', {
                    project_id_param: project.id,
                    admin_id_param: currentUser.id,
                    project_name_param: projectName,
                    division_code_param: divisionCode,
                    section_code_param: sectionCode,
                    detailed_section_code_param: detailedSectionCode,
                    item_code_param: itemCode,
                    additional_level_name_param: levelName || null,
                    additional_level_value_param: levelValue || null,
                    attributes_param: attributes,
                    division_description_param: project.division_description || '',
                    section_description_param: project.section_description || '',
                    detailed_section_description_param: project.detailed_section_description || '',
                    item_description_param: project.item_description || ''
                });
                data = result.data;
                error = result.error;
            } else {
                const result = await supabase.rpc('update_project', {
                    project_id_param: project.id,
                    user_id_param: currentUser.id,
                    project_name_param: projectName,
                    division_code_param: divisionCode,
                    section_code_param: sectionCode,
                    detailed_section_code_param: detailedSectionCode,
                    item_code_param: itemCode,
                    additional_level_name_param: levelName || null,
                    additional_level_value_param: levelValue || null,
                    attributes_param: attributes,
                    division_description_param: project.division_description || '',
                    section_description_param: project.section_description || '',
                    detailed_section_description_param: project.detailed_section_description || '',
                    item_description_param: project.item_description || ''
                });
                data = result.data;
                error = result.error;
            }
            
            if (error) throw error;
            
            if (!data.success) {
                throw new Error(data.message);
            }
            
            showLoadingScreen('Submitting project for review...', 'Please wait');
            
        } catch (saveError) {
            hideLoadingScreen();
            console.error('Error saving project:', saveError);
            showMessageBox(`Failed to save project: ${saveError.message}`, true);
            return;
        }
        
        // Then submit for review
        const { data, error } = await supabase.rpc('submit_project_for_review', {
            project_id_param: projectId,
            reviewer_id_param: parseInt(selectedReviewer)
        });
        
        if (error) throw error;
        
        if (!data.success) {
            throw new Error(data.message);
        }
        
        // Send email notification to reviewer
        const projectName = project.project_name;
        const notificationResult = await notifyReviewerOnSubmission(projectId, projectName);
        
        hideLoadingScreen();
        closeModal('edit-project-modal');
        
        if (notificationResult) {
            showMessageBox('Project submitted for review successfully! Email notification sent to reviewer.');
        } else {
            showMessageBox('Project submitted for review successfully! However, email notification to reviewer failed.');
        }
        
        // Clear editing data
        window.editingProjectData = null;
        
        // Refresh the projects list
        await loadUserProjects();
        
    } catch (error) {
        hideLoadingScreen();
        console.error('Error submitting project for review:', error);
        showMessageBox(`Failed to submit project: ${error.message}`, true);
    }
}
function handleEditModalCancelSubmit() {
    const reviewerSection = document.getElementById('edit-modal-reviewer-selection');
    if (reviewerSection) {
        reviewerSection.style.display = 'none';
    }
}

async function populateEditModal(project, attributes) {
    try {
        // Set project name
        document.getElementById('edit-project-name').value = project.project_name;
        
        // Populate read-only CSI path fields
        await populateReadOnlyCSIPath(project);
        
        // Load attributes
        loadEditModalAttributesDisplay(attributes);
        
    } catch (error) {
        console.error('Error populating edit modal:', error);
        throw error;
    }
}

// =========================================================
// CSI PATH MANAGEMENT FUNCTIONS (ADMIN ONLY)
// =========================================================

// Global variables for CSI management
let csiProjectsData = [];
let csiPendingChanges = new Map();
let csiHierarchyCache = {
    divisions: [],
    sections: {},
    detailedSections: {},
    items: {},
    additionalLevels: {}
};

async function loadCSIManagementData() {
    try {
        // Show loading state
        document.getElementById('csi-table-loading').style.display = 'block';
        document.getElementById('csi-table-container').style.display = 'none';
        document.getElementById('csi-no-projects').style.display = 'none';
        
        // Load all projects with user information
        const { data: projects, error: projectsError } = await supabase
            .from('classification_projects')
            .select(`
                *,
                creator:users!classification_projects_created_by_fkey(username, email)
            `)
            .order('created_at', { ascending: false });

        if (projectsError) throw projectsError;
        
        // Load CSI hierarchy options
        await loadCSIHierarchyOptions();
        
        // Store projects data
        csiProjectsData = projects || [];
        
        // Clear pending changes
        csiPendingChanges.clear();
        updateCSIChangesDisplay();
        
        // Render table
        renderCSIProjectsTable();
        
        // Hide loading, show content
        document.getElementById('csi-table-loading').style.display = 'none';
        
        if (csiProjectsData.length === 0) {
            document.getElementById('csi-no-projects').style.display = 'block';
        } else {
            document.getElementById('csi-table-container').style.display = 'block';
        }
        
    } catch (error) {
        console.error('Error loading CSI management data:', error);
        document.getElementById('csi-table-loading').style.display = 'none';
        showMessageBox(`Failed to load projects: ${error.message}`, true);
    }
}

async function loadCSIHierarchyOptions() {
    try {
        // Load divisions
        const { data: divisions, error: divError } = await supabase.rpc('get_divisions');
        if (divError) throw divError;
        csiAvailableOptions.divisions = divisions || [];
        
        // Load all sections, detailed sections, and items for quick access
        for (const division of csiAvailableOptions.divisions) {
            const { data: sections } = await supabase.rpc('get_sections', { 
                division_code_param: division.division_code 
            });
            csiAvailableOptions.sections.set(division.division_code, sections || []);
            
            for (const section of sections || []) {
                const { data: detailedSections } = await supabase.rpc('get_detailed_sections', {
                    division_code_param: division.division_code,
                    section_code_param: section.section_code
                });
                const key = `${division.division_code}-${section.section_code}`;
                csiAvailableOptions.detailedSections.set(key, detailedSections || []);
                
                for (const detailedSection of detailedSections || []) {
                    const { data: items } = await supabase.rpc('get_items', {
                        division_code_param: division.division_code,
                        section_code_param: section.section_code,
                        detailed_section_code_param: detailedSection.detailed_section_code
                    });
                    const itemKey = `${division.division_code}-${section.section_code}-${detailedSection.detailed_section_code}`;
                    csiAvailableOptions.items.set(itemKey, items || []);
                }
            }
        }
        
    } catch (error) {
        console.error('Error loading CSI hierarchy options:', error);
    }
}

function renderCSIProjectsTable() {
    const tbody = document.getElementById('csi-table-body');
    tbody.innerHTML = '';
    
    if (!csiProjectsData || csiProjectsData.length === 0) {
        return;
    }
    
    csiProjectsData.forEach((project, index) => {
        const row = document.createElement('tr');
        row.className = 'hover:bg-gray-50';
        
        // Check if this project has pending changes
        const hasChanges = csiPendingChanges.has(project.id);
        const rowClass = hasChanges ? 'bg-yellow-50 border-l-4 border-yellow-400' : '';
        if (rowClass) row.className += ' ' + rowClass;
        
        row.innerHTML = `
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                ${project.project_name}
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                ${renderCSIDropdown('division', project, index)}
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                ${renderCSIDropdown('section', project, index)}
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                ${renderCSIDropdown('detailed_section', project, index)}
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                ${renderCSIDropdown('item', project, index)}
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                <input type="text" value="${project.additional_level_name || ''}" 
                       class="csi-input w-full px-2 py-1 border border-gray-300 rounded text-sm"
                       onchange="handleCSIChange('additional_level_name', this.value, ${project.id}, ${index})">
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                <input type="text" value="${project.additional_level_value || ''}" 
                       class="csi-input w-full px-2 py-1 border border-gray-300 rounded text-sm"
                       onchange="handleCSIChange('additional_level_value', this.value, ${project.id}, ${index})">
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${getStatusBadgeClass(project.status)}">
                    ${getStatusDisplayText(project.status)}
                </span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                ${project.creator ? project.creator.username : 'Unknown'}
            </td>
        `;
        
        tbody.appendChild(row);
    });
}

function renderCSIDropdown(type, project, index) {
    let options = '';
    let selectedValue = '';
    
    switch (type) {
        case 'division':
            selectedValue = project.division_code;
            options = csiAvailableOptions.divisions.map(div => 
                `<option value="${div.division_code}" ${div.division_code === selectedValue ? 'selected' : ''}>${div.division_code} - ${div.division_description}</option>`
            ).join('');
            break;
            
        case 'section':
            selectedValue = project.section_code;
            const divisionSections = csiAvailableOptions.sections.get(project.division_code) || [];
            options = divisionSections.map(sec => 
                `<option value="${sec.section_code}" ${sec.section_code === selectedValue ? 'selected' : ''}>${sec.section_code} - ${sec.section_description}</option>`
            ).join('');
            break;
            
        case 'detailed_section':
            selectedValue = project.detailed_section_code;
            const detailedKey = `${project.division_code}-${project.section_code}`;
            const detailedSections = csiAvailableOptions.detailedSections.get(detailedKey) || [];
            options = detailedSections.map(det => 
                `<option value="${det.detailed_section_code}" ${det.detailed_section_code === selectedValue ? 'selected' : ''}>${det.detailed_section_code} - ${det.detailed_section_description}</option>`
            ).join('');
            break;
            
        case 'item':
            selectedValue = project.item_code;
            const itemKey = `${project.division_code}-${project.section_code}-${project.detailed_section_code}`;
            const items = csiAvailableOptions.items.get(itemKey) || [];
            options = items.map(item => 
                `<option value="${item.item_code}" ${item.item_code === selectedValue ? 'selected' : ''}>${item.item_code} - ${item.item_description}</option>`
            ).join('');
            break;
    }
    
    return `
        <select class="csi-select w-full px-2 py-1 border border-gray-300 rounded text-sm" 
                onchange="handleCSIChange('${type === 'detailed_section' ? 'detailed_section_code' : type + '_code'}', this.value, ${project.id}, ${index})">
            ${options}
        </select>
    `;
}

function handleCSIChange(field, value, projectId, projectIndex) {
    // Get current project data
    const project = csiProjectsData[projectIndex];
    
    // Get or create pending changes for this project
    if (!csiPendingChanges.has(projectId)) {
        csiPendingChanges.set(projectId, { ...project });
    }
    
    const pendingProject = csiPendingChanges.get(projectId);
    pendingProject[field] = value;
    
    // Handle cascading changes for CSI hierarchy
    if (field === 'division_code') {
        // Reset lower levels when division changes
        pendingProject.section_code = '';
        pendingProject.detailed_section_code = '';
        pendingProject.item_code = '';
        pendingProject.additional_level_name = '';
        pendingProject.additional_level_value = '';
    } else if (field === 'section_code') {
        // Reset lower levels when section changes
        pendingProject.detailed_section_code = '';
        pendingProject.item_code = '';
        pendingProject.additional_level_name = '';
        pendingProject.additional_level_value = '';
    } else if (field === 'detailed_section_code') {
        // Reset lower levels when detailed section changes
        pendingProject.item_code = '';
        pendingProject.additional_level_name = '';
        pendingProject.additional_level_value = '';
    } else if (field === 'item_code') {
        // Reset additional levels when item changes
        pendingProject.additional_level_name = '';
        pendingProject.additional_level_value = '';
    }
    
    // Update the project data for rendering
    csiProjectsData[projectIndex] = { ...csiProjectsData[projectIndex], ...pendingProject };
    
    // Re-render the table to reflect cascading changes
    renderCSIProjectsTable();
    
    // Update changes display
    updateCSIChangesDisplay();
}

function updateCSIChangesDisplay() {
    const changesCount = csiPendingChanges.size;
    const summaryDiv = document.getElementById('csi-changes-summary');
    const changesList = document.getElementById('csi-changes-list');
    const saveBtn = document.getElementById('csi-save-changes-btn');
    const discardBtn = document.getElementById('csi-discard-changes-btn');
    
    if (changesCount === 0) {
        summaryDiv.style.display = 'none';
        saveBtn.disabled = true;
        discardBtn.disabled = true;
    } else {
        summaryDiv.style.display = 'block';
        saveBtn.disabled = false;
        discardBtn.disabled = false;
        
        let changesHTML = `<strong>${changesCount}</strong> project(s) have pending changes:<br>`;
        
        for (const [projectId, changes] of csiPendingChanges) {
            const originalProject = csiProjectsData.find(p => p.id === projectId);
            changesHTML += `<div class="mt-1">√É∆í√Ü‚Äô√É‚Äö√Ç¬¢√É∆í√Ç¬¢√É¬¢√¢‚Äö¬¨√Ö¬°√É‚Äö√Ç¬¨√É∆í√¢‚Ç¨≈°√É‚Äö√Ç¬¢ <strong>${originalProject.project_name}</strong>: CSI path modifications</div>`;
        }
        
        changesList.innerHTML = changesHTML;
    }
}

function getStatusBadgeClass(status) {
    const statusClasses = {
        'draft': 'bg-gray-100 text-gray-800',
        'submitted': 'bg-yellow-100 text-yellow-800',
        'reviewer_approved': 'bg-blue-100 text-blue-800',
        'reviewer_rejected': 'bg-red-100 text-red-800',
        'admin_approved': 'bg-green-100 text-green-800',
        'admin_rejected': 'bg-red-100 text-red-800'
    };
    return statusClasses[status] || 'bg-gray-100 text-gray-800';
}

function getStatusDisplayText(status) {
    const statusTexts = {
        'draft': 'Draft',
        'submitted': 'Pending Review',
        'reviewer_approved': 'Pending Admin',
        'reviewer_rejected': 'Rejected',
        'admin_approved': 'Approved',
        'admin_rejected': 'Admin Rejected'
    };
    return statusTexts[status] || status;
}

async function saveCSIChanges() {
    if (csiPendingChanges.size === 0) {
        showMessageBox('No changes to save.', true);
        return;
    }
    
    try {
        showLoadingScreen('Saving CSI path changes...', 'Processing updates');
        
        // Save each changed project
        for (const [projectId, changes] of csiPendingChanges) {
            const { error } = await supabase
                .from('classification_projects')
                .update({
                    division_code: changes.division_code,
                    section_code: changes.section_code,
                    detailed_section_code: changes.detailed_section_code,
                    item_code: changes.item_code,
                    additional_level_name: changes.additional_level_name || null,
                    additional_level_value: changes.additional_level_value || null,
                    updated_at: new Date().toISOString()
                })
                .eq('id', projectId);
                
            if (error) throw error;
        }
        
        hideLoadingScreen();
        showMessageBox(`Successfully saved ${csiPendingChanges.size} project(s) with updated CSI paths.`);
        
        // Clear changes and reload data
        csiPendingChanges.clear();
        await loadCSIManagementData();
        
    } catch (error) {
        hideLoadingScreen();
        console.error('Error saving CSI changes:', error);
        showMessageBox(`Failed to save changes: ${error.message}`, true);
    }
}

function discardCSIChanges() {
    if (csiPendingChanges.size === 0) {
        showMessageBox('No changes to discard.', true);
        return;
    }
    
    if (confirm(`Are you sure you want to discard all ${csiPendingChanges.size} pending change(s)?`)) {
        csiPendingChanges.clear();
        loadCSIManagementData(); // Reload original data
        showMessageBox('All changes discarded.');
    }
}

// USER MANAGEMENT FUNCTIONS (ADMIN ONLY) - KEPT AS-IS
        // =========================================================

        async function loadUsers() {
    try {
        const { data, error } = await supabase
            .from('users')
            .select('*')
            .order('created_at', { ascending: false });

        if (error) throw error;

        const usersList = document.getElementById('users-list');

        if (data && data.length > 0) {
            let html = '<div class="space-y-4">';
            data.forEach(user => {
                const statusColor = user.status === 'active' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';
                const roleColor = {
                    'admin': 'bg-purple-100 text-purple-800',
                    'creator': 'bg-blue-100 text-blue-800',
                    'reviewer': 'bg-orange-100 text-orange-800'
                }[user.role] || 'bg-gray-100 text-gray-800';

                html += `
                    <div class="bg-white border border-gray-200 rounded-lg p-4">
                        <div class="flex items-center justify-between">
                            <div>
                                <h4 class="text-lg font-medium text-gray-900">${user.username}</h4>
                                <p class="text-sm text-gray-500">${user.email}</p>
                                <p class="text-sm text-gray-500">Created: ${new Date(user.created_at).toLocaleDateString()}</p>
                            </div>
                            <div class="flex items-center space-x-3">
                                <select onchange="changeUserRole(${user.id}, this.value, '${user.username}')" class="px-2 py-1 text-xs border border-gray-300 rounded-md">
                                    <option value="admin" ${user.role === 'admin' ? 'selected' : ''}>Admin</option>
                                    <option value="creator" ${user.role === 'creator' ? 'selected' : ''}>Creator</option>
                                    <option value="reviewer" ${user.role === 'reviewer' ? 'selected' : ''}>Reviewer</option>
                                </select>
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${statusColor}">
                                    ${user.status.toUpperCase()}
                                </span>
                                ${user.id !== currentUser.id ? `
                                    <button onclick="toggleUserStatus(${user.id}, '${user.status}', '${user.username}')" class="px-2 py-1 text-xs ${user.status === 'active' ? 'bg-red-600' : 'bg-green-600'} text-white rounded-md hover:opacity-80">
                                        ${user.status === 'active' ? 'Deactivate' : 'Activate'}
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            usersList.innerHTML = html;
        } else {
            usersList.innerHTML = '<div class="text-center text-gray-500 py-8">No users found.</div>';
        }
    } catch (error) {
        console.error('Error loading users:', error);
        const usersList = document.getElementById('users-list');
        usersList.innerHTML = '<div class="text-center text-red-500 py-8">Failed to load users.</div>';
    }
}
        // =========================================================
        // EXPORT FUNCTIONS (KEPT AS-IS)
        // =========================================================

       async function changeUserRole(userId, newRole, username) {
    if (!confirm(`Change ${username}'s role to ${newRole}?`)) {
        loadUsers(); // Refresh to reset the dropdown
        return;
    }

    try {
        const { error } = await supabase
            .from('users')
            .update({ role: newRole })
            .eq('id', userId);

        if (error) throw error;

        showMessageBox(`${username}'s role changed to ${newRole} successfully!`);
        loadUsers(); // Refresh the list
    } catch (error) {
        console.error('Error changing user role:', error);
        showMessageBox(`Failed to change role: ${error.message}`, true);
        loadUsers(); // Refresh to reset
    }
}

async function toggleUserStatus(userId, currentStatus, username) {
    const newStatus = currentStatus === 'active' ? 'inactive' : 'active';
    
    if (!confirm(`${newStatus === 'active' ? 'Activate' : 'Deactivate'} ${username}?`)) {
        return;
    }

    try {
        const { error } = await supabase
            .from('users')
            .update({ status: newStatus })
            .eq('id', userId);

        if (error) throw error;

        showMessageBox(`${username} ${newStatus === 'active' ? 'activated' : 'deactivated'} successfully!`);
        loadUsers(); // Refresh the list
    } catch (error) {
        console.error('Error changing user status:', error);
        showMessageBox(`Failed to change status: ${error.message}`, true);
    }
}
       function performExcelExport() {
    if (collectedData.length === 0) {
        showMessageBox("No data to export.", true);
        return;
    }

    const exportableData = [];
    collectedData.forEach(entry => {
        const divisionParts = entry.division.split(' - ');
        const sectionParts = entry.section.split(' - ');
        const subsectionParts = entry.subsection.split(' - ');
        const itemParts = entry.item.split(' - ');

        entry.attributes.forEach(attr => {
            exportableData.push({
                'Division Code': divisionParts[0],
                'Division Description': divisionParts[1] || '',
                'Section Code': sectionParts[0],
                'Section Description': sectionParts[1] || '',
                'Detailed Section Code': subsectionParts[0],
                'Detailed Section Description': subsectionParts[1] || '',
                'Item Code': itemParts[0],
                'Item Description': itemParts[1] || '',
                'Additional Level Name': entry.additionalLevel ? entry.additionalLevel.name : '',
                'Additional Level Value': entry.additionalLevel ? entry.additionalLevel.value : '',
                'Attribute Name': attr.name,
                'Standard Values': attr.isManualEntry ? 
                    (attr.standardValues.length > 0 ? 
                        'Manual Entry - Examples: ' + attr.standardValues.map(v => {
                            const unitText = v.unit ? ` (${v.unit})` : '';
                            return `${v.name}${unitText}`;
                        }).join(', ') : 
                        'Manual Entry - No examples'
                    ) :
                    attr.standardValues.map(v => {
                        const unitText = v.unit ? ` (${v.unit})` : '';
                        return `${v.name}${unitText}`;
                    }).join(', '),
                'Mandatory': attr.mandatory ? 'Yes' : 'No',
                'Manual Entry': attr.isManualEntry ? 'Yes' : 'No'
            });
        });
    });

    const ws = XLSX.utils.json_to_sheet(exportableData);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "CSI Attributes");

    const fileName = `CSI_Attributes_${new Date().toISOString().slice(0, 10)}.xlsx`;
    XLSX.writeFile(wb, fileName);

    showMessageBox("Excel file exported successfully!");
}

// =========================================================
// EXCEL IMPORT FUNCTIONS
// =========================================================

async function importExcelFile() {
    const fileInput = document.getElementById('excel-import-input');
    const file = fileInput.files[0];

    if (!file) {
        showMessageBox('Please select an Excel file to import.', true);
        return;
    }

    try {
        showLoadingScreen('Processing Excel file...', 'Import in Progress');
        
        const data = await file.arrayBuffer();
        updateLoadingMessage('Reading Excel data...');
        
        const workbook = XLSX.read(data, { type: 'array' });
        const sheetName = workbook.SheetNames[0];
        const worksheet = workbook.Sheets[sheetName];
        const jsonData = XLSX.utils.sheet_to_json(worksheet);

        if (!jsonData || jsonData.length === 0) {
            hideLoadingScreen();
            showMessageBox('The Excel file is empty or invalid.', true);
            return;
        }

        updateLoadingMessage('Validating file structure...');

        // Define required columns with their possible variations
        const requiredColumnGroups = [
            ['Division Code', 'CSI Division Code'],
            ['Section Code', 'CSI Section Code'], 
            ['Detailed Section Code', 'CSI Detailed Section Code'],
            ['Item Code', 'CSI Item Code'],
            ['Attribute Name'],
            ['Standard Values']
        ];

        const firstRow = jsonData[0];
        const availableColumns = Object.keys(firstRow);
        const missingGroups = [];

        // Check if each required column group has at least one matching column
        requiredColumnGroups.forEach((group, index) => {
            const hasMatch = group.some(colName => availableColumns.includes(colName));
            if (!hasMatch) {
                missingGroups.push(group[0]); // Use the first (original) name for error message
            }
        });

        if (missingGroups.length > 0) {
            hideLoadingScreen();
            showMessageBox(`Missing required columns: ${missingGroups.join(', ')}. Available columns: ${availableColumns.join(', ')}`, true);
            return;
        }

        updateLoadingMessage('Processing imported data...');
        await processImportedData(jsonData);
        
        fileInput.value = '';
        hideLoadingScreen();
        showMessageBox('Excel file imported successfully as draft!');
    } catch (error) {
        hideLoadingScreen();
        showMessageBox(`Failed to import Excel file: ${error.message}`, true);
    }
}
async function processImportedData(rows) {
    if (collectedData.length > 0) {
        if (!confirm('Importing will clear current data. Continue?')) {
            return;
        }
    }

    collectedData = [];
    
    // DECLARE pathGroups FIRST
    const pathGroups = {};

    // Create column mapping to handle different header variations
    function getColumnValue(row, possibleNames) {
        for (const name of possibleNames) {
            if (row.hasOwnProperty(name) && row[name] !== undefined && row[name] !== null) {
                return String(row[name]).trim();
            }
        }
        return '';
    }

    // Process rows to build pathGroups
    for (const row of rows) {
        const divisionCode = getColumnValue(row, ['Division Code', 'CSI Division Code']);
        const divisionDesc = getColumnValue(row, ['Division Description', 'CSI Division Description']);
        const sectionCode = getColumnValue(row, ['Section Code', 'CSI Section Code']);
        const sectionDesc = getColumnValue(row, ['Section Description', 'CSI Section Description']);
        const detailedSectionCode = getColumnValue(row, ['Detailed Section Code', 'CSI Detailed Section Code']);
        const detailedSectionDesc = getColumnValue(row, ['Detailed Section Description', 'CSI Detailed Section Description']);
        const itemCode = getColumnValue(row, ['Item Code', 'CSI Item Code']);
        const itemDesc = getColumnValue(row, ['Item Description', 'CSI Item Description']);
        const additionalLevelName = getColumnValue(row, ['Additional Level Name']);
        const additionalLevelValue = getColumnValue(row, ['Additional Level Value']);
        const attributeName = getColumnValue(row, ['Attribute Name']);
        const standardValuesStr = getColumnValue(row, ['Standard Values']);
        const mandatory = getColumnValue(row, ['Mandatory']).toLowerCase() === 'yes';
        const isManualEntry = getColumnValue(row, ['Manual Entry']).toLowerCase() === 'yes';

        // Skip rows with missing essential data
        if (!divisionCode || !sectionCode || !detailedSectionCode || !itemCode || !attributeName) {
            console.warn('Skipping row with missing essential data:', row);
            continue;
        }

        const pathKey = `${divisionCode}|${sectionCode}|${detailedSectionCode}|${itemCode}|${additionalLevelValue}`;

        if (!pathGroups[pathKey]) {
            pathGroups[pathKey] = {
                division: `${divisionCode}${divisionDesc ? ' - ' + divisionDesc : ''}`,
                section: `${sectionCode}${sectionDesc ? ' - ' + sectionDesc : ''}`,
                subsection: `${detailedSectionCode}${detailedSectionDesc ? ' - ' + detailedSectionDesc : ''}`,
                item: `${itemCode}${itemDesc ? ' - ' + itemDesc : ''}`,
                additionalLevel: (additionalLevelName && additionalLevelValue) ? {
                    name: additionalLevelName,
                    value: additionalLevelValue
                } : null,
                attributes: [],
                codes: { divisionCode, sectionCode, detailedSectionCode, itemCode }
            };
        }

        const standardValues = parseStandardValues(standardValuesStr);
        const existingAttr = pathGroups[pathKey].attributes.find(a => a.name === attributeName);
        if (!existingAttr) {
            pathGroups[pathKey].attributes.push({
                name: attributeName,
                standardValues: standardValues,
                mandatory: mandatory,
                isManualEntry: isManualEntry
            });
        }
    }

    // Create additional levels if they don't exist
    for (const pathKey of Object.keys(pathGroups)) {
        const entry = pathGroups[pathKey];
        
        if (entry.additionalLevel) {
            try {
                updateLoadingMessage(`Creating additional level: ${entry.additionalLevel.name}...`);
                
                // Create or get additional level
                const { data: levelData, error: levelError } = await supabase.rpc('create_or_get_additional_level', {
                    level_name_param: entry.additionalLevel.name,
                    division_code_param: entry.codes.divisionCode,
                    section_code_param: entry.codes.sectionCode,
                    detailed_section_code_param: entry.codes.detailedSectionCode,
                    item_code_param: entry.codes.itemCode
                });

                if (levelError) {
                    console.error('Error creating additional level:', levelError);
                    continue;
                }

                if (levelData && levelData.success) {
                    // Add value to the level
                    const { data: valueData, error: valueError } = await supabase.rpc('save_additional_level_value', {
                        additional_level_id_param: levelData.level_id,
                        value_name_param: entry.additionalLevel.value
                    });

                    if (valueError) {
                        console.error('Error creating additional level value:', valueError);
                    }
                }
            } catch (error) {
                console.error('Error processing additional level:', error);
            }
        }
    }

    // Validate imported paths don't conflict with existing projects
    for (const pathKey of Object.keys(pathGroups)) {
        const entry = pathGroups[pathKey];
        
        // Temporarily set selections to check path
        divisionSelect.value = entry.division;
        sectionSelect.value = entry.section;
        subsectionSelect.value = entry.subsection;
        itemSelect.value = entry.item;
        if (entry.additionalLevel) {
            additionalLevelName.value = entry.additionalLevel.name;
            additionalLevelSelect.value = entry.additionalLevel.value;
        }
        
        const availability = await checkPathAvailability();
        if (!availability.available) {
            showMessageBox(`Import failed: ${availability.message}`, true);
            return;
        }
    }

    collectedData = Object.values(pathGroups);

    if (collectedData.length > 0) {
        const firstEntry = collectedData[0];
        const divisionCode = firstEntry.division.split(' - ')[0];
        const sectionCode = firstEntry.section.split(' - ')[0];
        const detailedSectionCode = firstEntry.subsection.split(' - ')[0];
        const itemCode = firstEntry.item.split(' - ')[0];

        await loadDivisions();
        divisionSelect.value = firstEntry.division;
        await loadSections(divisionCode);
        sectionSelect.value = firstEntry.section;
        await loadDetailedSections(divisionCode, sectionCode);
        subsectionSelect.value = firstEntry.subsection;
        await loadItems(divisionCode, sectionCode, detailedSectionCode);
        itemSelect.value = firstEntry.item;

        attributeCreationSection.classList.remove('disabled-section');
        additionalLevelsSection.classList.remove('disabled-section');

        if (firstEntry.additionalLevel) {
            await loadAdditionalLevel(divisionCode, sectionCode, detailedSectionCode, itemCode);
            additionalLevelName.value = firstEntry.additionalLevel.name;
            
            // Load the dropdown and set the value
            const levelValueSelect = additionalLevelSelect;
            const options = Array.from(levelValueSelect.options).map(o => o.value);
            if (!options.includes(firstEntry.additionalLevel.value)) {
                const option = document.createElement('option');
                option.value = firstEntry.additionalLevel.value;
                option.textContent = firstEntry.additionalLevel.value;
                levelValueSelect.appendChild(option);
            }
            levelValueSelect.value = firstEntry.additionalLevel.value;
        }

        renderCurrentPath();
    }

    updateCollectedDataDisplay();
    draftInfo.style.display = 'block';
    draftName.innerHTML = '<span class="text-blue-600">(Imported - Not Saved)</span>';
}
// Missing openEditProjectModal function - Add this BEFORE openViewProjectModal
async function openEditProjectModal(projectId) {
    try {
        showLoadingScreen('Loading project details...', 'Please wait');
        
        // Clear any existing attributes from previous modal sessions
        const attributesContainer = document.getElementById('edit-project-attributes');
        if (attributesContainer) {
            attributesContainer.innerHTML = '';
        }
        
        // Clear project name field
        const projectNameField = document.getElementById('edit-project-name');
        if (projectNameField) {
            projectNameField.value = '';
        }
        
        // Determine which function to call based on user role
        let result;
        if (currentUser.role === 'admin') {
            result = await supabase.rpc('admin_get_project_for_edit', {
                project_id_param: projectId,
                admin_id_param: currentUser.id
            });
        } else {
            result = await supabase.rpc('get_project_for_edit', {
                project_id_param: projectId,
                user_id_param: currentUser.id
            });
        }
        
        if (result.error) {
            throw new Error(result.error.message);
        }
        
        if (!result.data.success) {
            throw new Error(result.data.message);
        }
        
        const { project, attributes } = result.data;
        
        // Store the project data globally for saving
        window.editingProjectData = { project, attributes };
        
        // Populate the modal
        await populateEditModal(project, attributes);
        
        // Load reviewers for potential submission
        await loadEditModalReviewers();
        
        hideLoadingScreen();
        showModal(document.getElementById('edit-project-modal'));
        
    } catch (error) {
        console.error('Error opening edit modal:', error);
        hideLoadingScreen();
        showMessageBox(`Failed to load project: ${error.message}`, true);
    }
}
// Helper function to load CSI dropdowns in edit modal
async function loadEditModalCSIDropdowns() {
    try {
        // Load divisions
        const { data: divisions, error: divError } = await supabase.rpc('get_divisions');
        if (divError) throw divError;
        
        const divisionSelect = document.getElementById('edit-modal-division');
        divisionSelect.innerHTML = '<option value="">Select Division</option>';
        
        divisions.forEach(division => {
            const option = document.createElement('option');
            option.value = `${division.division_code} - ${division.division_description}`;
            option.textContent = `${division.division_code} - ${division.division_description}`;
            divisionSelect.appendChild(option);
        });
        
        // Add event listeners for cascading dropdowns
        setupEditModalEventListeners();
        
    } catch (error) {
        console.error('Error loading CSI dropdowns:', error);
    }
}

// Helper function to set current CSI values in edit modal
async function setEditModalCSIValues(project) {
    try {
        // Set division and load sections
        const divisionText = await getDivisionDescription(project.division_code);
        document.getElementById('edit-modal-division').value = divisionText;
        await loadEditModalSections(project.division_code);
        
        // Set section and load subsections
        const sectionText = await getSectionDescription(project.section_code);
        document.getElementById('edit-modal-section').value = sectionText;
        await loadEditModalSubsections(project.division_code, project.section_code);
        
        // Set subsection and load items
        const subsectionText = await getDetailedSectionDescription(project.detailed_section_code);
        document.getElementById('edit-modal-subsection').value = subsectionText;
        await loadEditModalItems(project.division_code, project.section_code, project.detailed_section_code);
        
        // Set item
        const itemText = await getItemDescription(project.item_code);
        document.getElementById('edit-modal-item').value = itemText;
        
        // Set additional level info
        if (project.additional_level_name) {
            document.getElementById('edit-modal-level-name').value = project.additional_level_name;
            await loadEditModalLevelValues(project.division_code, project.section_code, project.detailed_section_code, project.item_code);
            if (project.additional_level_value) {
                document.getElementById('edit-modal-level-value').value = project.additional_level_value;
            }
        }
        
    } catch (error) {
        console.error('Error setting CSI values:', error);
    }
}

// Helper function to load sections for edit modal
async function loadEditModalSections(divisionCode) {
    try {
        const { data: sections, error } = await supabase.rpc('get_sections', {
            division_code_param: divisionCode
        });
        if (error) throw error;
        
        const sectionSelect = document.getElementById('edit-modal-section');
        sectionSelect.innerHTML = '<option value="">Select Section</option>';
        sectionSelect.disabled = false;
        
        sections.forEach(section => {
            const option = document.createElement('option');
            option.value = `${section.section_code} - ${section.section_description}`;
            option.textContent = `${section.section_code} - ${section.section_description}`;
            sectionSelect.appendChild(option);
        });
        
    } catch (error) {
        console.error('Error loading sections:', error);
    }
}

// Helper function to load subsections for edit modal
async function loadEditModalSubsections(divisionCode, sectionCode) {
    try {
        const { data: subsections, error } = await supabase.rpc('get_detailed_sections', {
            division_code_param: divisionCode,
            section_code_param: sectionCode
        });
        if (error) throw error;
        
        const subsectionSelect = document.getElementById('edit-modal-subsection');
        subsectionSelect.innerHTML = '<option value="">Select Detailed Section</option>';
        subsectionSelect.disabled = false;
        
        subsections.forEach(subsection => {
            const option = document.createElement('option');
            option.value = `${subsection.detailed_section_code} - ${subsection.detailed_section_description}`;
            option.textContent = `${subsection.detailed_section_code} - ${subsection.detailed_section_description}`;
            subsectionSelect.appendChild(option);
        });
        
    } catch (error) {
        console.error('Error loading subsections:', error);
    }
}

// Helper function to load items for edit modal
async function loadEditModalItems(divisionCode, sectionCode, detailedSectionCode) {
    try {
        const { data: items, error } = await supabase.rpc('get_items', {
            division_code_param: divisionCode,
            section_code_param: sectionCode,
            detailed_section_code_param: detailedSectionCode
        });
        if (error) throw error;
        
        const itemSelect = document.getElementById('edit-modal-item');
        itemSelect.innerHTML = '<option value="">Select Item</option>';
        itemSelect.disabled = false;
        
        items.forEach(item => {
            const option = document.createElement('option');
            option.value = `${item.item_code} - ${item.item_description}`;
            option.textContent = `${item.item_code} - ${item.item_description}`;
            itemSelect.appendChild(option);
        });
        
    } catch (error) {
        console.error('Error loading items:', error);
    }
}

// Helper function to load additional level values for edit modal
async function loadEditModalLevelValues(divisionCode, sectionCode, detailedSectionCode, itemCode) {
    try {
        const { data: values, error } = await supabase.rpc('get_additional_level_values', {
            division_code_param: divisionCode,
            section_code_param: sectionCode,
            detailed_section_code_param: detailedSectionCode,
            item_code_param: itemCode
        });
        if (error) throw error;
        
        const valueSelect = document.getElementById('edit-modal-level-value');
        valueSelect.innerHTML = '<option value="">Select value</option>';
        
        if (values && values.length > 0) {
            values.forEach(value => {
                const option = document.createElement('option');
                option.value = value.level_value;
                option.textContent = value.level_value;
                valueSelect.appendChild(option);
            });
        }
        
    } catch (error) {
        console.error('Error loading level values:', error);
    }
}

// Helper function to setup event listeners for edit modal
function setupEditModalEventListeners() {
    // Division change
    const editModalDiv = document.getElementById('edit-modal-division');
    if (editModalDiv) {
        editModalDiv.addEventListener('change', async function() {
        const division = this.value;
        if (division) {
            const divisionCode = division.split(' - ')[0];
            await loadEditModalSections(divisionCode);
        }
        // Reset dependent dropdowns
        document.getElementById('edit-modal-section').innerHTML = '<option value="">Select Section</option>';
        document.getElementById('edit-modal-subsection').innerHTML = '<option value="">Select Detailed Section</option>';
        document.getElementById('edit-modal-item').innerHTML = '<option value="">Select Item</option>';
        document.getElementById('edit-modal-level-value').innerHTML = '<option value="">Select value</option>';
        });
    }
    
    // Section change
    const editModalSec = document.getElementById('edit-modal-section');
    if (editModalSec) {
        editModalSec.addEventListener('change', async function() {
        const division = document.getElementById('edit-modal-division').value;
        const section = this.value;
        if (division && section) {
            const divisionCode = division.split(' - ')[0];
            const sectionCode = section.split(' - ')[0];
            await loadEditModalSubsections(divisionCode, sectionCode);
        }
        // Reset dependent dropdowns
        document.getElementById('edit-modal-subsection').innerHTML = '<option value="">Select Detailed Section</option>';
        document.getElementById('edit-modal-item').innerHTML = '<option value="">Select Item</option>';
        document.getElementById('edit-modal-level-value').innerHTML = '<option value="">Select value</option>';
        });
    }
    
    // Subsection change
    const editModalSub = document.getElementById('edit-modal-subsection');
    if (editModalSub) {
        editModalSub.addEventListener('change', async function() {
        const division = document.getElementById('edit-modal-division').value;
        const section = document.getElementById('edit-modal-section').value;
        const subsection = this.value;
        if (division && section && subsection) {
            const divisionCode = division.split(' - ')[0];
            const sectionCode = section.split(' - ')[0];
            const detailedSectionCode = subsection.split(' - ')[0];
            await loadEditModalItems(divisionCode, sectionCode, detailedSectionCode);
        }
        // Reset dependent dropdowns
        document.getElementById('edit-modal-item').innerHTML = '<option value="">Select Item</option>';
        document.getElementById('edit-modal-level-value').innerHTML = '<option value="">Select value</option>';
        });
    }
    
    // Item change
    const editModalItem = document.getElementById('edit-modal-item');
    if (editModalItem) {
        editModalItem.addEventListener('change', async function() {
        const division = document.getElementById('edit-modal-division').value;
        const section = document.getElementById('edit-modal-section').value;
        const subsection = document.getElementById('edit-modal-subsection').value;
        const item = this.value;
        if (division && section && subsection && item) {
            const divisionCode = division.split(' - ')[0];
            const sectionCode = section.split(' - ')[0];
            const detailedSectionCode = subsection.split(' - ')[0];
            const itemCode = item.split(' - ')[0];
            await loadEditModalLevelValues(divisionCode, sectionCode, detailedSectionCode, itemCode);
        }
        });
    }
}

// Helper function to display attributes in edit modal
function loadEditModalAttributesDisplay(attributes) {
    const container = document.getElementById('edit-project-attributes');
    container.innerHTML = '';
    
    if (!attributes || attributes.length === 0) {
        container.innerHTML = '<p class="text-gray-500 italic">No attributes defined for this project.</p>';
        return;
    }
    
    attributes.forEach((attr, index) => {
        const attributeDiv = document.createElement('div');
        attributeDiv.className = 'border border-gray-200 rounded-lg p-3 bg-white';
        attributeDiv.innerHTML = `
            <div class="flex justify-between items-start mb-2">
                <div class="flex-1">
                    <input type="text" value="${attr.attribute_name}" placeholder="Attribute Name" 
                           class="edit-attr-name w-full px-2 py-1 border border-gray-300 rounded text-sm font-medium">
                </div>
                <button onclick="removeEditModalAttribute(this)" class="ml-2 text-red-600 hover:text-red-800">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <div class="mb-2">
                <div class="flex items-center space-x-4 mb-2">
                    <label class="flex items-center">
                        <input type="checkbox" ${attr.is_mandatory ? 'checked' : ''} class="edit-attr-mandatory mr-1">
                        <span class="text-sm">Mandatory</span>
                    </label>
                    <label class="flex items-center">
                        <input type="checkbox" ${attr.is_manual_entry ? 'checked' : ''} class="edit-attr-manual mr-1">
                        <span class="text-sm">Manual Entry</span>
                    </label>
                </div>
                <div class="edit-standard-values">
                    ${generateEditStandardValuesHTML(attr.standard_values || [])}
                </div>
                <button onclick="addStandardValueToEditModal(this)" class="mt-2 text-blue-600 hover:text-blue-800 text-sm">
                    + Add Standard Value
                </button>
            </div>
        `;
        container.appendChild(attributeDiv);
    });
}

// Helper function to generate standard values HTML for edit modal
function generateEditStandardValuesHTML(standardValues) {
    if (!standardValues || standardValues.length === 0) {
        return '<p class="text-gray-500 text-sm italic">No standard values defined</p>';
    }
    
    return standardValues.map(value => `
        <div class="standard-value-item flex items-center space-x-2 mb-1">
            <input type="text" value="${value.name || ''}" placeholder="Value" 
                   class="standard-value-name flex-1 px-2 py-1 border border-gray-300 rounded text-sm">
            <input type="text" value="${value.unit || ''}" placeholder="Unit" 
                   class="standard-value-unit w-20 px-2 py-1 border border-gray-300 rounded text-sm">
            <button onclick="removeEditStandardValue(this)" class="text-red-600 hover:text-red-800">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
    `).join('');
}

// Helper functions for edit modal attribute management
function removeEditModalAttribute(button) {
    const attributeDiv = button.closest('.border');
    attributeDiv.remove();
    
    const container = document.getElementById('edit-project-attributes');
    if (container.children.length === 0) {
        container.innerHTML = '<p class="text-gray-500 italic">No attributes defined for this project.</p>';
    }
}

function addStandardValueToEditModal(button) {
    const attributeDiv = button.closest('.border');
    const valuesContainer = attributeDiv.querySelector('.edit-standard-values');
    
    // Remove "no values" message if it exists
    const noValuesMsg = valuesContainer.querySelector('p.text-gray-500');
    if (noValuesMsg) {
        noValuesMsg.remove();
    }
    
    const valueDiv = document.createElement('div');
    valueDiv.className = 'standard-value-item flex items-center space-x-2 mb-1';
    valueDiv.innerHTML = `
        <input type="text" value="" placeholder="Value" 
               class="standard-value-name flex-1 px-2 py-1 border border-gray-300 rounded text-sm">
        <input type="text" value="" placeholder="Unit" 
               class="standard-value-unit w-20 px-2 py-1 border border-gray-300 rounded text-sm">
        <button onclick="removeEditStandardValue(this)" class="text-red-600 hover:text-red-800">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
        </button>
    `;
    valuesContainer.appendChild(valueDiv);
}
// =========================================================
// VIEW PROJECT FUNCTIONS
// =========================================================

async function openViewProjectModal(projectId) {
    try {
        showLoadingScreen('Loading project details...', 'Fetching Data');
        
        // Load project details with related data
        const { data: project, error: projectError } = await supabase
            .from('classification_projects')
            .select(`
                *,
                creator:users!classification_projects_created_by_fkey(username, email),
                reviewer:users!classification_projects_assigned_reviewer_id_fkey(username, email)
            `)
            .eq('id', projectId)
            .single();

        if (projectError) throw projectError;

        // Load project attributes
        const { data: attributes, error: attrError } = await supabase
            .from('project_attributes')
            .select('*')
            .eq('project_id', projectId)
            .order('attribute_name');

        if (attrError) throw attrError;

        // Show modal
        showModal(document.getElementById('view-project-modal'));

        // Populate project information
        document.getElementById('view-project-name').textContent = project.project_name;
        
        const statusDisplay = {
            'draft': 'Draft',
            'submitted': 'Pending Review',
            'reviewer_approved': 'Pending Admin Approval',
            'reviewer_rejected': 'Reviewer Rejected',
            'admin_approved': 'Admin Approved',
            'admin_rejected': 'Admin Rejected'
        }[project.status] || project.status;
        
        const statusColor = {
            'draft': 'text-gray-600',
            'submitted': 'text-yellow-600',
            'reviewer_approved': 'text-blue-600',
            'reviewer_rejected': 'text-orange-600',
            'admin_approved': 'text-green-600',
            'admin_rejected': 'text-red-600'
        }[project.status] || 'text-gray-600';
        
        document.getElementById('view-project-status').innerHTML = `<span class="${statusColor} font-medium">${statusDisplay}</span>`;
        document.getElementById('view-project-created').textContent = new Date(project.created_at).toLocaleString();
        document.getElementById('view-project-updated').textContent = project.updated_at ? new Date(project.updated_at).toLocaleString() : 'Not updated';
        document.getElementById('view-project-creator').textContent = project.creator ? `${project.creator.username} (${project.creator.email})` : 'Unknown';
        document.getElementById('view-project-reviewer').textContent = project.reviewer ? `${project.reviewer.username} (${project.reviewer.email})` : 'Not assigned';

        // Load and display CSI descriptions
        await displayViewCSIPath(project);

        // Display project history
        displayProjectHistory(project);

        // Display attributes
        displayViewAttributes(attributes);

        // Display comments if any
        displayViewComments(project);
        
        hideLoadingScreen();

    } catch (error) {
        hideLoadingScreen();
        console.error('Error loading project for view:', error);
        showMessageBox(`Failed to load project: ${error.message}`, true);
    }
}

async function displayViewCSIPath(project) {
    try {
        // Get descriptions for each level
        const divisionDesc = await getDivisionDescription(project.division_code);
        const sectionDesc = await getSectionDescription(project.section_code);
        const detailedSectionDesc = await getDetailedSectionDescription(project.detailed_section_code);
        const itemDesc = await getItemDescription(project.item_code);

        const pathHtml = `
            <div><strong>Division:</strong> ${project.division_code} - ${divisionDesc}</div>
            <div><strong>Section:</strong> ${project.section_code} - ${sectionDesc}</div>
            <div><strong>Detailed Section:</strong> ${project.detailed_section_code} - ${detailedSectionDesc}</div>
            <div><strong>Item:</strong> ${project.item_code} - ${itemDesc}</div>
        `;
        
        document.getElementById('view-csi-path').innerHTML = pathHtml;

        // Additional level if exists
        if (project.additional_level_name && project.additional_level_value) {
            document.getElementById('view-additional-level').innerHTML = `
                <strong>Additional Level:</strong> ${project.additional_level_name} > ${project.additional_level_value}
            `;
            document.getElementById('view-additional-level').style.display = 'block';
        } else {
            document.getElementById('view-additional-level').style.display = 'none';
        }
    } catch (error) {
        console.error('Error loading CSI descriptions:', error);
        document.getElementById('view-csi-path').innerHTML = `
            <div><strong>Division:</strong> ${project.division_code}</div>
            <div><strong>Section:</strong> ${project.section_code}</div>
            <div><strong>Detailed Section:</strong> ${project.detailed_section_code}</div>
            <div><strong>Item:</strong> ${project.item_code}</div>
        `;
    }
}

function displayProjectHistory(project) {
    let historyHtml = '';
    
    historyHtml += `<div class="flex justify-between"><span>Created:</span><span>${new Date(project.created_at).toLocaleString()}</span></div>`;
    
    if (project.submitted_at) {
        historyHtml += `<div class="flex justify-between"><span>Submitted for Review:</span><span>${new Date(project.submitted_at).toLocaleString()}</span></div>`;
    }
    
    if (project.reviewed_at) {
        historyHtml += `<div class="flex justify-between"><span>Reviewed:</span><span>${new Date(project.reviewed_at).toLocaleString()}</span></div>`;
    }
    
    if (project.admin_reviewed_at) {
        historyHtml += `<div class="flex justify-between"><span>Admin Reviewed:</span><span>${new Date(project.admin_reviewed_at).toLocaleString()}</span></div>`;
    }
    
    if (project.updated_at && project.updated_at !== project.created_at) {
        historyHtml += `<div class="flex justify-between"><span>Last Modified:</span><span>${new Date(project.updated_at).toLocaleString()}</span></div>`;
    }
    
    document.getElementById('view-project-history').innerHTML = historyHtml || '<div class="text-gray-500">No history available</div>';
}

function displayViewAttributes(attributes) {
    if (!attributes || attributes.length === 0) {
        document.getElementById('view-project-attributes').innerHTML = '<div class="text-gray-500 text-center py-4">No attributes found</div>';
        return;
    }

    let html = '';
    attributes.forEach((attr, index) => {
        html += `
            <div class="p-3 bg-white border border-gray-200 rounded-md">
                <div class="flex justify-between items-start mb-2">
                    <div class="flex items-center gap-2">
                        <div class="font-medium text-gray-900">${attr.attribute_name}</div>
                        ${attr.is_mandatory ? '<span class="text-xs bg-red-100 text-red-800 px-2 py-1 rounded">Mandatory</span>' : '<span class="text-xs bg-gray-100 text-gray-600 px-2 py-1 rounded">Optional</span>'}
                        ${attr.is_manual_entry ? '<span class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded">Manual Entry</span>' : '<span class="text-xs bg-green-100 text-green-800 px-2 py-1 rounded">Predefined Values</span>'}
                    </div>
                </div>
                <div>
                    ${attr.is_manual_entry ? `
                        <div class="p-3 bg-blue-50 border border-blue-200 rounded-lg">
                            <div class="flex items-center gap-2 mb-1">
                                <svg class="w-4 h-4 text-blue-600" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z"></path>
                                </svg>
                                <span class="text-sm font-semibold text-blue-800">Manual Entry Field</span>
                            </div>
                            <div class="text-sm text-blue-700">Users will input values freely during code generation</div>
                        </div>
                    ` : `
                        <div class="text-sm text-gray-600 mb-2">Predefined Values (dropdown selection):</div>
                        <div class="flex flex-wrap gap-2 mt-1">
                            ${attr.standard_values.map(val => `
                                <span class="bg-gray-100 text-gray-700 px-3 py-1 rounded-full text-sm">
                                    ${val.name} ${val.unit ? `(${val.unit})` : ''}
                                </span>
                            `).join('')}
                        </div>
                    `}
                </div>
            </div>
        `;
    });

    document.getElementById('view-project-attributes').innerHTML = html;
}
function displayViewComments(project) {
    let commentsHtml = '';
    
    if (project.reviewer_comments) {
        commentsHtml += `
            <div class="p-3 bg-orange-50 border border-orange-200 rounded">
                <div class="font-medium text-orange-800 mb-1">Reviewer Comments:</div>
                <div class="text-orange-700 text-sm">${project.reviewer_comments}</div>
            </div>
        `;
    }
    
    if (project.admin_comments) {
        commentsHtml += `
            <div class="p-3 bg-red-50 border border-red-200 rounded">
                <div class="font-medium text-red-800 mb-1">Admin Comments:</div>
                <div class="text-red-700 text-sm">${project.admin_comments}</div>
            </div>
        `;
    }
    
    if (commentsHtml) {
        document.getElementById('view-project-comments').innerHTML = commentsHtml;
        document.getElementById('view-comments-section').style.display = 'block';
    } else {
        document.getElementById('view-comments-section').style.display = 'none';
    }
}
// =========================================================
        // EVENT LISTENERS (ENHANCED WITH NEW FEATURES)
        // =========================================================

        // Login form
        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            login(email, password);
        });

        // Logout and debug buttons
        logoutBtn.addEventListener('click', logout);
        debugBtn.addEventListener('click', debugSystem);

        // Draft management
        closeDraftBtn.addEventListener('click', closeDraft);

        // Tab navigation
        tabCreate.addEventListener('click', () => switchTab('create'));
        tabProjects.addEventListener('click', () => switchTab('projects'));
        tabAdmin.addEventListener('click', () => switchTab('admin'));
        tabDashboard.addEventListener('click', () => switchTab('dashboard'));
        const tabCSIManagement = document.getElementById('tab-csi-management');
        if (tabCSIManagement) {
            tabCSIManagement.addEventListener('click', () => switchTab('csi-management'));
        }
        // Projects refresh
        refreshProjectsBtn.addEventListener('click', loadUserProjects);

        // CSI hierarchy selects
        divisionSelect.addEventListener('change', (e) => {
            const divisionCode = e.target.value.split(' - ')[0];
            if (divisionCode) {
                loadSections(divisionCode);
                // Reset subsequent selects
                sectionSelect.innerHTML = '<option value="">Select Section</option>';
                subsectionSelect.innerHTML = '<option value="">Select Detailed Section</option>';
                itemSelect.innerHTML = '<option value="">Select Item</option>';
                subsectionSelect.disabled = true;
                itemSelect.disabled = true;
                attributeCreationSection.classList.add('disabled-section');
                additionalLevelsSection.classList.add('disabled-section');
            }
            renderCurrentPath();
        });

        sectionSelect.addEventListener('change', (e) => {
            const divisionCode = divisionSelect.value.split(' - ')[0];
            const sectionCode = e.target.value.split(' - ')[0];
            if (divisionCode && sectionCode) {
                loadDetailedSections(divisionCode, sectionCode);
                // Reset subsequent selects
                subsectionSelect.innerHTML = '<option value="">Select Detailed Section</option>';
                itemSelect.innerHTML = '<option value="">Select Item</option>';
                itemSelect.disabled = true;
                attributeCreationSection.classList.add('disabled-section');
                additionalLevelsSection.classList.add('disabled-section');
            }
            renderCurrentPath();
        });

        subsectionSelect.addEventListener('change', (e) => {
            const divisionCode = divisionSelect.value.split(' - ')[0];
            const sectionCode = sectionSelect.value.split(' - ')[0];
            const detailedSectionCode = e.target.value.split(' - ')[0];
            if (divisionCode && sectionCode && detailedSectionCode) {
                loadItems(divisionCode, sectionCode, detailedSectionCode);
                // Reset subsequent selects
                itemSelect.innerHTML = '<option value="">Select Item</option>';
                attributeCreationSection.classList.add('disabled-section');
                additionalLevelsSection.classList.add('disabled-section');
            }
            renderCurrentPath();
        });

        itemSelect.addEventListener('change', async (e) => {
    const divisionCode = divisionSelect.value.split(' - ')[0];
    const sectionCode = sectionSelect.value.split(' - ')[0];
    const detailedSectionCode = subsectionSelect.value.split(' - ')[0];
    const itemCode = e.target.value.split(' - ')[0];
    if (divisionCode && sectionCode && detailedSectionCode && itemCode) {
        additionalLevelsSection.classList.remove('disabled-section');
        loadAdditionalLevel(divisionCode, sectionCode, detailedSectionCode, itemCode);
        
        // Check path availability
        await validateAndEnableAttributeCreation();
    }
    renderCurrentPath();
});

        // Additional level management
        addLevelValueBtn.addEventListener('click', addAdditionalLevelValue);

        additionalLevelSelect.addEventListener('change', async () => {
    renderCurrentPath();
    
    // Check path availability when additional level is selected
    const { division, section, subsection, item } = getSelectedPath();
    if (division && section && subsection && item) {
        await validateAndEnableAttributeCreation();
    }
});

       // Attribute value management
addAttributeValueBtn.addEventListener('click', (e) => {
    const manualEntryCheckbox = document.getElementById('manual-entry-checkbox');
    
    if (manualEntryCheckbox.checked) {
        e.preventDefault();
        showMessageBox('Cannot add standard values for manual entry attributes.', true);
        return;
    }
    
    const newRow = document.createElement('div');
    newRow.className = 'flex space-x-2 items-center standard-value-row';
    newRow.innerHTML = `
        <input type="text" class="attribute-value-name-input flex-1 px-3 py-2 text-base border-gray-300 rounded-md shadow-sm" placeholder="Value Name">
        <select class="attribute-value-unit-select w-32 px-3 py-2 text-base border-gray-300 rounded-md shadow-sm">
            <option value="">UOM</option>
        </select>
        <button class="remove-value-btn px-2 py-1 bg-red-500 text-white rounded-md hover:bg-red-600 text-sm" onclick="removeStandardValue(this)">Remove</button>
    `;
    attributeStandardValuesContainer.appendChild(newRow);
    updateUOMSelects();
    updateRemoveButtons();
});     
// Edit modal value management
addEditValueBtn.addEventListener('click', () => {
    const newRow = document.createElement('div');
    newRow.className = 'flex space-x-2 items-center edit-value-row';
    newRow.innerHTML = `
        <input type="text" class="edit-value-name-input flex-1 px-3 py-2 text-base border-gray-300 rounded-md shadow-sm" placeholder="Value Name">
        <select class="edit-value-unit-select w-32 px-3 py-2 text-base border-gray-300 rounded-md shadow-sm">
            <option value="">UOM</option>
        </select>
        <button class="remove-edit-value-btn px-2 py-1 bg-red-500 text-white rounded-md hover:bg-red-600 text-sm" onclick="removeEditStandardValue(this)">Remove</button>
    `;
    editValuesContainer.appendChild(newRow);

    // Populate UOM options
    const select = newRow.querySelector('.edit-value-unit-select');
    availableUOMs.forEach(uom => {
        const option = document.createElement('option');
        option.value = uom.uom_symbol || uom.uom_name;
        option.textContent = `${uom.uom_name} (${uom.uom_symbol || uom.uom_name})`;
        select.appendChild(option);
    });

    updateEditRemoveButtons();
});

        // Edit modal buttons
        saveEditBtn.addEventListener('click', saveEditedAttribute);
        cancelEditBtn.addEventListener('click', () => {
            editingAttribute = null;
            hideModal(editAttributeModal);
        });

        // Add attribute
        addAttributeBtn.addEventListener('click', addAttribute);
// Manual entry checkbox - DIRECT approach
document.getElementById('manual-entry-checkbox').addEventListener('change', function() {
    const isChecked = this.checked;
    const container = document.getElementById('attribute-standard-values-container');
    const addBtn = document.getElementById('add-attribute-value-btn');
    const label = container.parentElement.querySelector('label');
    
    if (isChecked) {
        // HIDE AND CLEAR EVERYTHING
        label.style.display = 'none';
        container.style.display = 'none';
        addBtn.style.display = 'none';
        container.innerHTML = '';
    } else {
        // SHOW EVERYTHING AND RESTORE
        label.style.display = 'block';
        container.style.display = 'block';
        addBtn.style.display = 'inline-block';
        container.innerHTML = `
            <div class="flex space-x-2 items-center standard-value-row">
                <input type="text" class="attribute-value-name-input flex-1 px-3 py-2 text-base border-gray-300 rounded-md shadow-sm" placeholder="Value Name">
                <select class="attribute-value-unit-select w-32 px-3 py-2 text-base border-gray-300 rounded-md shadow-sm">
                    <option value="">UOM</option>
                </select>
                <button class="remove-value-btn px-2 py-1 bg-red-500 text-white rounded-md hover:bg-red-600 text-sm hidden" onclick="removeStandardValue(this)">Remove</button>
            </div>
        `;
        updateUOMSelects();
        updateRemoveButtons();
    }
});
        // Action buttons
        saveDraftBtn.addEventListener('click', saveProjectAsDraft);
        submitForReviewBtn.addEventListener('click', submitProjectForReview);
        clearAllBtn.addEventListener('click', clearAllData);
        exportExcelBtn.addEventListener('click', performExcelExport);
        // Excel import
        document.getElementById('import-excel-btn').addEventListener('click', importExcelFile);
        // Review submission
        confirmSubmitBtn.addEventListener('click', confirmSubmission);
        cancelSubmitBtn.addEventListener('click', cancelSubmission);

        // Message box
        messageBoxOkBtn.addEventListener('click', () => {
            hideModal(messageBoxModal);
        });

        // CSI Management buttons
        const csiSaveChangesBtn = document.getElementById('csi-save-changes-btn');
        const csiDiscardChangesBtn = document.getElementById('csi-discard-changes-btn');
        
        if (csiSaveChangesBtn) {
            csiSaveChangesBtn.addEventListener('click', saveCSIChanges);
        }
        if (csiDiscardChangesBtn) {
            csiDiscardChangesBtn.addEventListener('click', discardCSIChanges);
        }








// Edit modal CSI hierarchy changes
const editModalDivision = document.getElementById('edit-modal-division');
if (editModalDivision) {
    editModalDivision.addEventListener('change', async (e) => {
    const divisionCode = e.target.value.split(' - ')[0];
    if (divisionCode) {
        const { data } = await supabase.rpc('get_sections', { division_code_param: divisionCode });
        const sectionSelect = document.getElementById('edit-modal-section');
        sectionSelect.innerHTML = '<option value="">Select Section</option>';
        sectionSelect.disabled = false;
        if (data) {
            data.forEach(sec => {
                const option = document.createElement('option');
                option.value = `${sec.section_code} - ${sec.section_description}`;
                option.textContent = `${sec.section_code} - ${sec.section_description}`;
                sectionSelect.appendChild(option);
            });
        }
    }
    });
}

const editModalSection = document.getElementById('edit-modal-section');
if (editModalSection) {
    editModalSection.addEventListener('change', async (e) => {
    const divisionCode = document.getElementById('edit-modal-division').value.split(' - ')[0];
    const sectionCode = e.target.value.split(' - ')[0];
    if (divisionCode && sectionCode) {
        const { data } = await supabase.rpc('get_detailed_sections', {
            division_code_param: divisionCode,
            section_code_param: sectionCode
        });
        const subsectionSelect = document.getElementById('edit-modal-subsection');
        subsectionSelect.innerHTML = '<option value="">Select Detailed Section</option>';
        subsectionSelect.disabled = false;
        if (data) {
            data.forEach(sub => {
                const option = document.createElement('option');
                option.value = `${sub.detailed_section_code} - ${sub.detailed_section_description}`;
                option.textContent = `${sub.detailed_section_code} - ${sub.detailed_section_description}`;
                subsectionSelect.appendChild(option);
            });
        }
    }
});
}

const editModalSubsection = document.getElementById('edit-modal-subsection');
if (editModalSubsection) {
    editModalSubsection.addEventListener('change', async (e) => {
    const divisionCode = document.getElementById('edit-modal-division').value.split(' - ')[0];
    const sectionCode = document.getElementById('edit-modal-section').value.split(' - ')[0];
    const detailedSectionCode = e.target.value.split(' - ')[0];
    if (divisionCode && sectionCode && detailedSectionCode) {
        const { data } = await supabase.rpc('get_items', {
            division_code_param: divisionCode,
            section_code_param: sectionCode,
            detailed_section_code_param: detailedSectionCode
        });
        const itemSelect = document.getElementById('edit-modal-item');
        itemSelect.innerHTML = '<option value="">Select Item</option>';
        itemSelect.disabled = false;
        if (data) {
            data.forEach(item => {
                const option = document.createElement('option');
                option.value = `${item.item_code} - ${item.item_description}`;
                option.textContent = `${item.item_code} - ${item.item_description}`;
                itemSelect.appendChild(option);
            });
        }
    }
});
}

       
                
        // =========================================================
        // INITIALIZATION
        // =========================================================
// =========================================================
// CREATE USER FUNCTIONALITY
// =========================================================

function initializeCreateUserFunctionality() {
    console.log('Initializing create user functionality...');
    
    const createUserBtn = document.getElementById('create-user-btn');
    const cancelCreateUserBtn = document.getElementById('cancel-create-user');
    const createUserForm = document.getElementById('create-user-form');
    const createUserModal = document.getElementById('create-user-modal');
    
    console.log('Elements found:', {
        createUserBtn: !!createUserBtn,
        cancelCreateUserBtn: !!cancelCreateUserBtn,
        createUserForm: !!createUserForm,
        createUserModal: !!createUserModal
    });
    
    // Create user button click handler
    if (createUserBtn) {
        // Remove any existing listeners
        createUserBtn.replaceWith(createUserBtn.cloneNode(true));
        const newCreateUserBtn = document.getElementById('create-user-btn');
        
        newCreateUserBtn.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            console.log('Create user button clicked');
            
            if (createUserModal) {
                showModal(createUserModal);
            } else {
                console.error('Create user modal not found');
                showMessageBox('Error: Create user modal not found', true);
            }
        });
        console.log('Create user button event listener attached');
    } else {
        console.error('Create user button not found');
    }
    
    // Cancel button click handler
    if (cancelCreateUserBtn) {
        cancelCreateUserBtn.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            console.log('Cancel button clicked');
            
            if (createUserModal) {
                hideModal(createUserModal);
                // Reset form
                if (createUserForm) {
                    createUserForm.reset();
                }
            }
        });
        console.log('Cancel button event listener attached');
    }
    
    // Form submission handler
    if (createUserForm) {
        createUserForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            e.stopPropagation();
            console.log('Create user form submitted');
            
            try {
                const email = document.getElementById('new-email').value.trim();
                const password = document.getElementById('new-password').value.trim();
                const username = document.getElementById('new-username').value.trim();
                const role = document.getElementById('new-role').value;

                console.log('Form data:', { email, username, role, passwordLength: password.length });

                // Validation
                if (!email || !password || !username || !role) {
                    showMessageBox('Please fill in all fields.', true);
                    return;
                }

                if (password.length < 6) {
                    showMessageBox('Password must be at least 6 characters long.', true);
                    return;
                }

                if (!email.includes('@')) {
                    showMessageBox('Please enter a valid email address.', true);
                    return;
                }

                showLoadingScreen('Creating user...', 'Please wait');

                console.log('Attempting to insert user into database...');

                // Insert user directly into the database
                const { data, error } = await supabase
                    .from('users')
                    .insert({
                        email: email,
                        password: password,
                        username: username,
                        role: role,
                        status: 'active'
                    })
                    .select()
                    .single();

                console.log('Database response:', { data, error });

                if (error) {
                    console.error('Database error:', error);
                    hideLoadingScreen();
                    
                    if (error.code === '23505') {
                        showMessageBox('A user with this email already exists.', true);
                    } else {
                        showMessageBox(`Database error: ${error.message}`, true);
                    }
                    return;
                }

                hideLoadingScreen();
                
                if (createUserModal) {
                    hideModal(createUserModal);
                }
                
                showMessageBox('User created successfully!');
                
                // Clear form
                createUserForm.reset();
                
                // Refresh user list if we're on admin tab
                if (typeof loadUsers === 'function') {
                    loadUsers();
                }

            } catch (error) {
                hideLoadingScreen();
                console.error('Unexpected error creating user:', error);
                showMessageBox(`Failed to create user: ${error.message}`, true);
            }
        });
        console.log('Form submission event listener attached');
    } else {
        console.error('Create user form not found');
    }
}
// Message box
messageBoxOkBtn.addEventListener('click', () => {
    hideModal(messageBoxModal);
});

// Add event listener for edit modal manual entry checkbox  
document.getElementById('edit-manual-entry-checkbox').addEventListener('change', toggleEditStandardValuesSection);
        // Check if user is already logged in (for development)
        document.addEventListener('DOMContentLoaded', () => {
    console.log('DOM Content Loaded - Initializing...');
    
    // Show login modal by default
    const loginModal = document.getElementById('login-modal');
    if (loginModal) {
        showModal(loginModal);
    }

    console.log('CSI Attribute Portal initialized');
});
function addNewAttributeToEditModal() {
    if (!window.editingProjectData) {
        showMessageBox('No project data available for editing.', true);
        return;
    }
    
    const newAttribute = {
        attribute_name: 'New Attribute',
        standard_values: [{ name: 'Value 1', unit: '' }],
        is_mandatory: false,
        is_manual_entry: false
    };
    
    // Add to the project data
    if (!window.editingProjectData.attributes) {
        window.editingProjectData.attributes = [];
    }
    window.editingProjectData.attributes.push(newAttribute);
    
    // Refresh the display using the correct function name
    loadEditModalAttributesDisplay(window.editingProjectData.attributes);
    
    showMessageBox('New attribute added. Remember to save your changes.');
}
function removeProjectAttribute(index) {
    if (confirm('Are you sure you want to remove this attribute?')) {
        editingProjectData.attributes.splice(index, 1);
        displayEditModalAttributes(editingProjectData.attributes);
        showMessageBox('Attribute removed from project.');
    }
}
// =========================================================
// ADMIN DASHBOARD FUNCTIONS
// =========================================================

// Initialize import history at global scope
window.importHistory = window.importHistory || [];

async function loadAdminDashboard() {
    if (currentUser && currentUser.role === 'admin') {
        await loadDashboardStats();
        await loadCSIStatistics();
    }
}

async function loadDashboardStats() {
    try {
        showLoadingScreen('Loading dashboard data...', 'Please wait');
        
        const { data, error } = await supabase.rpc('get_admin_csi_dashboard_stats');
        
        if (error) throw error;
        
        if (data) {
            // Update main statistics
            document.getElementById('total-csi-paths').textContent = data.total_csi_paths || 0;
            document.getElementById('approved-paths').textContent = data.paths_with_approved_projects || 0;
            document.getElementById('pending-paths').textContent = data.paths_with_pending_projects || 0;
            document.getElementById('draft-paths').textContent = data.paths_with_draft_projects || 0;
            document.getElementById('no-project-paths').textContent = data.paths_without_projects || 0;
            document.getElementById('coverage-percentage').textContent = `${data.coverage_percentage || 0}%`;
            
            // Update additional level stats
            document.getElementById('additional-level-paths').textContent = data.paths_with_additional_levels || 0;
            document.getElementById('base-paths-only').textContent = (data.total_csi_paths - data.paths_with_additional_levels) || 0;
            
            // Update progress bars
            updateDashboardProgressBars(data);
            
            // Update coverage text
            document.getElementById('coverage-text').textContent = `${data.coverage_percentage || 0}% covered`;
        }
        
        hideLoadingScreen();
    } catch (error) {
        hideLoadingScreen();
        console.error('Error loading dashboard stats:', error);
        showMessageBox(`Failed to load dashboard statistics: ${error.message}`, true);
    }
}

function updateDashboardProgressBars(data) {
    const total = data.total_csi_paths || 1; // Avoid division by zero
    
    // Coverage bar
    const coveragePercent = data.coverage_percentage || 0;
    document.getElementById('coverage-bar').style.width = `${coveragePercent}%`;
    
    // Status distribution bars
    const approvedPercent = ((data.paths_with_approved_projects || 0) / total) * 100;
    const pendingPercent = ((data.paths_with_pending_projects || 0) / total) * 100;
    const draftPercent = ((data.paths_with_draft_projects || 0) / total) * 100;
    const noProjectPercent = ((data.paths_without_projects || 0) / total) * 100;
    
    document.getElementById('approved-bar').style.width = `${approvedPercent}%`;
    document.getElementById('pending-bar').style.width = `${pendingPercent}%`;
    document.getElementById('draft-bar').style.width = `${draftPercent}%`;
    document.getElementById('no-project-bar').style.width = `${noProjectPercent}%`;
}

// =========================================================
// CSI IMPORT MANAGEMENT FUNCTIONS
// =========================================================

function initializeCSIManagement() {
    if (currentUser && currentUser.role === 'admin') {
        setupCSIEventListeners();
    }
}

function setupCSIEventListeners() {
    // Import CSI button
    const importBtn = document.getElementById('import-csi-btn');
    if (importBtn) {
        importBtn.addEventListener('click', importCSIHierarchy);
    }
    
    // Export CSI button
    const exportBtn = document.getElementById('export-csi-btn');
    if (exportBtn) {
        exportBtn.addEventListener('click', exportCSIHierarchy);
    }
    
    // Clear CSI button
    const clearBtn = document.getElementById('clear-csi-btn');
    if (clearBtn) {
        clearBtn.addEventListener('click', clearCSIHierarchy);
    }
    
    // Refresh dashboard button
    const refreshBtn = document.getElementById('refresh-dashboard-btn');
    if (refreshBtn) {
        refreshBtn.addEventListener('click', loadAdminDashboard);
    }
    
    // CSI Path Management buttons
    const saveChangesBtn = document.getElementById('csi-save-changes-btn');
    if (saveChangesBtn) {
        saveChangesBtn.addEventListener('click', saveAllCSIChanges);
    }
    
    const discardChangesBtn = document.getElementById('csi-discard-changes-btn');
    if (discardChangesBtn) {
        discardChangesBtn.addEventListener('click', discardAllCSIChanges);
    }
}

async function loadCSIStatistics() {
    try {
        const { data, error } = await supabase.rpc('get_csi_statistics');
        
        if (error) throw error;
        
        if (data) {
            document.getElementById('csi-divisions-count').textContent = data.divisions || 0;
            document.getElementById('csi-sections-count').textContent = data.sections || 0;
            document.getElementById('csi-detailed-sections-count').textContent = data.detailed_sections || 0;
            document.getElementById('csi-items-count').textContent = data.items || 0;
        }
    } catch (error) {
        console.error('Error loading CSI statistics:', error);
    }
}

async function importCSIHierarchy() {
    const fileInput = document.getElementById('csi-import-input');
    const file = fileInput.files[0];

    if (!file) {
        showMessageBox('Please select an Excel file to import.', true);
        return;
    }

    if (currentUser.role !== 'admin') {
        showMessageBox('Only administrators can import CSI hierarchy data.', true);
        return;
    }

    try {
        showImportProgress(true);
        updateImportProgress(0, 'Reading Excel file...');
        
        const data = await file.arrayBuffer();
        const workbook = XLSX.read(data, { type: 'array' });
        const sheetName = workbook.SheetNames[0];
        const worksheet = workbook.Sheets[sheetName];
        const jsonData = XLSX.utils.sheet_to_json(worksheet);

        if (!jsonData || jsonData.length === 0) {
            showImportProgress(false);
            showMessageBox('The Excel file is empty or invalid.', true);
            return;
        }

        updateImportProgress(10, 'Validating data structure...');

        // Get available columns from the first row
        const firstRow = jsonData[0];
        const availableColumns = Object.keys(firstRow);
        console.log('Available columns:', availableColumns);

        // Flexible column mapping - check for various possible column name variations
        function findColumn(possibleNames) {
            for (const name of possibleNames) {
                const found = availableColumns.find(col => 
                    col.toLowerCase().trim().includes(name.toLowerCase()) ||
                    col.toLowerCase().trim() === name.toLowerCase()
                );
                if (found) return found;
            }
            return null;
        }

        // Map columns with flexible naming
        const columnMap = {
            divisionCode: findColumn(['division code', 'div code', 'division_code', 'divisioncode']),
            divisionDesc: findColumn(['division description', 'div description', 'division_description', 'divisiondescription', 'division desc']),
            sectionCode: findColumn(['section code', 'sec code', 'section_code', 'sectioncode']),
            sectionDesc: findColumn(['section description', 'sec description', 'section_description', 'sectiondescription', 'section desc']),
            detailedSectionCode: findColumn(['detailed section code', 'detail section code', 'detailed_section_code', 'detailedsectioncode', 'subsection code']),
            detailedSectionDesc: findColumn(['detailed section description', 'detail section description', 'detailed_section_description', 'detailedsectiondescription', 'subsection description', 'detailed section desc']),
            itemCode: findColumn(['item code', 'item_code', 'itemcode']),
            itemDesc: findColumn(['item description', 'item_description', 'itemdescription', 'item desc'])
        };

        console.log('Column mapping:', columnMap);

        // Check for required columns
        const missingColumns = [];
        Object.entries(columnMap).forEach(([key, value]) => {
            if (!value) {
                missingColumns.push(key);
            }
        });

        if (missingColumns.length > 0) {
            showImportProgress(false);
            showMessageBox(`Could not find required columns: ${missingColumns.join(', ')}. Available columns: ${availableColumns.join(', ')}. Please ensure your Excel file has columns for Division Code, Division Description, Section Code, Section Description, Detailed Section Code, Detailed Section Description, Item Code, and Item Description.`, true);
            return;
        }

        // Ask user if they want to clear existing data
        const clearExisting = confirm('Do you want to clear all existing CSI hierarchy data before importing? Click OK to clear and import fresh data, or Cancel to update/add to existing data.');
        
        if (clearExisting) {
            updateImportProgress(15, 'Clearing existing CSI data...');
            const { error: clearError } = await supabase
                .from('csi_hierarchy')
                .delete()
                .neq('id', 0); // Delete all records
            
            if (clearError) {
                showImportProgress(false);
                showMessageBox(`Failed to clear existing data: ${clearError.message}`, true);
                return;
            }
        }
        
        updateImportProgress(20, 'Processing CSI hierarchy data...');
        
        // Reset processed records tracker
        window.processedRecords = new Set();
        let successCount = 0;
        let errorCount = 0;
        const errors = [];

        // Process each row
        for (let i = 0; i < jsonData.length; i++) {
            const row = jsonData[i];
            const progress = 20 + (i / jsonData.length) * 70;
            updateImportProgress(progress, `Processing row ${i + 1} of ${jsonData.length}...`);

            try {
                // Extract and clean data using the mapped columns
                const divisionCode = String(row[columnMap.divisionCode] || '').trim();
                const divisionDesc = String(row[columnMap.divisionDesc] || '').trim();
                const sectionCode = String(row[columnMap.sectionCode] || '').trim();
                const sectionDesc = String(row[columnMap.sectionDesc] || '').trim();
                const detailedSectionCode = String(row[columnMap.detailedSectionCode] || '').trim();
                const detailedSectionDesc = String(row[columnMap.detailedSectionDesc] || '').trim();
                const itemCode = String(row[columnMap.itemCode] || '').trim();
                const itemDesc = String(row[columnMap.itemDesc] || '').trim();

                console.log(`Row ${i + 1}:`, {
                    divisionCode, divisionDesc, sectionCode, sectionDesc,
                    detailedSectionCode, detailedSectionDesc, itemCode, itemDesc
                });

                // Skip empty rows
                if (!divisionCode || !sectionCode || !detailedSectionCode || !itemCode) {
                    console.log(`Skipping row ${i + 1} - missing essential data`);
                    continue;
                }

             // Clean and normalize the codes to prevent constraint violations
                const cleanDivisionCode = divisionCode.replace(/\s+/g, ' ').trim();
                const cleanSectionCode = sectionCode.replace(/\s+/g, ' ').trim();
                const cleanDetailedSectionCode = detailedSectionCode.replace(/\s+/g, ' ').trim();
                const cleanItemCode = itemCode.replace(/\s+/g, ' ').trim();

                // Check for duplicates within the import data
                const recordKey = `${cleanDivisionCode}|${cleanSectionCode}|${cleanDetailedSectionCode}|${cleanItemCode}`;
                
                // Skip if we've already processed this combination in this import
                if (!window.processedRecords) {
                    window.processedRecords = new Set();
                }
                
                if (window.processedRecords.has(recordKey)) {
                    console.log(`Skipping duplicate record in import: ${recordKey}`);
                    continue;
                }
                
                window.processedRecords.add(recordKey);

                // First check if record exists in database
                const { data: existingRecord, error: checkError } = await supabase
                    .from('csi_hierarchy')
                    .select('id')
                    .eq('division_code', cleanDivisionCode)
                    .eq('section_code', cleanSectionCode)
                    .eq('detailed_section_code', cleanDetailedSectionCode)
                    .eq('item_code', cleanItemCode)
                    .limit(1);

                if (checkError) {
                    console.error(`Row ${i + 1} check error:`, checkError);
                    errorCount++;
                    errors.push(`Row ${i + 1}: Error checking existing record: ${checkError.message}`);
                    continue;
                }

                if (existingRecord && existingRecord.length > 0) {
                    // Update existing record
                    const { error: updateError } = await supabase
                        .from('csi_hierarchy')
                        .update({
                            division_description: divisionDesc,
                            section_description: sectionDesc,
                            detailed_section_description: detailedSectionDesc,
                            item_description: itemDesc
                        })
                        .eq('id', existingRecord[0].id);

                    if (updateError) {
                        console.error(`Row ${i + 1} update error:`, updateError);
                        errorCount++;
                        errors.push(`Row ${i + 1}: Error updating record: ${updateError.message}`);
                    } else {
                        successCount++;
                        console.log(`Updated record for row ${i + 1}`);
                    }
                } else {
                    // Insert new record
                    const { error: insertError } = await supabase
                        .from('csi_hierarchy')
                        .insert({
                            division_code: cleanDivisionCode,
                            division_description: divisionDesc,
                            section_code: cleanSectionCode,
                            section_description: sectionDesc,
                            detailed_section_code: cleanDetailedSectionCode,
                            detailed_section_description: detailedSectionDesc,
                            item_code: cleanItemCode,
                            item_description: itemDesc
                        });

                    if (insertError) {
                        console.error(`Row ${i + 1} insert error:`, insertError);
                        errorCount++;
                        errors.push(`Row ${i + 1}: Error inserting record: ${insertError.message}`);
                    } else {
                        successCount++;
                        console.log(`Inserted new record for row ${i + 1}`);
                    }
                }
            } catch (error) {
                errorCount++;
                errors.push(`Row ${i + 1}: ${error.message}`);
                console.error(`Error processing row ${i + 1}:`, error);
            }
        }

        updateImportProgress(100, 'Import completed!');
        
         // Add to import history
        if (!window.importHistory) {
            window.importHistory = [];
        }
        
        const importRecord = {
            timestamp: new Date().toISOString(),
            totalRows: jsonData.length,
            successCount: successCount,
            errorCount: errorCount,
            filename: file.name
        };
        window.importHistory.unshift(importRecord);
        updateImportHistory();
        
        // Refresh statistics and dashboard
        await loadCSIStatistics();
        await loadDashboardStats();
        
        // Clear file input
        fileInput.value = '';
        
        // Show completion message
        let message = `Import completed! Successfully processed ${successCount} records.`;
        if (errorCount > 0) {
            message += ` ${errorCount} errors occurred.`;
            if (errors.length > 0) {
                message += `\n\nFirst few errors:\n${errors.slice(0, 5).join('\n')}`;
            }
        }
        
        setTimeout(() => {
            showImportProgress(false);
            showMessageBox(message, errorCount > 0);
        }, 1000);

    } catch (error) {
        showImportProgress(false);
        console.error('Error importing CSI hierarchy:', error);
        showMessageBox(`Failed to import CSI hierarchy: ${error.message}`, true);
    }
}
async function exportCSIHierarchy() {
    try {
        showLoadingScreen('Exporting CSI hierarchy...', 'Please wait');
        
        const { data, error } = await supabase
            .from('csi_hierarchy')
            .select('*')
            .order('division_code, section_code, detailed_section_code, item_code');

        if (error) throw error;

        if (!data || data.length === 0) {
            hideLoadingScreen();
            showMessageBox('No CSI hierarchy data to export.', true);
            return;
        }

        // Create Excel workbook with correct column names
        const ws = XLSX.utils.json_to_sheet(data.map(row => ({
            'CSI Division Code': row.division_code,
            'CSI Division Description': row.division_description,
            'CSI Section Code': row.section_code,
            'CSI Section Description': row.section_description,
            'CSI Detailed Section Code': row.detailed_section_code,
            'CSI Detailed Section Description': row.detailed_section_description,
            'CSI Item Code': row.item_code,
            'CSI Item Description': row.item_description,
            'Created At': new Date(row.created_at).toLocaleString()
        })));

        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "CSI Hierarchy");

        const fileName = `CSI_Hierarchy_Export_${new Date().toISOString().slice(0, 10)}.xlsx`;
        XLSX.writeFile(wb, fileName);

        hideLoadingScreen();
        showMessageBox('CSI hierarchy exported successfully!');

    } catch (error) {
        hideLoadingScreen();
        console.error('Error exporting CSI hierarchy:', error);
        showMessageBox(`Failed to export CSI hierarchy: ${error.message}`, true);
    }
}

async function clearCSIHierarchy() {
    if (!confirm('Are you sure you want to clear ALL CSI hierarchy data? This action cannot be undone and will affect all projects in the system.')) {
        return;
    }

    if (prompt('Type "DELETE" to confirm:') !== 'DELETE') {
        return;
    }

    try {
        showLoadingScreen('Clearing CSI hierarchy...', 'Please wait');
        
        const { error } = await supabase
            .from('csi_hierarchy')
            .delete()
            .neq('id', 0); // Delete all records

        if (error) throw error;

        await loadCSIStatistics();
        await loadDashboardStats();
        hideLoadingScreen();
        showMessageBox('CSI hierarchy cleared successfully!');

    } catch (error) {
        hideLoadingScreen();
        console.error('Error clearing CSI hierarchy:', error);
        showMessageBox(`Failed to clear CSI hierarchy: ${error.message}`, true);
    }
}

function showImportProgress(show) {
    const progressDiv = document.getElementById('import-progress');
    if (progressDiv) {
        if (show) {
            progressDiv.classList.remove('hidden');
        } else {
            progressDiv.classList.add('hidden');
        }
    }
}

function updateImportProgress(percentage, message) {
    const progressBar = document.getElementById('import-progress-bar');
    const statusText = document.getElementById('import-status');
    
    if (progressBar) {
        progressBar.style.width = `${percentage}%`;
    }
    if (statusText) {
        statusText.textContent = message;
    }
}

function updateImportHistory() {
    const historyDiv = document.getElementById('import-history');
    
    if (!historyDiv) return;
    
    // Initialize if not exists
    if (!window.importHistory) {
        window.importHistory = [];
    }
    
    if (window.importHistory.length === 0) {
        historyDiv.innerHTML = '<div class="text-sm text-gray-500">No import history available</div>';
        return;
    }

    let html = '';
    window.importHistory.slice(0, 10).forEach(record => {
        const date = new Date(record.timestamp).toLocaleString();
        const statusColor = record.errorCount > 0 ? 'text-orange-600' : 'text-green-600';
        
        html += `
            <div class="flex justify-between items-center text-sm">
                <div>
                    <span class="font-medium">${record.filename}</span>
                    <span class="text-gray-500 ml-2">${date}</span>
                </div>
                <div class="${statusColor}">
                    ${record.successCount} success, ${record.errorCount} errors
                </div>
            </div>
        `;
    });
    
    historyDiv.innerHTML = html;
}
async function get_csi_statistics() {
    try {
        const { data, error } = await supabase.rpc('get_csi_statistics');
        
        if (error) throw error;
        
        if (data) {
            document.getElementById('csi-divisions-count').textContent = data.divisions || 0;
            document.getElementById('csi-sections-count').textContent = data.sections || 0;
            document.getElementById('csi-detailed-sections-count').textContent = data.detailed_sections || 0;
            document.getElementById('csi-items-count').textContent = data.items || 0;
        }
    } catch (error) {
        console.error('Error loading CSI statistics:', error);
    }
}

async function loadCSIStatistics() {
    try {
        // Count manually since get_csi_statistics RPC might not exist
        const { data: divisions, error: divError } = await supabase
            .from('csi_hierarchy')
            .select('division_code')
            .neq('division_code', '')
            .not('division_code', 'is', null);
            
        const { data: sections, error: secError } = await supabase
            .from('csi_hierarchy')
            .select('section_code')
            .neq('section_code', '')
            .not('section_code', 'is', null);
            
        const { data: detailedSections, error: detError } = await supabase
            .from('csi_hierarchy')
            .select('detailed_section_code')
            .neq('detailed_section_code', '')
            .not('detailed_section_code', 'is', null);
            
        const { data: items, error: itemError } = await supabase
            .from('csi_hierarchy')
            .select('item_code')
            .neq('item_code', '')
            .not('item_code', 'is', null);
        
        if (!divError && divisions) {
            const uniqueDivisions = new Set(divisions.map(d => d.division_code)).size;
            document.getElementById('csi-divisions-count').textContent = uniqueDivisions;
        }
        
        if (!secError && sections) {
            const uniqueSections = new Set(sections.map(s => s.section_code)).size;
            document.getElementById('csi-sections-count').textContent = uniqueSections;
        }
        
        if (!detError && detailedSections) {
            const uniqueDetailed = new Set(detailedSections.map(d => d.detailed_section_code)).size;
            document.getElementById('csi-detailed-sections-count').textContent = uniqueDetailed;
        }
        
        if (!itemError && items) {
            const uniqueItems = new Set(items.map(i => i.item_code)).size;
            document.getElementById('csi-items-count').textContent = uniqueItems;
        }
        
    } catch (error) {
        console.error('Error loading CSI statistics:', error);
    }
}

// =========================================================
// CSI PATH MANAGEMENT FUNCTIONS
// =========================================================

async function loadCSIManagementDataComplete() {
    try {
        showCSILoadingState();
        
        // Load all projects with user information
        const { data: projects, error: projectsError } = await supabase
            .from('classification_projects')
            .select(`
                *,
                creator:users!classification_projects_created_by_fkey(username, email),
                reviewer:users!classification_projects_assigned_reviewer_id_fkey(username, email)
            `)
            .order('created_at', { ascending: false });

        if (projectsError) throw projectsError;

        csiProjectsData = projects || [];
        
        // Load CSI hierarchy for dropdowns
        await loadCSIHierarchyCache();
        
        // Render the table
        renderCSITable();
        
        hideCSILoadingState();
        
    } catch (error) {
        console.error('Error loading CSI management data:', error);
        hideCSILoadingState();
        showMessageBox(`Failed to load CSI management data: ${error.message}`, true);
    }
}

async function loadCSIHierarchyCache() {
    try {
        // Load divisions
        const { data: divisions } = await supabase.rpc('get_divisions');
        csiHierarchyCache.divisions = divisions || [];
        
        // Load all sections, detailed sections, and items
        for (const division of csiHierarchyCache.divisions) {
            const divCode = division.division_code;
            
            // Load sections for this division
            const { data: sections } = await supabase.rpc('get_sections', { division_code_param: divCode });
            csiHierarchyCache.sections[divCode] = sections || [];
            
            for (const section of (sections || [])) {
                const secCode = section.section_code;
                
                // Load detailed sections
                const { data: detailedSections } = await supabase.rpc('get_detailed_sections', { 
                    division_code_param: divCode,
                    section_code_param: secCode 
                });
                csiHierarchyCache.detailedSections[`${divCode}_${secCode}`] = detailedSections || [];
                
                for (const detailedSection of (detailedSections || [])) {
                    const detCode = detailedSection.detailed_section_code;
                    
                    // Load items
                    const { data: items } = await supabase.rpc('get_items', { 
                        division_code_param: divCode,
                        section_code_param: secCode,
                        detailed_section_code_param: detCode
                    });
                    csiHierarchyCache.items[`${divCode}_${secCode}_${detCode}`] = items || [];
                }
            }
        }
        
        // Load additional levels
        const { data: additionalLevels } = await supabase
            .from('additional_levels')
            .select('*')
            .order('level_name');
        
        // Group by CSI path
        for (const level of (additionalLevels || [])) {
            const key = `${level.division_code}_${level.section_code}_${level.detailed_section_code}_${level.item_code}`;
            if (!csiHierarchyCache.additionalLevels[key]) {
                csiHierarchyCache.additionalLevels[key] = [];
            }
            csiHierarchyCache.additionalLevels[key].push(level);
        }
        
    } catch (error) {
        console.error('Error loading CSI hierarchy cache:', error);
    }
}

function renderCSITable() {
    const tableBody = document.getElementById('csi-table-body');
    const tableContainer = document.getElementById('csi-table-container');
    const noProjectsDiv = document.getElementById('csi-no-projects');
    
    if (csiProjectsData.length === 0) {
        tableContainer.style.display = 'none';
        noProjectsDiv.style.display = 'block';
        return;
    }
    
    tableContainer.style.display = 'block';
    noProjectsDiv.style.display = 'none';
    
    let html = '';
    csiProjectsData.forEach((project, index) => {
        const isChanged = csiPendingChanges.has(project.id);
        const rowClass = isChanged ? 'bg-yellow-50' : '';
        
        html += `
            <tr class="${rowClass}">
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                    ${project.project_name}
                    ${isChanged ? '<span class="ml-2 text-xs bg-yellow-100 text-yellow-800 px-2 py-1 rounded">Modified</span>' : ''}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                    ${createCSIDropdown('division', project.id, project.division_code)}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                    ${createCSIDropdown('section', project.id, project.section_code)}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                    ${createCSIDropdown('detailed_section', project.id, project.detailed_section_code)}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                    ${createCSIDropdown('item', project.id, project.item_code)}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                    <input type="text" value="${project.additional_level_name || ''}" 
                           class="w-full px-2 py-1 border border-gray-300 rounded text-sm"
                           onchange="updateCSIField('additional_level_name', ${project.id}, this.value)">
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                    <input type="text" value="${project.additional_level_value || ''}" 
                           class="w-full px-2 py-1 border border-gray-300 rounded text-sm"
                           onchange="updateCSIField('additional_level_value', ${project.id}, this.value)">
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${getStatusColor(project.status)}">
                        ${formatStatus(project.status)}
                    </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                    ${project.creator ? project.creator.username : 'Unknown'}
                </td>
            </tr>
        `;
    });
    
    tableBody.innerHTML = html;
}

function createCSIDropdown(type, projectId, currentValue) {
    const project = csiProjectsData.find(p => p.id === projectId);
    const changeData = csiPendingChanges.get(projectId) || {};
    const effectiveValue = changeData[`${type}_code`] || currentValue;
    
    let options = [];
    let selectId = `${type}-${projectId}`;
    
    switch (type) {
        case 'division':
            options = csiHierarchyCache.divisions.map(d => ({
                value: d.division_code,
                label: `${d.division_code} - ${d.division_description}`
            }));
            break;
            
        case 'section':
            const divCode = changeData.division_code || project.division_code;
            options = (csiHierarchyCache.sections[divCode] || []).map(s => ({
                value: s.section_code,
                label: `${s.section_code} - ${s.section_description}`
            }));
            break;
            
        case 'detailed_section':
            const div = changeData.division_code || project.division_code;
            const sec = changeData.section_code || project.section_code;
            options = (csiHierarchyCache.detailedSections[`${div}_${sec}`] || []).map(d => ({
                value: d.detailed_section_code,
                label: `${d.detailed_section_code} - ${d.detailed_section_description}`
            }));
            break;
            
        case 'item':
            const divC = changeData.division_code || project.division_code;
            const secC = changeData.section_code || project.section_code;
            const detC = changeData.detailed_section_code || project.detailed_section_code;
            options = (csiHierarchyCache.items[`${divC}_${secC}_${detC}`] || []).map(i => ({
                value: i.item_code,
                label: `${i.item_code} - ${i.item_description}`
            }));
            break;
    }
    
    let html = `<select class="w-full px-2 py-1 border border-gray-300 rounded text-sm" 
                        onchange="updateCSIDropdown('${type}', ${projectId}, this.value)">
                    <option value="">Select ${type.replace('_', ' ')}</option>`;
    
    options.forEach(option => {
        const selected = option.value === effectiveValue ? 'selected' : '';
        html += `<option value="${option.value}" ${selected}>${option.label}</option>`;
    });
    
    html += '</select>';
    return html;
}

function updateCSIDropdown(type, projectId, value) {
    // Get or create change record
    let changes = csiPendingChanges.get(projectId) || {};
    
    // Update the field
    changes[`${type}_code`] = value;
    
    // If this is a higher level change, clear lower levels
    if (type === 'division') {
        delete changes.section_code;
        delete changes.detailed_section_code;
        delete changes.item_code;
    } else if (type === 'section') {
        delete changes.detailed_section_code;
        delete changes.item_code;
    } else if (type === 'detailed_section') {
        delete changes.item_code;
    }
    
    // Store changes
    csiPendingChanges.set(projectId, changes);
    
    // Re-render the table to show updated dropdowns and highlight changes
    renderCSITable();
    updateChangesSummary();
    updateButtonStates();
}

function updateCSIField(fieldName, projectId, value) {
    let changes = csiPendingChanges.get(projectId) || {};
    changes[fieldName] = value;
    csiPendingChanges.set(projectId, changes);
    
    updateChangesSummary();
    updateButtonStates();
}

function updateChangesSummary() {
    const summaryDiv = document.getElementById('csi-changes-summary');
    const changesList = document.getElementById('csi-changes-list');
    
    if (csiPendingChanges.size === 0) {
        summaryDiv.style.display = 'none';
        return;
    }
    
    summaryDiv.style.display = 'block';
    let html = '';
    
    csiPendingChanges.forEach((changes, projectId) => {
        const project = csiProjectsData.find(p => p.id === projectId);
        if (!project) return;
        
        const changeList = Object.keys(changes).map(key => {
            const oldValue = project[key] || '';
            const newValue = changes[key];
            return `${key.replace(/_/g, ' ')}: "${oldValue}" √É∆í√Ü‚Äô√É‚Äö√Ç¬¢√É∆í√Ç¬¢√É¬¢√¢‚Ç¨≈°√Ç¬¨√É‚Äö√Ç¬†√É∆í√Ç¬¢√É¬¢√¢‚Ç¨≈°√Ç¬¨√É¬¢√¢‚Ç¨≈æ√Ç¬¢ "${newValue}"`;
        }).join(', ');
        
        html += `<div class="mb-1"><strong>${project.project_name}:</strong> ${changeList}</div>`;
    });
    
    changesList.innerHTML = html;
}

function updateButtonStates() {
    const saveBtn = document.getElementById('csi-save-changes-btn');
    const discardBtn = document.getElementById('csi-discard-changes-btn');
    
    const hasChanges = csiPendingChanges.size > 0;
    
    saveBtn.disabled = !hasChanges;
    discardBtn.disabled = !hasChanges;
}

async function saveAllCSIChanges() {
    if (csiPendingChanges.size === 0) {
        showMessageBox('No changes to save.', true);
        return;
    }
    
    if (!confirm(`Are you sure you want to save ${csiPendingChanges.size} project(s) with CSI path changes? This action cannot be undone.`)) {
        return;
    }
    
    try {
        showLoadingScreen('Saving CSI path changes...', 'Please wait');
        
        let successCount = 0;
        let errorCount = 0;
        const errors = [];
        
        for (const [projectId, changes] of csiPendingChanges.entries()) {
            try {
                const project = csiProjectsData.find(p => p.id === projectId);
                if (!project) continue;
                
                // CRITICAL FIX: Load existing attributes first to prevent deletion
                const { data: existingAttributes, error: attrError } = await supabase
                    .from('project_attributes')
                    .select('*')
                    .eq('project_id', projectId);
                
                if (attrError) {
                    console.error(`Failed to load attributes for project ${projectId}:`, attrError);
                    // Continue with empty array if attributes can't be loaded
                }
                
                // Format attributes for RPC function to match expected structure
                const formattedAttributes = (existingAttributes || []).map(attr => ({
                    name: attr.attribute_name,
                    standardValues: attr.standard_values,
                    isMandatory: attr.is_mandatory,
                    unit_of_measurement: attr.unit_of_measurement
                }));
                
                console.log(`Preserving ${formattedAttributes.length} attributes for project ${projectId}`);
                
                // Merge changes with existing project data
                const updateData = {
                    project_id_param: projectId,
                    admin_id_param: currentUser.id,
                    project_name_param: project.project_name,
                    division_code_param: changes.division_code || project.division_code,
                    section_code_param: changes.section_code || project.section_code,
                    detailed_section_code_param: changes.detailed_section_code || project.detailed_section_code,
                    item_code_param: changes.item_code || project.item_code,
                    additional_level_name_param: changes.additional_level_name !== undefined ? changes.additional_level_name : project.additional_level_name,
                    additional_level_value_param: changes.additional_level_value !== undefined ? changes.additional_level_value : project.additional_level_value,
                    attributes_param: formattedAttributes, // FIXED: Preserve existing attributes
                    division_description_param: changes.division_description || project.division_description || '',
                    section_description_param: changes.section_description || project.section_description || '',
                    detailed_section_description_param: changes.detailed_section_description || project.detailed_section_description || '',
                    item_description_param: changes.item_description || project.item_description || ''
                };
                
                const { data, error } = await supabase.rpc('admin_update_project', updateData);
                
                if (error) throw error;
                
                if (!data.success) {
                    throw new Error(data.message || 'Update failed');
                }
                
                successCount++;
                
                // Update local data
                Object.assign(project, {
                    division_code: updateData.division_code_param,
                    section_code: updateData.section_code_param,
                    detailed_section_code: updateData.detailed_section_code_param,
                    item_code: updateData.item_code_param,
                    additional_level_name: updateData.additional_level_name_param,
                    additional_level_value: updateData.additional_level_value_param
                });
                
            } catch (error) {
                console.error(`Error updating project ${projectId}:`, error);
                errorCount++;
                errors.push(`Project ${projectId}: ${error.message}`);
            }
        }
        
        // Clear pending changes
        csiPendingChanges.clear();
        
        // Re-render table
        renderCSITable();
        updateChangesSummary();
        updateButtonStates();
        
        hideLoadingScreen();
        
        if (errorCount > 0) {
            showMessageBox(`Completed with ${successCount} successes and ${errorCount} errors.\n\nErrors:\n${errors.join('\n')}`, true);
        } else {
            showMessageBox(`Successfully updated ${successCount} project(s) while preserving all attributes.`);
        }
        
    } catch (error) {
        console.error('Error saving CSI changes:', error);
        hideLoadingScreen();
        showMessageBox(`Failed to save changes: ${error.message}`, true);
    }
}

function discardAllCSIChanges() {
    if (csiPendingChanges.size === 0) {
        showMessageBox('No changes to discard.', true);
        return;
    }
    
    if (!confirm(`Are you sure you want to discard all ${csiPendingChanges.size} pending change(s)?`)) {
        return;
    }
    
    csiPendingChanges.clear();
    renderCSITable();
    updateChangesSummary();
    updateButtonStates();
    
    showMessageBox('All changes discarded.');
}

function showCSILoadingState() {
    document.getElementById('csi-table-loading').style.display = 'block';
    document.getElementById('csi-table-container').style.display = 'none';
    document.getElementById('csi-no-projects').style.display = 'none';
}

function hideCSILoadingState() {
    document.getElementById('csi-table-loading').style.display = 'none';
}

function getStatusColor(status) {
    const colors = {
        'draft': 'bg-gray-100 text-gray-800',
        'submitted': 'bg-yellow-100 text-yellow-800',
        'reviewer_approved': 'bg-blue-100 text-blue-800',
        'reviewer_rejected': 'bg-red-100 text-red-800',
        'admin_approved': 'bg-green-100 text-green-800',
        'admin_rejected': 'bg-red-100 text-red-800'
    };
    return colors[status] || 'bg-gray-100 text-gray-800';
}

function formatStatus(status) {
    const statusMap = {
        'draft': 'Draft',
        'submitted': 'Pending Review',
        'reviewer_approved': 'Pending Admin',
        'reviewer_rejected': 'Rejected',
        'admin_approved': 'Approved',
        'admin_rejected': 'Admin Rejected'
    };
    return statusMap[status] || status;
}

// Make functions globally available
window.updateCSIDropdown = updateCSIDropdown;
window.updateCSIField = updateCSIField;
window.loadCSIManagementData = loadCSIManagementDataComplete;
window.saveAllCSIChanges = saveAllCSIChanges;
window.discardAllCSIChanges = discardAllCSIChanges;

// =========================================================
// END CSI PATH MANAGEMENT FUNCTIONS
// =========================================================
// Make functions globally available for onclick handlers
        window.removeAttribute = removeAttribute;
        window.editAttribute = editAttribute;
        window.loadDraftProject = loadDraftProject;
        window.modifyRejectedProject = modifyRejectedProject;
        window.removeStandardValue = removeStandardValue;
        window.removeEditStandardValue = removeEditStandardValue;
        window.debugSystem = debugSystem;
        window.changeUserRole = changeUserRole;
        window.toggleUserStatus = toggleUserStatus;
        window.openViewProjectModal = openViewProjectModal;
        window.openEditProjectModal = openEditProjectModal;
        window.submitEditedProjectForReview = submitEditedProjectForReview;
        window.deleteProject = deleteProject;
        window.editProjectAttribute = editProjectAttribute;
        window.saveEditedProject = saveEditedProject;
        window.closeModal = closeModal;
        window.addNewAttributeToEditModal = addNewAttributeToEditModal;
window.removeProjectAttribute = removeProjectAttribute;
        // Add the missing parseStandardValues function
function parseStandardValues(standardValuesStr) {
    if (!standardValuesStr) return [];
    
    // Handle manual entry indicators
    if (standardValuesStr.includes('Manual Entry')) {
        return []; // Return empty array for manual entry fields
    }
    
    const values = [];
    const parts = standardValuesStr.split(',').map(p => p.trim());
    parts.forEach(part => {
        if (!part) return;
        
        const match = part.match(/^(.+?)\s*\(([^)]+)\)$/);
        if (match) {
            values.push({ name: match[1].trim(), unit: match[2].trim() });
        } else {
            values.push({ name: part, unit: '' });
        }
    });
    return values;
}
        // Add submit function for edit modal
async function submitEditedProjectForReview() {
    try {
        const reviewerSection = document.getElementById('edit-modal-reviewer-selection');
        const reviewerSelect = document.getElementById('edit-modal-reviewer-select');
        
        if (reviewerSection.style.display === 'none' || !reviewerSelect.value) {
            // Show reviewer selection
            reviewerSection.style.display = 'block';
            await loadEditModalReviewers();
            setupEditModalSubmissionListeners(); // Setup event listeners
        } else {
            // This shouldn't be called directly anymore, but keeping for safety
            await handleEditModalConfirmSubmit();
        }
    } catch (error) {
        console.error('Error in submit workflow:', error);
        showMessageBox(`Error: ${error.message}`, true);
    }
}
window.submitEditedProjectForReview = submitEditedProjectForReview;
// Add event listeners for modal reviewer selection
document.addEventListener('DOMContentLoaded', () => {
    // ... existing code ...
    
    // Add event listeners for edit modal reviewer selection
    const editModalConfirmSubmitBtn = document.getElementById('edit-modal-confirm-submit-btn');
    const editModalCancelSubmitBtn = document.getElementById('edit-modal-cancel-submit-btn');
    
    if (editModalConfirmSubmitBtn) {
        editModalConfirmSubmitBtn.addEventListener('click', handleEditModalConfirmSubmit);
    }
    
    if (editModalCancelSubmitBtn) {
        editModalCancelSubmitBtn.addEventListener('click', handleEditModalCancelSubmit);
    }
});



        // Make functions globally available
        window.removeAttribute = removeAttribute;
        window.editAttribute = editAttribute;
        window.loadDraftProject = loadDraftProject;
        window.modifyRejectedProject = modifyRejectedProject;  // Add this line
        window.removeStandardValue = removeStandardValue;
        window.removeEditStandardValue = removeEditStandardValue;
        window.debugSystem = debugSystem;
   // Make functions globally available
window.removeAttribute = removeAttribute;
window.editAttribute = editAttribute;
window.loadDraftProject = loadDraftProject;
window.modifyRejectedProject = modifyRejectedProject;
window.removeStandardValue = removeStandardValue;
window.removeEditStandardValue = removeEditStandardValue;
window.debugSystem = debugSystem;
window.changeUserRole = changeUserRole;
window.toggleUserStatus = toggleUserStatus;
window.openViewProjectModal = openViewProjectModal;
   
   
   </script>
   
<!-- Edit Project Modal -->
<div id="edit-project-modal" class="modal-overlay fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50" style="display: none;">
    <div class="relative min-h-screen flex items-center justify-center p-4">
        <div class="relative p-5 border w-full max-w-4xl shadow-lg rounded-md bg-white max-h-[90vh] overflow-y-auto">
            <div class="mt-3">
                <div class="flex justify-between items-center mb-4 sticky top-0 bg-white pb-2 border-b">
                    <h3 class="text-lg font-medium text-gray-900">Edit Project</h3>
                    <button onclick="closeModal('edit-project-modal')" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                
                <div class="space-y-6">
                    <!-- Project Name -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Project Name</label>
                        <input type="text" id="edit-project-name" readonly class="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-50">
                    </div>

                    
                    <!-- CSI Path Section -->
<div id="edit-csi-path-section" class="p-4 bg-gray-50 rounded-lg">
    <h4 class="font-medium text-gray-900 mb-3">CSI Path (Read-Only)</h4>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
            <label class="block text-sm font-medium text-gray-700">Division</label>
            <input type="text" id="edit-modal-division-display" readonly class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-100 text-gray-600">
        </div>
        <div>
            <label class="block text-sm font-medium text-gray-700">Section</label>
            <input type="text" id="edit-modal-section-display" readonly class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-100 text-gray-600">
        </div>
        <div>
            <label class="block text-sm font-medium text-gray-700">Detailed Section</label>
            <input type="text" id="edit-modal-subsection-display" readonly class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-100 text-gray-600">
        </div>
        <div>
            <label class="block text-sm font-medium text-gray-700">Item</label>
            <input type="text" id="edit-modal-item-display" readonly class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-100 text-gray-600">
        </div>
        <div>
            <label class="block text-sm font-medium text-gray-700">Additional Level Name</label>
            <input type="text" id="edit-modal-level-name-display" readonly class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-100 text-gray-600">
        </div>
        <div>
            <label class="block text-sm font-medium text-gray-700">Additional Level Value</label>
            <input type="text" id="edit-modal-level-value-display" readonly class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-100 text-gray-600">
        </div>
    </div>
    <div class="mt-3 p-3 bg-blue-50 border border-blue-200 rounded-md">
        <div class="flex items-center">
            <svg class="w-5 h-5 text-blue-600 mr-2" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
            </svg>
            <span class="text-sm text-blue-800">CSI path cannot be modified after project creation to maintain data integrity.</span>
        </div>
    </div>
</div>

                    <!-- Attributes Section -->
                    <div>
                        <h4 class="font-medium text-gray-900 mb-3">Attributes</h4>
                        <div>
    <div class="flex justify-between items-center mb-3">
        <h4 class="font-medium text-gray-900">Attributes</h4>
        <button onclick="addNewAttributeToEditModal()" class="px-3 py-1 bg-green-600 text-white rounded-md hover:bg-green-700 text-sm">
            Add New Attribute
        </button>
    </div>
    <div id="edit-project-attributes" class="space-y-2 max-h-80 overflow-y-auto border border-gray-200 rounded-md p-3">
        <!-- Attributes will be loaded here -->
    </div>
</div>
                    </div>

                    <!-- Reviewer Selection Section (initially hidden) -->
<div id="edit-modal-reviewer-selection" class="p-4 bg-yellow-50 rounded-lg border border-yellow-200" style="display: none;">
    <h4 class="text-md font-medium text-gray-900 mb-3">Select Reviewer for Submission</h4>
    <select id="edit-modal-reviewer-select" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 mb-4">
        <option value="">Select a reviewer</option>
    </select>
    <div class="flex space-x-4">
        <button id="edit-modal-confirm-submit-btn" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">
            Confirm Submission
        </button>
        <button id="edit-modal-cancel-submit-btn" class="px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700">
            Cancel Submission
        </button>
    </div>
</div>

<!-- Action Buttons -->
<div class="flex justify-end space-x-3 pt-4 border-t sticky bottom-0 bg-white">
    <button onclick="closeModal('edit-project-modal')" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400">
        Cancel
    </button>
    <button onclick="saveEditedProject()" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
        Save Changes
    </button>
    <button id="edit-modal-submit-btn" onclick="submitEditedProjectForReview()" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700" style="display: none;">
        Submit for Review
    </button>
</div>
                </div>
            </div>
        </div>
    </div>
</div>


<!-- View Project Modal -->
<div id="view-project-modal" class="modal-overlay fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50" style="display: none;">
    <div class="relative min-h-screen flex items-center justify-center p-4">
        <div class="relative p-5 border w-full max-w-4xl shadow-lg rounded-md bg-white max-h-[90vh] overflow-y-auto">
            <div class="mt-3">
                <div class="flex justify-between items-center mb-4 sticky top-0 bg-white pb-2 border-b">
                    <h3 class="text-lg font-medium text-gray-900">View Project Details</h3>
                    <button onclick="closeModal('view-project-modal')" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                
                <div class="space-y-6">
                    <!-- Project Info -->
                    <div class="p-4 bg-blue-50 rounded-lg">
                        <h4 class="font-medium text-gray-900 mb-3">Project Information</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                            <div><strong>Project Name:</strong> <span id="view-project-name"></span></div>
                            <div><strong>Status:</strong> <span id="view-project-status"></span></div>
                            <div><strong>Created:</strong> <span id="view-project-created"></span></div>
                            <div><strong>Last Updated:</strong> <span id="view-project-updated"></span></div>
                            <div><strong>Creator:</strong> <span id="view-project-creator"></span></div>
                            <div><strong>Assigned Reviewer:</strong> <span id="view-project-reviewer"></span></div>
                        </div>
                    </div>

                    <!-- CSI Path -->
                    <div class="p-4 bg-gray-50 rounded-lg">
                        <h4 class="font-medium text-gray-900 mb-3">CSI Hierarchy Path</h4>
                        <div id="view-csi-path" class="text-sm text-gray-700"></div>
                        <div id="view-additional-level" class="text-sm text-gray-700 mt-2"></div>
                    </div>

                    <!-- Project History -->
                    <div class="p-4 bg-yellow-50 rounded-lg">
                        <h4 class="font-medium text-gray-900 mb-3">Project History</h4>
                        <div id="view-project-history" class="space-y-2 text-sm"></div>
                    </div>

                    <!-- Attributes -->
                    <div>
                        <h4 class="font-medium text-gray-900 mb-3">Attributes & Standard Values</h4>
                        <div id="view-project-attributes" class="space-y-3 max-h-80 overflow-y-auto border border-gray-200 rounded-md p-3">
                            <!-- Attributes will be loaded here -->
                        </div>
                    </div>

                    <!-- Comments Section -->
                    <div id="view-comments-section" class="p-4 bg-red-50 rounded-lg" style="display: none;">
                        <h4 class="font-medium text-gray-900 mb-3">Review Comments</h4>
                        <div id="view-project-comments" class="space-y-2 text-sm"></div>
                    </div>

                    <!-- Close Button -->
                    <div class="flex justify-end pt-4 border-t sticky bottom-0 bg-white">
                       <button onclick="closeModal('view-project-modal')" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                            Close
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

</body>

</html>
